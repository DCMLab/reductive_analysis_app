<html>
    <head>
        <title>Verovio Hello World! example</title>
        <!--/////////////////////-->
        <!-- The Verovio toolkit -->
        <!--/////////////////////-->
        <script src="js/verovio-toolkit.js" type="text/javascript" ></script>
        <!--////////////////////-->
        <!-- We also use jQuery -->
        <!--////////////////////-->
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript" ></script>
        <!--/////////////////////-->
        <!-- And D3JS            -->
        <!--/////////////////////-->
        <script src="js/d3js.min.js" type="text/javascript" ></script>
	<script type="text/javascript">
	</script>
    </head>
    <body>
        <!--//////////////////////////////////////////////-->
        <!-- The div where we are going to insert the SVG -->
        <!--//////////////////////////////////////////////-->

        <script type="text/javascript">

            var selected = [];
            var extraselected = [];
            var vrvToolkit = new verovio.toolkit();
	    var svg;
	    var musicxml;
	    var data;
	    var reader = new FileReader();

            function toggleSelected(item,ev) { 
	      if(selected.find(x => x === item) || extraselected.find(x => x === item)) {
		item.setAttribute("style","fill:black");
		selected = selected.filter(x =>  x !== item);
		extraselected = extraselected.filter(x =>  x !== item);
	      } else {
		if(ev.shiftKey) {
		  item.setAttribute("style","fill:red");
		  extraselected.push(item);
		}else {
		  item.setAttribute("style","fill:green");
		  selected.push(item);
		}
	      }
	    }


            function handleKeypress(ev) {
	      if (ev.key == "Enter"){
		if (selected.length == 0 && extraselected == 0)
		  return;
		/* Draw stuff to indicate status of selected and
		 * extraselected stuff*/
		/* Add as hyperedge to underlying MusicXML */
	      }
	    }

	    // Function to download data to a file
            // Taken from StackOverflow answer by Kanchu at
            // https://stackoverflow.com/questions/13405129/javascript-create-and-save-file
	    function download(data, filename, type) {
		var file = new Blob([data], {type: type});
		if (window.navigator.msSaveOrOpenBlob) // IE10+
		    window.navigator.msSaveOrOpenBlob(file, filename);
		else { // Others
		    var a = document.createElement("a"),
			    url = URL.createObjectURL(file);
		    a.href = url;
		    a.download = filename;
		    document.body.appendChild(a);
		    a.click();
		    setTimeout(function() {
			document.body.removeChild(a);
			window.URL.revokeObjectURL(url);  
		    }, 0); 
		}
	    }

	    function save() {
	      var saved = new XMLSerializer().serializeToString(musicxml.documentElement);
	      download(saved, "download.mei", "text/xml");
	    }


            function load() {
	      upload = document.getElementById("fileupload");
	      if(upload.files.length == 1){
		reader.addEventListener("load",load_finish);
		reader.readAsText(upload.files[0]);
	      }else{
		return;
	      }
	    }
            function load_finish(e) {
	      console.log("woo");
	      data = reader.result;
	      parser = new DOMParser();
	      musicxml = parser.parseFromString(data,"text/xml");
	      svg = vrvToolkit.renderData(data, {});
	      $("#svg_output").html(svg);
	      for (let n of document.getElementsByClassName("note")) {
		  n.addEventListener('click', function(ev) {toggleSelected(n,ev) } )
	      }
	      document.addEventListener('keypress',function(ev) {handleKeypress(ev);});
	    }



            ///////////////////////////
            /* Create the vrvToolkit */
            ///////////////////////////

            ////////////////////////////////////
            /* Load the file using a HTTP GET */
            ////////////////////////////////////
/*            $.ajax({
                url: "mei/Bach_Herzliebster_Jesu.mei"
                , dataType: "text"
                , success: function(data) {
		    parser = new DOMParser();
		    musicxml = parser.parseFromString(data,"text/xml");
                    svg = vrvToolkit.renderData(data, {});
                    $("#svg_output").html(svg);
		    for (let n of document.getElementsByClassName("note")) {
			n.addEventListener('click', function(ev) {toggleSelected(n,ev) } )
		    }
		    document.addEventListener('keypress',function(ev) {handleKeypress(ev);});
                }
            });*/
            




        </script>
	<div id="load_save">
	  <input type="file" id="fileupload" value="Load" onchange="load()" >
	  <!--input type="button" id="uploadbutton" value="Load" onclick="load()" -->
	  <input type="button" id="uploadbutton" value="Save" onclick="save()" >
	</div>
	
	<div id="svg_output"></div>



    </body>
</html>
