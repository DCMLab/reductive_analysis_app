<html>
    <head>
        <title>Verovio Hello World! example</title>
        <!--/////////////////////-->
        <!-- The Verovio toolkit -->
        <!--/////////////////////-->
        <script src="js/verovio-toolkit.js" type="text/javascript" ></script>
        <!--////////////////////-->
        <!-- We also use jQuery -->
        <!--////////////////////-->
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript" ></script>
        <!--/////////////////////-->
        <!-- And D3JS            -->
        <!--/////////////////////-->
        <script src="js/d3js.min.js" type="text/javascript" ></script>
	<script type="text/javascript">
	</script>
    </head>
    <body>
        <!--//////////////////////////////////////////////-->
        <!-- The div where we are going to insert the SVG -->
        <!--//////////////////////////////////////////////-->

        <script type="text/javascript">

            var selected = [];
            var extraselected = [];
            var vrvToolkit = new verovio.toolkit();
	    var svg;
	    var mei;
	    var mei_graph;
	    var data;
	    var reader = new FileReader();
	    var changes = false;

            function toggleSelected(item,ev) { 
	      if(selected.find(x => x === item) || extraselected.find(x => x === item)) {
		item.setAttribute("style","fill:black");
		selected = selected.filter(x =>  x !== item);
		extraselected = extraselected.filter(x =>  x !== item);
	      } else {
		if(ev.shiftKey) {
		  item.setAttribute("style","fill:red");
		  extraselected.push(item);
		}else {
		  item.setAttribute("style","fill:green");
		  selected.push(item);
		}
	      }
	    }

            function line(p1,p2) {
	      var sibling = document.getElementsByClassName("system")[0];
	      var parent = sibling.parentNode;
	      var newElement = document.createElementNS("http://www.w3.org/2000/svg", 'line');
	      newElement.setAttribute("x1",p1[0]);
	      newElement.setAttribute("y1",p1[1]);
	      newElement.setAttribute("x2",p2[0]);
	      newElement.setAttribute("y2",p2[1]);
	      newElement.style.stroke = "#000";
	      newElement.style.strokeWidth = "15px"; 
	      parent.appendChild(newElement);
	    }

            function draw_edge() {
	      for(var i = 1; i < selected.length; i++) {
		note1 = note_coords(selected[i-1]);
		note2 = note_coords(selected[i]);
		line(note1,note2);
	      }
	    }
            
            function add_edge() {
	      for(var i = 0; i < selected.length; i++) {
		var elem = mei.createElement("node");
		// This node represent that note
		var label = mei.createElement("label");
		var note = mei.createElement("note");
		note.setAttribute("sameas","#"+selected[i].getAttribute("id"));
		elem.appendChild(label);
		label.appendChild(note);
		// But should have a separate XML ID
		elem.setAttribute("id","gn-" + selected[i].getAttribute("id"));
		mei_graph.appendChild(elem);
	      }
	      for(var i = 1; i < selected.length; i++) {
		// So that we can refer to the node (not the note) ID in
		// arcs/edges
		var elem = mei.createElement("arc");
		elem.setAttribute("from","#gn-"+selected[i-1].getAttribute("id"));
		elem.setAttribute("to","#gn-"+selected[i].getAttribute("id"));
		mei_graph.appendChild(elem);
	      }
	    }


            function handleKeypress(ev) {
	      if (selected.length == 0 && extraselected == 0) {
		return;
	      }else if (ev.key == "Enter"){
		changes = true;
		draw_edge(); // Draw the edge
		add_edge();  // Add it to the MEI
		selected.forEach(toggleSelected); // De-select
	      }
	    }

	    // Function to download data to a file
            // Taken from StackOverflow answer by Kanchu at
            // https://stackoverflow.com/questions/13405129/javascript-create-and-save-file
	    function download(data, filename, type) {
		var file = new Blob([data], {type: type});
		if (window.navigator.msSaveOrOpenBlob) // IE10+
		    window.navigator.msSaveOrOpenBlob(file, filename);
		else { // Others
		    var a = document.createElement("a"),
			    url = URL.createObjectURL(file);
		    a.href = url;
		    a.download = filename;
		    document.body.appendChild(a);
		    a.click();
		    setTimeout(function() {
			document.body.removeChild(a);
			window.URL.revokeObjectURL(url);  
		    }, 0); 
		}
	    }

            function note_coords(note) {
	      return [note.getElementsByTagName("use")[0].x.animVal.value,
		      note.getElementsByTagName("use")[0].y.animVal.value]

	    }
             
            function add_or_fetch_graph() {
	      var existing = mei.getElementsByTagName("graph");
	      if(existing.length) {
		// TODO: Not just grab the first one.
		return existing[0];
	      }
	      var elem = mei.createElement("graph");
	      elem.setAttribute("type","directed");
	      mei.getElementsByTagName("body")[0].appendChild(elem);
	      return elem;
	    }



	    function save() {
	      var saved = new XMLSerializer().serializeToString(mei);
	      download(saved, "download.mei", "text/xml");
	    }

	    function savesvg() {
	      var saved = new XMLSerializer().serializeToString($("#svg_output")[0]);
	      download(saved, "download.mei", "text/xml");
	    }

            function load() {
	      /* Cancel loading if changes are not saved? alert */
	      selected = [];
	      extraselected = [];
	      upload = document.getElementById("fileupload");
	      if(upload.files.length == 1){
		reader.addEventListener("load",load_finish);
		reader.readAsText(upload.files[0]);
	      }else{
		return;
	      }
	    }
            function load_finish(e) {
	      console.log("woo");
	      data = reader.result;
	      parser = new DOMParser();
	      mei = parser.parseFromString(data,"text/xml");
	      mei_graph = add_or_fetch_graph();
	      svg = vrvToolkit.renderData(data, {pageWidth: 20000,
		  pageHeight: 10000, breaks: "none"});
	      $("#svg_output").html(svg);
	      for (let n of document.getElementsByClassName("note")) {
		  n.addEventListener('click', function(ev) {toggleSelected(n,ev) } )
	      }
	      document.addEventListener('keypress',function(ev) {handleKeypress(ev);});
	    }



            ///////////////////////////
            /* Create the vrvToolkit */
            ///////////////////////////

            ////////////////////////////////////
            /* Load the file using a HTTP GET */
            ////////////////////////////////////
/*            $.ajax({
                url: "mei/Bach_Herzliebster_Jesu.mei"
                , dataType: "text"
                , success: function(data) {
		    parser = new DOMParser();
		    mei = parser.parseFromString(data,"text/xml");
                    svg = vrvToolkit.renderData(data, {});
                    $("#svg_output").html(svg);
		    for (let n of document.getElementsByClassName("note")) {
			n.addEventListener('click', function(ev) {toggleSelected(n,ev) } )
		    }
		    document.addEventListener('keypress',function(ev) {handleKeypress(ev);});
                }
            });*/
            




        </script>
	<div id="load_save">
	  <input type="file" id="fileupload" value="Load" onchange="load()" >
	  <!--input type="button" id="uploadbutton" value="Load" onclick="load()" -->
	  <input type="button" id="uploadbutton" value="Save" onclick="save()" >
	  <input type="button" id="uploadbutton" value="Save SVG" onclick="savesvg()" >
	</div>
	
	<div id="svg_output"></div>



    </body>
</html>
