<html>
    <head>
        <title>Verovio Hello World! example</title>
        <!--/////////////////////-->
        <!-- The Verovio toolkit -->
        <!--/////////////////////-->
        <script src="js/verovio-toolkit.js" type="text/javascript" ></script>
        <!--////////////////////-->
        <!-- We also use jQuery -->
        <!--////////////////////-->
        <script src="https://code.jquery.com/jquery-3.1.1.min.js" type="text/javascript" ></script>
        <!--/////////////////////-->
        <!-- And D3JS            -->
        <!--/////////////////////-->
        <script src="js/d3js.min.js" type="text/javascript" ></script>
	<script type="text/javascript">
	</script>
    </head>
    <body>

        <script type="text/javascript">
	    // Clicking selects
            var selected = [];
	    // Shift-clicking extra selects
            var extraselected = [];
	    // Load Verovio
            var vrvToolkit = new verovio.toolkit();
	    // This is our SVG
	    var svg;
	    // And the underlying MEI
	    var mei;
	    // And the graph node in the MEI
	    var mei_graph;
	    // This is the MEI as text (pre-parse)
	    var data;
	    // We need a reader
	    var reader = new FileReader();
	    // Did we change the MEI somehow?
	    var changes = false;
	    // Our undo stack. TODO: is this being empty the same as
	    // changes being false?
	    var undo_actions = [];

	    var redo_actions = []; //TODO, maybe?

	    // Toggle if a thing (for now: note) is selected or not.
            function toggleSelected(item,extra) { 
	      if(selected.find(x => x === item) || extraselected.find(x => x === item)) {
		item.setAttribute("style","fill:black");
		selected = selected.filter(x =>  x !== item);
		extraselected = extraselected.filter(x =>  x !== item);
	      } else {
		if(extra) {
		  item.setAttribute("style","fill:red");
		  extraselected.push(item);
		}else {
		  item.setAttribute("style","fill:green");
		  selected.push(item);
		}
	      }
	    }


            // Draw a line between points p1 and p2
            function line(p1,p2) {
	      var sibling = document.getElementsByClassName("system")[0];
	      var parent = sibling.parentNode;
	      var newElement = document.createElementNS("http://www.w3.org/2000/svg", 'line');
	      newElement.setAttribute("x1",p1[0]);
	      newElement.setAttribute("y1",p1[1]);
	      newElement.setAttribute("x2",p2[0]);
	      newElement.setAttribute("y2",p2[1]);
	      newElement.style.stroke = "#000";
	      newElement.style.strokeWidth = "15px"; 
	      parent.appendChild(newElement);
	      return newElement;
	    }

            function note_coords(note) {
	      return [note.getElementsByTagName("use")[0].x.animVal.value,
		      note.getElementsByTagName("use")[0].y.animVal.value]
	    }

            // Draw an edge (TODO: make it much much much better)
            function draw_edge() {
	      var added = [];
	      for(var i = 1; i < selected.length; i++) {
		note1 = note_coords(selected[i-1]);
		note2 = note_coords(selected[i]);
		added.push(line(note1,note2));
	      }
	      return added;
	    }
            
            // Add an edge (or rather a collection of edges) to the MEI graph element
            function add_edge() {
	      var added = [];
	      for(var i = 0; i < selected.length; i++) {
		var elem = mei.createElement("node");
		// This node represent that note
		var label = mei.createElement("label");
		var note = mei.createElement("note");
		note.setAttribute("sameas","#"+selected[i].getAttribute("id"));
		elem.appendChild(label);
		label.appendChild(note);
		// But should have a separate XML ID
		elem.setAttribute("xml:id","gn-" + selected[i].getAttribute("id"));
		mei_graph.appendChild(elem);
		added.push(elem);
	      }
	      for(var i = 1; i < selected.length; i++) {
		// So that we can refer to the node (not the note) ID in
		// arcs/edges
		var elem = mei.createElement("arc");
		elem.setAttribute("from","#gn-"+selected[i-1].getAttribute("id"));
		elem.setAttribute("to","#gn-"+selected[i].getAttribute("id"));
		mei_graph.appendChild(elem);
		added.push(elem);
	      }
	      return added;
	    }

	    // OK we've selected stuff, let's make the selection into a
	    // "hyperedge".
	    function do_edge() {
		if (selected.length == 0 && extraselected == 0) {
		  return;}
		changes = true;
		added = [];
		added.push(draw_edge()); // Draw the edge
		added.push(add_edge());  // Add it to the MEI
		
		undo_actions.push([added,selected,extraselected]);
		selected.forEach(toggleSelected); // De-select
	    }


            // Oops, undo whatever we did last.
	    function do_undo() {
		// Get latest undo_actions
		[added,sel,extra] = undo_actions.pop();
		// Deselect the current selection, if any
		selected.forEach(toggleSelected);
		extraselected.forEach(function(x) {toggleSelected(x,true);});
		// Remove added elements
		added.flat().forEach(function(x) {x.parentNode.removeChild(x);});
		// Select last selection
		sel.forEach(function(x) {toggleSelected(x);});
		extra.forEach(function(x) {toggleSelected(x,true);});
	    }


            // We have keyboard commands!
            function handleKeypress(ev) {
	      if (ev.key == "Enter"){
		do_edge();
	      } else if (ev.key == "u") { // UNDO
		do_undo();
	      }else {
		console.log(ev.key);
	      }

	    }

	    // Function to download data to a file
            // Taken from StackOverflow answer by Kanchu at
            // https://stackoverflow.com/questions/13405129/javascript-create-and-save-file
	    function download(data, filename, type) {
		var file = new Blob([data], {type: type});
		if (window.navigator.msSaveOrOpenBlob) // IE10+
		    window.navigator.msSaveOrOpenBlob(file, filename);
		else { // Others
		    var a = document.createElement("a"),
			    url = URL.createObjectURL(file);
		    a.href = url;
		    a.download = filename;
		    document.body.appendChild(a);
		    a.click();
		    setTimeout(function() {
			document.body.removeChild(a);
			window.URL.revokeObjectURL(url);  
		    }, 0); 
		}
	    }

            // If the MEI already has a graph, we add on to that. TODO:
	    // Check that the graph is actually our kind of graph
            function add_or_fetch_graph() {
	      var existing = mei.getElementsByTagName("graph");
	      if(existing.length) {
		// TODO: Not just grab the first one.
		return existing[0];
	      }
	      var elem = mei.createElement("graph");
	      elem.setAttribute("type","directed");
	      mei.getElementsByTagName("body")[0].appendChild(elem);
	      return elem;
	    }
  
            // An option to download the MEI with the changes we've made
	    function save() {
	      var saved = new XMLSerializer().serializeToString(mei);
	      download(saved, "download.mei", "text/xml");
	    }

	    // Download the current SVG, including graph elements
	    function savesvg() {
	      var saved = new XMLSerializer().serializeToString($("#svg_output")[0]);
	      download(saved, "download.mei", "text/xml");
	    }

            // Load a new MEI
            function load() {
	      /* Cancel loading if changes are not saved? alert */
	      selected = [];
	      extraselected = [];
	      upload = document.getElementById("fileupload");
	      if(upload.files.length == 1){
		reader.addEventListener("load",load_finish);
		reader.readAsText(upload.files[0]);
	      }else{
		return;
	      }
	    }

            function get_by_id(doc,id) {
	      if (id[0] == "#") { id = id.slice(1); }
	      return doc.querySelector("[*|id='"+id+"']");
	    }

	    }
            
            // Do all of this when we have the MEI in memory
            function load_finish(e) {
	      data = reader.result;
	      parser = new DOMParser();
	      mei = parser.parseFromString(data,"text/xml");
	      mei_graph = add_or_fetch_graph();
	      svg = vrvToolkit.renderData(data, {pageWidth: 20000,
		  pageHeight: 10000, breaks: "none"});
	      $("#svg_output").html(svg);
	      draw_graph();
	      for (let n of document.getElementsByClassName("note")) {
		  n.addEventListener('click', function(ev) {toggleSelected(n,ev.shiftKey) } )
	      }
	      document.addEventListener('keypress',function(ev) {handleKeypress(ev);});
	    }


        </script>
	<div id="load_save">
	  <input type="file" id="fileupload" value="Load" onchange="load()" >
	  <!--input type="button" id="uploadbutton" value="Load" onclick="load()" -->
	  <input type="button" id="downloadbutton" value="Save" onclick="save()" >
	  <input type="button" id="svgdownloadbutton" value="Save SVG" onclick="savesvg()" >
	  <input type="button" id="edgebutton" value="Add edge" onclick="do_edge()" >
	  <input type="button" id="undobutton" value="Undo" onclick="do_undo()" >
	</div>

        <!--//////////////////////////////////////////////-->
        <!-- The div where we are going to insert the SVG -->
        <!--//////////////////////////////////////////////-->
	
	<div id="svg_output"></div>



    </body>
</html>
