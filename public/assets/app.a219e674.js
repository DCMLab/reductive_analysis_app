var Xn=Object.defineProperty;var Jn=(t,e,n)=>e in t?Xn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var R=(t,e,n)=>(Jn(t,typeof e!="symbol"?e+"":e,n),n),xt=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var B=(t,e,n)=>(xt(t,e,"read from private field"),n?n.call(t):e.get(t)),ee=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)},de=(t,e,n,i)=>(xt(t,e,"write to private field"),i?i.call(t,n):e.set(t,n),n);import"./app.9e857949.js";import{S as Kn,i as ei,p as ti,$ as N,a as ni,D as ii,j as ri}from"./vendor.20d4a5ae.js";const Lt={},wt={},Bt={},z={undo:"U",redo:"I",deselect_all:"d",delete_all:"D",add_bookmark:"^",move_relation_to_front:"z",reduce_relations:"r",select_same_notes:"+",naturalize_note:"Z",copy:"C",paste:"V"},te={pan_left:"[",pan_right:"]",jump_to_next_bookmark:"{",jump_to_previous_bookmark:"}",jump_to_context_below:",",jump_to_context_above:".",toggle_palette:"-",switch_context_on_hover:!1},si={relation:"R",meta_relation:"M"},oi=["barLineAttr","fermata","rest","stem","flag","tie","artic","slur","dynam","tempo","tupletNum","dir","verse"],ai=[],V=document.documentElement,li=getComputedStyle(V),tt=()=>["INPUT","SELECT","TEXTAREA"].includes(document.activeElement.tagName),ci=(t,e)=>{var n;return(n=e==null?void 0:e.every(i=>t==null?void 0:t.includes(i)))!=null?n:!1},di=Object.freeze({shift:16,control:17,escape:27,left:37,right:39,a:65,h:72,s:83,x:88,z:90}),Q=({keyCode:t},e)=>t===di[e];function ue(t,e=null){const n=nt(t);return e?ci(n,[e].flat()):!!n.length}function nt({metaKey:t,shiftKey:e,ctrlKey:n,altKey:i}){const r={meta:t,shift:e,ctrl:n,alt:i};return Object.keys(r).filter(s=>r[s])}const Ze=/Macintosh/.test(navigator.userAgent)?"meta":"ctrl";function St(t){let e=!1,n=Object.defineProperty({},t,{get:()=>{e=!0}});try{window.addEventListener("test",n,n),window.removeEventListener("test",n,n)}catch{e=!1}return e}const ui=function({capture:t=!1,passive:e=!0,once:n=!1}={}){return gi.capture?{capture:t,passive:e,once:n}:t},gi={passive:St("passive"),capture:St("capture")},C=ui({capture:!0,passive:!1});let Te=null;const Ge={x:0,y:0};class hi{tick({x:e,y:n},i){Te||window.requestAnimationFrame(r=>{this.update(e,n);const s=Te;Te=null,s(Ge)}),Te=i}update(e,n){Ge.x=e,Ge.y=n}}const Dt=new hi,mi=100;let Ct=null;function fi(t,e=mi){clearTimeout(Ct),V.classList.add("resizing"),Ct=setTimeout(()=>{V.classList.remove("resizing"),t()},e)}class pi{constructor(e){this.app=e,this.init()}init(){window.addEventListener("resize",this.onResize.bind(this)),document.addEventListener("click",this.onTap.bind(this),C),document.addEventListener("mousedown",this.onTapStart.bind(this),C),document.addEventListener("mousemove",this.onMouseMove.bind(this),C),document.addEventListener("mouseup",this.onTapEnd.bind(this),C),document.addEventListener("touchstart",this.onTapStart.bind(this),C),document.addEventListener("touchmove",this.onTouchMove.bind(this),C),document.addEventListener("touchend",this.onTapEnd.bind(this),C),document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),document.addEventListener("change",this.onChange.bind(this),C),document.addEventListener("input",this.onInput.bind(this),C),document.addEventListener("submit",this.onSubmit.bind(this),C),document.addEventListener("undoredo",this.onUndoRedo.bind(this)),document.addEventListener("scoreload",this.onScoreLoad.bind(this)),document.addEventListener("scoreselection",this.onScoreSelection.bind(this))}onResize(){fi(()=>{var e,n;(e=this.app.viewport)==null||e.onResize(),(n=this.app.ui)==null||n.onResize()})}onTap(e){var n,i,r,s;(n=this.app.score)==null||n.onTap(e),(i=this.app.player)==null||i.onTap(e),(r=this.app.ui)==null||r.onTap(e),(s=this.app.history)==null||s.onTap(e)}onTapStart(e){var n;(n=this.app.ui)==null||n.onTapStart(e)}onTapEnd(){var e;(e=this.app.ui)==null||e.onTapEnd()}onMouseMove(e){Dt.tick(e,({x:n,y:i})=>{var r;(r=this.app.ui)==null||r.onTapMove(n,i)})}onTouchMove(e){const n={x:Math.round(e.touches[0].clientX),y:Math.round(e.touches[0].clientY)};Dt.tick(n,({x:i,y:r})=>{var s;(s=this.app.ui)==null||s.onTapMove(i,r)})}onChange(e){var n,i,r,s,o,a,l,c,d,h,u,g;(n=this.app.player)==null||n.onChange(e),(r=(i=this.app.ui)==null?void 0:i.filters)==null||r.onChange(e),(o=(s=this.app.ui)==null?void 0:s.mainMenu)==null||o.onChange(e),(l=(a=this.app.ui)==null?void 0:a.startScreen)==null||l.onChange(e),(h=(d=(c=this.app.ui)==null?void 0:c.selection)==null?void 0:d.mode)==null||h.onChange(e),(g=(u=this.app.ui)==null?void 0:u.layersMenu)==null||g.onChange(e)}onInput(e){var n,i;(i=(n=this.app.ui)==null?void 0:n.relationWidth)==null||i.onInput(e)}onSubmit(e){var n,i,r,s,o;(i=(n=this.app.ui)==null?void 0:n.relations)==null||i.onSubmit(e),(o=(s=(r=this.app.ui)==null?void 0:r.layersMenu)==null?void 0:s.jsonTree)==null||o.onSubmit(e)}onUndoRedo(e){var n;(n=this.app.history)==null||n.onUndoRedo(e)}onScoreLoad(e){var n,i,r;(n=this.app.score)==null||n.onScoreLoad(e),(i=this.app.ui)==null||i.onScoreLoad(e),(r=this.app.player)==null||r.reset(),this.app.ui.startScreen&&(this.app.ui.startScreen.destroy(),delete this.app.ui.startScreen)}onScoreSelection(e){var n,i;(n=this.app.score)==null||n.onScoreSelection(e),(i=this.app.ui)==null||i.onScoreSelection(e)}onKeyDown(e){if(!tt()){if(Q(e,"z")){if(ue(e,[Ze,"shift"]))return this.app.history.redo();if(ue(e,Ze))return this.app.history.undo()}if(Q(e,"a")&&ue(e,Ze))return this.app.ui.selection.selectAll();if(Q(e,"control")&&nt(e).length===1)return this.app.ui.newNote.enable();if(Q(e,"shift")&&nt(e).length===1)return this.app.ui.selection.mode.set("primary");if(!ue(e)){if(Q(e,"h"))return this.app.ui.scoreSettings.toggleShades();if(Q(e,"s"))return this.app.ui.scoreSettings.toggleStems();if(Q(e,"x"))return this.app.ui.newNote.toggle()}}}onKeyUp(e){if(Q(e,"control"))return this.app.ui.newNote.disable();if(Q(e,"shift"))return this.app.ui.selection.mode.set("secondary");ue(e)||Q(e,"escape")&&tt()&&document.activeElement.blur()}}var yi=t=>new pi(t);const jt=(t,e=null)=>{const n={},i=t.getBoundingClientRect();for(const r in i)(!e||e.includes(r))&&(n[r]=i[r]);return n};class it{}R(it,"isElement",e=>e.nodeType==1);const vi=(t,e)=>{Object.entries(e).forEach(([n,i])=>{if(i==null)return t.removeAttribute(n);t.setAttribute(n,i)})},ae=(t,e,n)=>Math.max(e,Math.min(n,t)),pe=(t,e=0)=>(e=10**e,Math.round(t*e)/e);class bi{constructor(e=""){this.ctn=document.getElementById(`${e}-progress-ctn`),this.el=document.getElementById(`${e}-progress`),this.doneEl=document.getElementById(`${e}-progress-done`),this.maxEl=document.getElementById(`${e}-progress-max`),this.reset()}update(e=this.done,n=this.max){if(n<=0)return this.reset();this.done=e,this.max=n,this.el.max=n,this.el.value=e,this.el.innerHTML=`${e} / ${n}`;const i=pe(this.el.position,3);this.setBar(i),this.updateLabel()}setBar(e){this.ctn.style.setProperty("--progress",ae(0,e,1))}updateLabel(){this.doneEl.innerHTML=this.formatTime(this.done),this.maxEl.innerHTML=this.formatTime(this.max)}formatTime(e){e=pe(e);const n=Math.floor(e/60);return e=e%60,`${kt(n)}:${kt(e)}`}reset(){this.el.innerHTML="",this.el.removeAttribute("value"),this.el.removeAttribute("max"),this.setBar(0),this.done=0,this.max=0}}const kt=(t,e=2)=>t.toString().padStart(e,"0"),zt=new AudioContext;let k;class _i{constructor(){this.midiId=null,this.playhead=0,this.instrument,this.status="paused",this.activeNotes={},this.ctn=document.getElementById("player"),this.playPauseBtn=document.getElementById("player-play-pause"),this.stopBtn=document.getElementById("player-stop"),this.timelineRange=document.getElementById("player-timeline-input"),this.init()}loadSound(e,n=""){this.midiId!=n&&(this.stop(),this.midiId=n),k.loadDataUri(`data:audio/midi;base64,${e}`)}onTap({target:e}){if(e==this.playPauseBtn){if(k.isPlaying())return this.pause();const n=yo();return this.midiId!="original"&&this.loadSound(n,"original"),this.play()}e==this.stopBtn&&this.status!="stopped"&&this.stop()}onChange({target:e}){e==this.timelineRange&&k.skipToSeconds(e.value).play()}updateProgress(){let e=k.getSongTime(),n=k.getSongTimeRemaining();(isNaN(e)||isNaN(n))&&(e=0,n=0),n=ae(n,0,e);const i=pe(e-n,2);this.progressBar.update(i,e),this.timelineRange.setAttribute("max",e),this.timelineRange.setAttribute("value",i)}play(){this.playhead&&k.skipToTick(this.playhead),k.play(),this.updateControls("playing")}stop(){k.stop(),this.instrument.stop(),this.updateProgress(),this.playhead=0,this.updateControls("stopped")}pause(){this.playhead=k.getCurrentTick(),this.instrument.stop(),k.pause(),this.updateControls("paused")}updateControls(e){this.status=e;let n=e=="playing"?"Pause":"Play";n=this.playPauseBtn.dataset[`label${n}`],vi(this.playPauseBtn,{title:n,ariaLabel:n}),["stopped","playing","paused"].forEach(i=>this.ctn.classList.toggle(`player--${i}`,e==i))}init(){Kn.instrument(zt,"/instruments/acoustic-grand-piano-mp3.js").then(e=>{this.instrument=e,k=new ei.Player(n=>{var r;const i=n.noteName+n.track;n.name=="Note on"&&n.velocity>0?this.activeNotes[i]=e.play(n.noteNumber,zt.currentTime,{gain:n.velocity/127}):(n.name=="Note off"||n.name=="Note on"&&n.velocity==0)&&((r=this.activeNotes[i])==null||r.stop()),this.updateProgress()}),k.on("endOfFile",()=>this.stop())}),this.updateControls("stopped"),this.progressBar=new bi("player")}reset(){this.stop(),this.midiId=null,this.activeNotes={}}}const rt=new _i;class Ei{constructor(){this.ctn=document.getElementById("start-screen"),this.filePicker=document.getElementById("start-screen-score-file-picker"),this.init()}init(){document.getElementById("start-screen-loading-spinner").remove()}onChange(e){e.composedPath().includes(this.filePicker)&&Fn(e)}destroy(){this.ctn.addEventListener("transitionend",this.ctn.remove,{once:!0}),this.ctn.classList.add("start-screen--out")}}const Mi=new Ei;class Ni{constructor(){this.visible=!1,this.ctn=document.getElementById("main-menu"),this.toggleBtn=document.getElementById("main-menu-toggle"),this.filePicker=document.getElementById("score-file-picker"),this.saveFile=document.getElementById("save-file"),this.saveAsSvg=document.getElementById("save-file-svg")}onTap({target:e}){if(e==this.toggleBtn)return this.toggle();if(e==this.saveFile)return go();e==this.saveAsSvg&&ho()}onChange(e){e.composedPath().includes(this.filePicker)&&(Fn(e),this.toggle(!1))}toggle(e=!this.visible){this.visible=e,this.ctn.classList.toggle("fly-out--expanded",e),this.ctn.classList.toggle("fly-out--collapsed",!e)}}const Ai=new Ni,dt=t=>t[0].toUpperCase()+t.slice(1);class Ti extends Map{constructor(){super(...arguments);R(this,"add",(e,n)=>this.has(e)?this:this.set(e,n));R(this,"remember",(e,n)=>(typeof n=="function"&&(n=this.has(e)?this.get(e):n()),this.add(e,n),n))}}var st=function(t,e){return[t*e[0],t*e[1]]},ne=function(t,e){return[t[0]+e[0],t[1]+e[1]]},$t=function(t,e){var n=[t[1]-e[1],e[0]-t[0]],i=Math.sqrt(n[0]*n[0]+n[1]*n[1]);return[n[0]/i,n[1]/i]},Qt=function(t,e){const n=[t[0][0],t[0][1]-e],i=[t[0][0],parseInt(t[0][1])+parseInt(e)];return`M ${n} A `+[e,e,"0,0,0",i].join(",")+" A "+[e,e,"0,0,0",n].join(",")},Ht=function(t,e){var n=st(e,$t(t[0],t[1])),i=st(-1,n),r=ne(t[0],n),s=ne(t[1],n),o=ne(t[1],i),a=ne(t[0],i);return`M ${r} L ${s} A `+[e,e,"0,0,0",o].join(",")+` L ${a} A `+[e,e,"0,0,0",r].join(",")},Ii=function(t,e){if(!t||t.length<1)return"";if(t.length===1)return Qt(t,e);if(t.length===2)return Ht(t,e);for(var n=new Array(t.length),i=0;i<n.length;++i){var r=i===0?t[t.length-1]:t[i-1],s=t[i],o=st(e,$t(r,s));n[i]=[ne(r,o),ne(s,o)]}var a="A "+[e,e,"0,0,0,"].join(",");return n=n.map(function(l,c){var d="";if(c===0)var d="M "+n[n.length-1][1]+" ";return d+=a+l[0]+" L "+l[1],d}),n.join(" ")};function Vt(t){var e=$(),n=e.hullPadding||200,i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.style.setProperty("--shade-alternate",xi()),t.length==1?i.setAttribute("d",Qt(t,n)):t.length==2?i.setAttribute("d",Ht(t,n)):i.setAttribute("d",Ii(ti(t),n)),i}function xi(){const t="456789AB";let e="#";for(let n=0;n<6;n++)e+=t[Math.floor(Math.random()*t.length)];return e}function Ft(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg","line");return n.setAttribute("x1",t[0]),n.setAttribute("y1",t[1]),n.setAttribute("x2",e[0]),n.setAttribute("y2",e[1]),n.style.stroke="#000",n.style.strokeWidth="15px",n}function Pt(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg","circle");return n.setAttribute("cx",t[0]),n.setAttribute("cy",t[1]),n.setAttribute("r",e),n.style.stroke="#000",n.style.strokeWidth="15px",n}function Li(t,e,n){var i=document.createElementNS("http://www.w3.org/2000/svg","rect");return i.setAttribute("x",t[0]),i.setAttribute("y",t[1]),i.setAttribute("width",e),i.setAttribute("height",n),i.style.stroke="#000",i.style.fill="white",i.style.strokeWidth="15px",i}function Wt(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg","text");return e&&(n.setAttribute("x",e[0]),n.setAttribute("y",e[1])),n.append(t),n}function wi(t,e,n,i=0){var r=document.createElementNS("http://www.w3.org/2000/svg","tspan");return r.setAttribute("x",e[0]),r.setAttribute("dx",i),r.setAttribute("dy",n),r.append(t),r}function Ue(t){var e=Zr();t.parentElement.prepend(t),e.close(),e.open()}function Re(t,e){var n=t.getElementsByClassName("system")[0],i=n.parentNode;i.insertBefore(e,n)}function Be(){var t=document.createElementNS("http://www.w3.org/2000/svg","g");return t}function ut(t=5){return Math.floor(Math.random()*(1<<t*4)).toString(16)}function Se(t,e){var n=Pe();return n.getMIDIValuesForElement(b(t)).pitch-n.getMIDIValuesForElement(b(e)).pitch}function De(t,e){var n=Pe();return n.getMIDIValuesForElement(b(t)).time-n.getMIDIValuesForElement(b(e)).time}function Bi(t){var e=t;e=e.sort(Se),e=e.sort(De);var n=e.map(i=>({p_off:Se(i,e[0]),t_off:De(i,e[0]),n_from:i}));return n}function Si(t,e,n,i){for(var r=t.closest("measure"),s=[];r;){let o=!0,a=r.querySelectorAll("note");for(let l of a){let c=De(l,t);if(c>=0&&c<=i){console.log("in time");let d=Se(l,t);d>=e&&d<=n&&(console.log("in pitch"),o=!1,s.push(l))}}o?r=null:r=qt(r)}return s}function qt(t){return t.nextElementSibling&&t.nextElementSibling.tagName=="measure"?t.nextElementSibling:t.nextElementSibling?qt(t.nextElementSibling):null}function S(t){return[t.getElementsByTagName("use")[0].x.animVal.value+100,t.getElementsByTagName("use")[0].y.animVal.value]}function Zt(t,e){e[0]=="#"&&(e=e.slice(1));var n=t.querySelectorAll("[*|oldid='"+e+"']");return n?Array.from(n):Array.from(t.all).find(i=>i.getAttribute("oldid")==e)}function y(t,e){if(!e)return null;e[0]=="#"&&(e=e.slice(1));var n=t.querySelector("[*|id='"+e+"']");return n||Array.from(t.getElementsByTagName("*")).find(i=>i.getAttribute("id")==e||i.getAttribute("xml:id")==e)}const Ce=t=>{var e;return(e=t.getAttribute("oldid"))!=null?e:t.id};function b(t){if(document.contains(t))return t.hasAttribute("oldid")?b(document.getElementById(t.getAttribute("oldid"))):t.id;if(t.hasAttribute("xml:id")){if(t.hasAttribute("sameas"))return b(y(mei,t.getAttribute("sameas")));if(t.hasAttribute("corresp"))return b(y(mei,t.getAttribute("corresp")));if(t.hasAttribute("copyof"))return b(y(mei,t.getAttribute("copyof")));if(t.hasAttribute("xml:id"))return t.getAttribute("xml:id")}}function w(t,e){if(!!e){e[0]=="#"&&(e=e.slice(1));var n=Di(t.layer,e),i=document.getElementById(n);if(t.svg_elem.contains(i))return n;if(n)return t.id_prefix+n}}function Di(t,e){e[0]=="#"&&(e=e.slice(1));var n=t.id_mapping.find(i=>i[1]==e);return n?n[0]:e}function Ci(t){return console.debug("Using global: mei to find element"),Array.from(mei.getElementsByTagName("arc")).filter(e=>e.getAttribute("from")=="#"+t||e.getAttribute("to")=="#"+t).length>0}function j(t){return t.getElementsByTagName("label")[0].children.length==0?t.getAttribute("xml:id"):t.getElementsByTagName("label")[0].getElementsByTagName("note")[0].getAttribute("sameas").replace("#","")}function ji(t,e){return(t%e+e)%e}function Gt(t,e){return(t+e)/2}function ki(t){if(console.debug("Using globals: document, mei to find element"),document.contains(t)&&(t=y(mei,b(t))),t.hasAttribute("accid.ges"))return t.getAttribute("accid.ges");if(t.hasAttribute("accid"))return t.getAttribute("accid");if(t.children.length==0)return"";var e=t.getElementsByTagName("accid");if(e.length==0)return"";var n=e[0];return n.hasAttribute("accid.ges")?n.getAttribute("accid.ges"):n.hasAttribute("accid")?n.getAttribute("accid"):""}function zi(t){var e=O();t=y(mei,b(t));var n=Ye(e,t),i=n.map(j).map(r=>y(mei,r));return i}function Xt(t){var e=O();t=y(mei,b(t));var n=$e(e,t),i=n.map(j).map(o=>y(mei,o)),r=P(e,t),s=r.map(j).map(o=>y(mei,o));return[i,s]}function Ye(t,e){var n=Array.from(t.getElementsByTagName("arc")),i=[];return n.forEach(r=>{r.getAttribute("from")=="#"+e.getAttribute("xml:id")&&i.push(y(t.getRootNode(),r.getAttribute("to")))}),i}function $e(t,e){var n=Array.from(t.getElementsByTagName("arc")),i=[];return n.forEach(r=>{r.getAttribute("from")=="#"+e.getAttribute("xml:id")&&r.getAttribute("type")=="primary"&&i.push(y(t.getRootNode(),r.getAttribute("to")))}),i}function P(t,e){var n=Array.from(t.getElementsByTagName("arc")),i=[];return n.forEach(r=>{r.getAttribute("from")=="#"+e.getAttribute("xml:id")&&r.getAttribute("type")=="secondary"&&i.push(y(t.getRootNode(),r.getAttribute("to")))}),i}function gt(t){return t.children.length==0?"":t.children[0].getAttribute("type")}function Ot(t,o){var n=b(o),i=b(y(mei,n)),r=y(t.getRootNode(),"gn-"+i);if(r!=null)return r;r=t.getRootNode().createElement("node");var s=t.getRootNode().createElement("label"),o=t.getRootNode().createElement("note");return o.setAttribute("sameas","#"+i),r.appendChild(s),s.appendChild(o),r.setAttribute("xml:id","gn-"+i),t.appendChild(r),r}function Oi(t,e){var n=y(t.svg_elem.getRootNode(),w(t,j(e)));return n&&t.svg_elem.contains(n)&&n.classList.add("hidden"),n}function Ui(t,e){var n=y(t.svg_elem.getRootNode(),"hier"+w(t,j(e)));return n&&t.svg_elem.contains(n)&&n.classList.add("hidden"),n}function Ri(t,e){var n=y(t.svg_elem.getRootNode(),t.id_prefix+e.getAttribute("xml:id"));return n&&t.svg_elem.contains(n)&&n.classList.add("hidden"),n}function Yi(t,e){var n=y(t.svg_elem.getRootNode(),"hier"+t.id_prefix+e.getAttribute("xml:id"));return n&&t.svg_elem.contains(n)&&n.classList.add("hidden"),n}function $i(t){if(!t){console.log("Not a note");return}if(t.classList.contains("secondarynote")){var e=getComputedStyle(t).getPropertyValue("--how-secondary");t.style.setProperty("--how-secondary",e*2)}else t.classList.add("secondarynote"),t.style.setProperty("--how-secondary",2)}function Qi(t){if(!t){console.log("Not a note");return}var e=getComputedStyle(t).getPropertyValue("--how-secondary");t.style.setProperty("--how-secondary",e/2),e/2==1&&t.classList.remove("secondarynote")}function ht(t,e,n){t.svg_elem,n.tagName!="node"&&(n=y(e.getRootNode(),n.id));var i=P(e,n);i.forEach(r=>{var s=document.getElementById(w(t,j(r)));$i(s)})}function mt(t,e,n){t.svg_elem,n.tagName!="node"&&(n=y(e.getRootNode(),n.id));var i=P(e,n);i.forEach(r=>{var s=document.getElementById(w(t,j(r)));Qi(s)})}function Jt(t){return t.tagName=="measure"?t:Jt(t.parentElement)}function Hi(){if(console.debug("Using globals: document, mei to find elems"),(selected.length==1||extraselected.length==1)&&!(selected.length==1&&extraselected.length==1)){var t;selected.length==1?t=selected[0]:t=extraselected[0];var e=y(mei,t.getAttribute("id")),n=Jt(e),i=Array.from(n.getElementsByTagName("note"));i.forEach(r=>{r.getAttribute("oct")==e.getAttribute("oct")&&r.getAttribute("pname")==e.getAttribute("pname")&&v(y(document,r.getAttribute("xml:id")))}),v(t,!0)}}function W(t){return typeof t=="undefined"?!1:t.classList.contains("note")?"note":t.classList.contains("relation")?"relation":t.classList.contains("metarelation")?"metarelation":""}function Vi(t){var e=t.getBBox();return[e.x+e.width/2,e.y+e.height/2]}function Fi(t){if(t.classList.contains("metarelation")){var e=t.getElementsByTagName("circle")[0];return[e.cx.baseVal.value,e.cy.baseVal.value]}else return t.classList.contains("relation")?Vi(t):(console.log("wtf"),console.log(t),[0,0])}function Kt(t){return t.reduce((e,n)=>e+n,0)/t.length}function en(t){var e=y(mei,t);if(e.tagName=="node")return e.children[0].getAttribute("type");var n=ki(e);return n=n.replace(/s/g,"#"),n=n.replace(/f/g,"b"),n=n.replace(/n/g,""),e.getAttribute("pname")+n+e.getAttribute("oct")}function Pi(t){if(t.length==0)return"";if(t[0].classList.contains("note"))return t.sort((e,n)=>{const[i,r]=S(e),[s,o]=S(n);return i-s==0?o-r:i-s}),t.map(e=>en(b(e)))}function Wi(t){return Array.from(t.getElementsByTagName("node")).forEach(e=>{e.getAttribute("type")=="hyperedge"&&e.setAttribute("type","relation"),e.getAttribute("type")=="metaedge"&&e.setAttribute("type","metarelation")}),t}var Qe=["dur","n","dots","when","layer","staff","tstamp.ges","tstamp.real","tstamp","loc","dur.ges","dots.ges","dur.metrical","dur.ppq","dur.real","dur.recip","beam","fermata","tuplet"];function qi(t,e){var n=t.createElementNS("http://www.music-encoding.org/ns/mei","rest");n.setAttribute("xml:id","rest-"+e.getAttribute("xml:id"));for(let i of Qe)e.hasAttribute(i)&&n.setAttribute(i,e.getAttribute(i));return n}function Zi(t,e){var n=t.createElementNS("http://www.music-encoding.org/ns/mei","space");n.setAttribute("xml:id","space-"+e.getAttribute("xml:id"));for(let i of Qe)e.hasAttribute(i)&&n.setAttribute(i,e.getAttribute(i));return n}function Gi(t,e){var n=t.createElementNS("http://www.music-encoding.org/ns/mei","chord");n.setAttribute("xml:id","chord-"+e.getAttribute("xml:id"));for(const i of Qe)e.hasAttribute(i)&&n.setAttribute(i,e.getAttribute(i));return n}function Xi(t,e){var n=t.createElementNS("http://www.music-encoding.org/ns/mei","space");n.setAttribute("xml:id","space-"+e.getAttribute("xml:id"));for(let i of Qe)e.hasAttribute(i)&&n.setAttribute(i,e.getAttribute(i));return n}function ft(t,e){t.id&&(t.setAttribute("oldid",t.id),t.id=e+t.id),t.getAttribute("xml:id")&&t.setAttribute("xml:id",e+t.getAttribute("xml:id")),t.getAttribute("startid")&&t.setAttribute("startid",e+t.getAttribute("startid")),t.getAttribute("endid")&&t.setAttribute("endid",e+t.getAttribute("endid")),Array.from(t.children).forEach(n=>ft(n,e))}function Ji(t){var e=t.implementation.createDocument(t.namespaceURI,null,null),n=e.importNode(t.documentElement,!0);return e.appendChild(n),e}function je(t){var e;return t.id?e=[t.id,b(t)]:t.hasAttribute("xml:id")&&(e=[t.getAttribute("xml:id"),b(t)]),e?[e].concat(Array.from(t.children).flatMap(je)):Array.from(t.children).flatMap(je)}function tn(){var t=document.getElementById("layers"),e=document.createElement("div");return e.id="layer"+t.children.length,e.classList.add("layer"),e.classList.add("layer-new-ui"),t.appendChild(e),e}function nn(t){var e=$(),n=document.createElement("div");n.id="view"+e.length,n.classList.add("view");var i=document.createElement("div");return i.id="svg"+e.length,i.classList.add("svg_container"),n.appendChild(i),t.appendChild(n),[n,i]}function Ki(t){var e=t;return ai.forEach(n=>{Array.from(t.getElementsByTagName(n)).forEach(i=>{i.parentNode.removeChild(i)})}),e}function er(t,e,n){var i=O(),r=e.map(a=>a.getAttribute("id").replace(/(^\d+-?)/,"gn-")).sort((a,l)=>a<l),s=n.map(a=>a.getAttribute("id").replace(/(^\d+-?)/,"gn-")).sort((a,l)=>a<l),o=Array.from(i.querySelectorAll("[type='relation']")).filter(a=>a.children[0].getAttribute("type")==t);return o.forEach(a=>{var l=Xt(a),c=l[0],d=l[1];if(c=c.map(h=>h.getAttribute("xml:id")).sort((h,u)=>h<u),d=d.map(h=>h.getAttribute("xml:id")).sort((h,u)=>h<u),JSON.stringify(r)==JSON.stringify(c)&&JSON.stringify(s)==JSON.stringify(d))return alert(`Warning: This relation already exists.
Creating a duplicate anyway.`),!1}),!0}function rn(t){return $().find(e=>e.svg_elem.contains(t))}function sn(t,e,n){var i=e.map(s=>$e(t,s)).flat();e=e.filter(s=>!n.includes(s)),i=i.concat(e.map(s=>P(t,s)).flat());do{var r=n.filter(s=>P(t,s).findIndex(o=>i.includes(o))>-1);e=e.concat(r),n=n.filter(s=>!r.includes(s)),i=i.concat(r.map(s=>P(t,s)).flat())}while(r.length>0);return[n,[...new Set(n.flatMap(s=>P(t,s)))]]}function on(t){var e=O();tr(t,e,selected,extraselected)}function tr(t,e,n,i){var r=n.concat(i),s=r.map(u=>y(e.getRootNode(),b(u))),o=Array.from(e.getElementsByTagName("node")).filter(u=>u.getAttribute("type")=="relation"),a=o.filter(u=>{var g=y(document,t.id_prefix+u.getAttribute("xml:id"));return g!=null&&!g.classList.contains("hidden")});s.length==0&&(s=a);var[l,c]=sn(e,a,s),d=[];d.push(l.map(u=>Ri(t,u))),d.push(c.map(u=>Oi(t,u))),d.push(l.map(u=>Yi(t,u))),d.push(c.map(u=>Ui(t,u)));var h=[l,c,d];t.reductions.push(["reduce",h,n,i])}function nr(t){console.log("Using globals: selected/extraselected");var e=t.reductions;if(e.length==0){console.log("Nothing to unreduce");return}selected.forEach(c=>v(c,!1)),extraselected.forEach(c=>v(c,!0));var[n,i,r,s]=e.pop(),[o,a,l]=i;l.flat().forEach(c=>{c&&c.classList.remove("hidden")}),r.forEach(c=>v(c,!1)),s.forEach(c=>v(c,!0))}function ir(t,e,n=!0){var i=O(),r=[],s=e,o=t.filter(c=>c!=null);do{let c=[];n&&(c=o.filter(d=>!s.find(h=>Ye(i,h).includes(d))));var[a,l]=sn(i,s,s);c=c.concat(l.filter(d=>o.includes(d))),r.push(c),o=o.filter(d=>!c.includes(d)),s=s.filter(d=>!a.includes(d))}while(l.length+a.length>0);return r.push(o),r}function an(t,e=200,n=!0){var i=t.svg_elem,r=t.id_prefix;bt(t);var s=Be();s.id="hier"+r;var o=Array.from(i.getElementsByClassName("note")).map(b).map(g=>y(mei,g)).map(b).map(g=>y(mei,"gn-"+g)).filter(g=>g!=null),a=Array.from(i.getElementsByClassName("relation")).map(b).map(g=>y(mei,g)),l=ir(o,a,n),c=0,d=500,h=l.flatMap((g,m)=>g.map(p=>{let f=document.getElementById(w(t,j(p))),[_,A]=S(f);return[p,[_,c-d*m]]})),u={};h.forEach(([g,m])=>{let p=e<100?50:e/2,f=p<100?200:p>200?400:p*2,_=j(g),A=u[m],M,E=[m[0]+p+10,m[1]+p+25-f];if(A)M=A.getElementsByTagName("text")[0];else{A=Be();let U=Pt(m,p);A.appendChild(U),A.id="hier"+r+_,M=Wt("",E),M.style.fontFamiy="sans-serif",M.style.fontSize=f+"px",M.classList.add("nodetext"),A.appendChild(M),s.appendChild(A),u[m]=A}let D=wi(en(_),E,f);M.appendChild(D)}),a.forEach(g=>{let m=r+g.getAttribute("xml:id"),p=gt(g),f=document.getElementById(m),A=Ye(O(),g).map(E=>h.find(D=>D[0]==E)[1]),M=Vt(A);M.setAttribute("id","hier"+m),r!=""&&M.setAttribute("oldid",s.getAttribute("xml:id")),M.classList.add("relation"),M.setAttribute("type",p),G(M),Ae.ui.scoreSettings.brightShades||G(M),M.onclick=E=>v(f),M.onmouseover=function(){f.classList.add("relationhover"),f.onmouseover()},M.onmouseout=function(){f.classList.remove("relationhover"),f.onmouseout()},M.addEventListener("wheel",E=>{E.preventDefault(),Ue(E.target),E.target.onmouseout()},C),s.appendChild(M)}),Re(i,s),bn(t,l.length*d)}var Y={};function rr(){let t=selected.concat(extraselected);if(t.length==0||!t[0].classList.contains("relation")){console.log("No relation selected");return}let e=t.flatMap(i=>zi(y(mei,b(i))));Y={template:Bi(e),rels:t}}function sr(){if(!Y){console.log("No copy to paste");return}let t=selected.concat(extraselected);if(t.length!=1||!t[0].classList.contains("note")){console.log("Pasting requires selecting a single note, for now.");return}let e=y(mei,b(t[0])),n=Y.template.map(c=>c.p_off);n=n.sort((c,d)=>c-d);let i=Si(e,n[0],n[n.length-1],Y.template[Y.template.length-1].t_off);Y.template.forEach(c=>c.n_to=void 0);for(var r of i){let c=De(r,e),d=Se(r,e);for(var s of Y.template)if(c==s.t_off&&d==s.p_off){if(s.n_to!=null){console.log("Template mismatch: Found two matching notes: ",s,r);return}s.n_to=r}}for(var o of Y.template)if(o.n_to==null){console.log("Template mismatch: No matching note found: ",o);return}const a=rn(t[0]);v(t[0]);for(var l of Y.rels){let c=y(mei,b(l)),[d,h]=Xt(c);for(let u of d){let g=Y.template.find(p=>p.n_from==u),m=y(document,w(a,b(g.n_to)));v(m,!0)}for(let u of h){let g=Y.template.find(p=>p.n_from==u),m=y(document,w(a,b(g.n_to)));v(m)}X(l.getAttribute("type"))}}function or(t){console.debug("Using globals: mei for element selection");var e=b(t),n=y(mei,e),i=[],r=W(t)=="metarelation",s=O(),o=$();for(const d of o){let h=y(document,d.id_prefix+e);h&&(i.push(h),r||mt(d,s,n))}var a=Array.from(mei.getElementsByTagName("arc")).filter(d=>d.getAttribute("to")=="#"+t.id||d.getAttribute("from")=="#"+t.id),l=a.concat(i);l.push(n);var c=l.map(d=>{var h=[d,d.parentElement,d.nextSibling];try{N(`g #${d.getAttribute("to").substring(4)}`).removeClass().addClass("note")}catch{}return d.parentElement.removeChild(d),h});return ce(),c}function pt(t=!1){console.debug("Using globals: selected for element selection, undo_actions for storing the action");var e=selected.concat(extraselected);if(e.length==0||!(W(e[0])=="relation"||W(e[0])=="metarelation")){console.log("No (meta)relation selected!");return}var n=e.flatMap(or),i=We();i.push(["delete relation",n.reverse(),selected,extraselected]),e.forEach(v),t||He()}function ln(){console.debug("Using globals: undo_actions, selected, extraselected, mei, rerendered_after_action");var t=We();if(t.length==0){console.log("Nothing to undo");return}if(t.length==_o()){console.log("Cannot undo past a rerender"),alert("Cannot undo past a rerender.");return}selected.forEach(g=>v(g,!1)),extraselected.forEach(g=>v(g,!0));var e=$(),n=At();const[i,r,s,o]=t.pop();if(i=="edges"||i=="relation"||i=="metarelation"){var a=r;let g,m,p=a.flat().find(f=>f.tagName=="node"&&f.getAttribute("type")==i);if(p)g=p.getAttribute("xml:id"),p.children.length>0&&(m=p.children[0].getAttribute("type"));else{console.log("Could not find graph element of (meta)relation to undo: ",r);return}if(i=="relation")for(const f of e)mt(f,O(),p);a.flat().forEach(f=>{Ci(f.getAttribute("xml:id"))||f.parentNode.removeChild(f)}),Array.from(document.querySelectorAll('[oldid="'+g+'"]')).forEach(f=>f.parentNode.removeChild(f)),s.forEach(f=>v(document.getElementById(f.id),!1)),o.forEach(f=>v(document.getElementById(f.id),!0)),n.push([i,[m,g],s,o])}else if(i=="delete relation"){var l=r;l.forEach(g=>{g[1].insertBefore(g[0],g[2]);let m=e.find(f=>f.svg_elem.contains(g[0])),p=W(g[0])=="relation";if(m&&p){let f=b(g[0]),_=y(mei,f);ht(m,O(),_)}}),s.forEach(g=>v(g,!1)),o.forEach(g=>v(g,!0)),n.push([i,[],s,o])}else if(i=="change relation type"){var c=r;let g=r[0][1];s.concat(o).forEach(m=>{var[p,f]=c.pop(),_=Ce(m),A=[y(document,_)].concat(Zt(document,_));A.forEach(E=>E.setAttribute("type",p));var M=y(mei,_);M.getElementsByTagName("label")[0].setAttribute("type",p),A.forEach(G)}),s.forEach(m=>v(m,!1)),o.forEach(m=>v(m,!0)),n.push([i,g,s,o])}else if(i=="add note"){var[d,h]=r;h.forEach(_=>_.parentNode.removeChild(_));let g=d[0].getAttribute("pname"),m=d[0].getAttribute("oct"),p=d[0].getAttribute("xml:id"),f=s[0];if(d[0].parentNode.removeChild(d[0]),d.length>1){var u=d[1];u.parentNode.insertBefore(u.children[0],u),u.parentNode.removeChild(u)}n.push([i,[g,m,f,p],s,o])}ce(),yt()}function He(){bo([]),yt()}function cn(){var t=At();if(t.length==0){console.log("Nothing to redo");return}selected.forEach(a=>v(a,!1)),extraselected.forEach(a=>v(a,!0));const[e,n,i,r]=t.pop();i.forEach(a=>v(document.getElementById(a.id),!1)),r.forEach(a=>v(document.getElementById(a.id),!0));let s,o;switch(e){case"relation":[s,o]=n,X(s,o,!0);break;case"metarelation":[s,o]=n,Nt(s,o,!0);break;case"change relation type":s=n,X(s,"",!0);break;case"delete relation":pt(!0);break;case"add note":let[a,l,c,d]=n;gn(a,l,c,d,!0),v(i[0]);break}yt()}function yt(){document.dispatchEvent(new CustomEvent("undoredo",{detail:{redoAbleCount:At().length,undoAbleCount:We().length}}))}var ot="cdefgab";function ar(){var t=x(),e=t.svg_elem.children[0],n=t.svg_elem.getElementsByClassName("system")[0],i=e.createSVGPoint();return i.x=Ir(),i.y=xr(),i.matrixTransform(n.parentElement.getScreenCTM().inverse())}function lr(t){let e=t.svg_elem;var n=Array.from(e.getElementsByClassName("measure"));n.length&&Array.from(n[0].getElementsByClassName("staff")),Array.from(e.getElementsByClassName("note"));var i=n.map(r=>[r.getBBox().x+r.getBBox().width,r]);return i.sort((r,s)=>r[0]-s[0]),i}function cr(t,e){let n=t.measure_map.find(i=>i[0]>e.x);if(n)return n[1]}function Le(t){let e=t.children[2].getBBox();return e.y+e.height/2}function dr(t){let e=t.children[2].getBBox(),n=t.children[1].getBBox();return Math.abs(e.y-n.y)}function ur(t,e,n){var i=Array.from(n.getElementsByClassName("staff")),r=i.map(a=>[Le(a),a]);r.sort((a,l)=>a[0]-l[0]);var s=r.findIndex(a=>e.y<a[0]);if(s==0)return r[0][1];if(s==-1)return r[r.length-1][1];const o=Gt(r[s-1][0],r[s][0]);return e.y<o?r[s-1][1]:r[s][1]}function gr(t){var e=y(mei,b(t)),n=e.getAttribute("pname"),i=e.getAttribute("oct");return i*7+ot.indexOf(n)}function hr(t){const e=Le(t),i=-Math.abs(dr(t))/2,r=t.getElementsByClassName("note");var s;if(r.length>0)s=r[0];else{const a=t.closest(".system"),c=Array.from(a.getElementsByClassName("staff")).find(d=>Le(d)==e&&d.getElementsByClassName("note").length>0);c&&(s=c.getElementsByClassName("note")[0])}var o;if(console.log(s),s)o=gr(s)-Math.floor((S(s)[1]-e)/i);else{const a=t.closest(".system"),d=Array.from(a.getElementsByClassName("staff")).find(g=>Le(g)==e&&g.getElementsByClassName("clef").length>0).getElementsByClassName("clef")[0],h=d.children[0].getAttribute("y");let u;switch(d.children[0].getAttribute("xlink:href")){case"E062":u=24;break;case"E052":u=25;break;case"E050":u=32;break}o=u-Math.floor((h-e)/i)}return[a=>{var l=Math.floor((a+i/2-e)/i)+o,c=Math.floor(l/7),d=ot[ji(l,7)];return[d,c]},(a,l)=>{var c=l*7+ot.indexOf(a);return e+(c-o)*i}]}function mr(t,e,n){return n.getElementsByClassName("note")[0],n.y_to_p(e.y)}function fr(t,e,n){var i=Array.from(n.getElementsByClassName("note")).map(o=>[S(o)[0],o]);if(i.length==0)return null;i.sort((o,a)=>o[0]-a[0]);var r=i.findIndex(o=>e.x<o[0]);if(r==0)return i[0][1];if(r==-1)return i[i.length-1][1];const s=Gt(i[r-1][0],i[r][0]);return e.x<s?i[r-1][1]:i[r][1]}function vt(){var t=x(),e=t;const n=ar(),i=cr(e,n);if(!i)return console.log("Pointer outside measures"),[null,null,null];const r=ur(e,n,i),[s,o]=mr(e,n,r),a=fr(e,n,r);return a?[s,o,a]:[null,null,null]}function dn(t,e,n){var i=n.closest(".staff");return i.getElementsByClassName("note")[0],[S(n)[0],i.p_to_y(t,e)]}function un(t,e,n,i=!0,r=""){var s=document.getElementById(r);if(s&&s.parentElement.removeChild(s),i){let[a,l]=dn(t,e,n),[c,d]=S(n);var o=document.createElementNS("http://www.w3.org/2000/svg","use");o.setAttributeNS("http://www.w3.org/1999/xlink","href","#"+n.id),o.setAttribute("x",a-c),o.setAttribute("y",l-d),o.id=r,n.parentElement.appendChild(o)}}function pr(t,e,n,i=!0,r=""){var s=document.getElementById(r),o=[];if(s&&s.parentElement.removeChild(s),i){let[d,h]=dn(t,e,n);var a=document.createElementNS("http://www.w3.org/2000/svg","g"),l=document.createElementNS("http://www.w3.org/2000/svg","g"),c=document.createElementNS("http://www.w3.org/2000/svg","use");c.setAttributeNS("http://www.w3.org/1999/xlink","href",n.getElementsByTagName("use")[0].getAttributeNS("http://www.w3.org/1999/xlink","href")),c.setAttribute("x",d-100),c.setAttribute("y",h),c.setAttribute("height","720px"),c.setAttribute("width","720px"),a.id=r,a.classList.add("note"),l.classList.add("notehead"),l.appendChild(c),a.appendChild(l),n.parentElement.appendChild(a),a.onclick=()=>v(a),o.push(a)}return o.reverse()}function yr(t,e,n,i,r=!0,s=""){var o=y(mei,b(i));if(!t.score_elem.contains(o))return console.log("Note not in layer?"),!1;var a=mei.createElement("note"),l=[];if(a.setAttribute("xml:id",s),r){let c;o.closest("chord")?c=o.closest("chord"):(c=Gi(mei,o),o.parentElement.insertBefore(c,o),o.parentElement.removeChild(o),c.appendChild(o),l.push(c)),a.setAttribute("pname",e),a.setAttribute("oct",n),c.appendChild(a),l.push(a),t.id_mapping.push([s,s])}else return console.log("Not implemented"),!1;return l.reverse()}function gn(t,e,n,i,r,s=!1){var o="new-"+ut();let a=n;typeof r!="undefined"&&(o=r);var l=[];console.log(n),l.push(pr(t,e,n,i,o));var c=x();l.push(yr(c.layer,t,e,n,i,o)),fn(),s||He();var d=We();d.push(["add note",l.reverse(),[a],[]])}function vr(){var t=x(),e=Ne();if(e!=""&&t.canEdit){let[n,i,r]=vt();if(!n)return;gn(n,i,r,!0)}}function hn(){var t=x(),e=Ne();if(typeof t!="undefined"){if(!t.canEdit)return;let[n,i,r]=vt();e="temp"+ut(),Nn(e),document.getElementById("layers").style.cursor="crosshair",n&&un(n,i,r,!0,e)}}function mn(){var t=Ne();let e=document.getElementById(t);e&&e.parentElement.removeChild(e),t="",Nn(t),document.getElementById("layers").style.cursor="default"}function fn(){var t=x(),e=Ne();if(t.canEdit)return e?(mn(),!1):(hn(),!0)}function br(){var t=x();if(!t.canEdit)return;let[e,n,i]=vt();e&&un(e,n,i,!0,Ne())}function pn(){if(!selected[0].classList.contains("note")){console.log("Can only naturalize notes.");return}if(!rn(selected[0]).canEdit){console.log("No modifications allowed to non-editable layer.");return}var t=selected.concat(extraselected);t.forEach(Er),t.forEach(v)}const _r=document.getElementById("naturalizebutton");_r.addEventListener("click",pn);function Er(t){let e=t.querySelector(".accid");if(!e){console.log("No accidental to remove");return}Mr(e),e.classList.add("hidden");let n=b(e);var i=$();for(const r of i){let s=r.id_prefix+n,o=document.getElementById(s);o&&o.classList.add("hidden")}}function Mr(t){for(var e=t.parentElement;!e.classList.contains("note");)e=e.parentElement;var n=b(e),i=y(mei,n);Nr(i)}function Nr(t){t.removeAttribute("accid");var e=Array.from(t.children).filter(n=>n.tagName=="accid");e.forEach(n=>t.removeChild(n))}const Ar={note:["relations","metarelations","comborelations"],relation:["metarelations","relations","comborelations"],metarelation:["metarelations","comborelations","relations"]},yn={name:"relation",main:{repeat:{key:"e",color:1,shadeColor:0},passing:{key:"p",color:2,shadeColor:6},neighbour:{key:"n",color:3,shadeColor:2},harmonic:{key:"i",color:4,shadeColor:3},arpeggio:{key:"a",color:5,shadeColor:4},urlinie:{key:"u",color:6,shadeColor:5},bassbrechung:{key:"b",color:7,shadeColor:5},untyped:{color:5}},additional:["repetition","arpeggiation","back_relating_dominant","displacement","register_transfer","56_shift","added_root","initial_ascent","arpeggiated_ascent","urlinie_transference","bassbrechung_component","coupling","voice_exchange_component","voice_exchange_component_chromaticized","mixture","phrygian_ii"]},vn={name:"metarelation",main:{context:{key:"c",color:1,shadeColor:0},layer:{key:"l",color:2,shadeColor:6},phrase:{key:"r",color:3,shadeColor:2},section:{key:"t",color:5,shadeColor:3}},additional:["auxiliary_cadence","superposition","reaching_over","urlinie_meta","ursatz","bassbrechung","bassbrechung_transference","ursatz_transference","unfolding","motion_into_the_inner_voice","motion_from_the_inner_voice","linear_intervallic_progression","linear_intervallic_progression_module","interruption","interruption_branch_1","interruption_branch_2","voice_exchange","motivic_parallelism","motive","contradiction","indeterminacy","parallel_fifths","parallel_octaves"]},at={name:"comborelation",main:{"passing comborelation":{key:"P",total:"passing",outer:"arpeggio"},"neighbour comborelation":{key:"N",total:"neighbour",outer:"repeat"}}},Tr=t=>Ar[t];var Ie=!1,Ve="",H,le,Me;const Ir=()=>le,xr=()=>Me;var he,se=null,Xe=!0;function v(t,e=null){const n=W(t);if(!["relation","metarelation","note"].includes(n))return;const i=selected.concat(extraselected);if(i.length>0){const s=W(i[0]),o=i[0].closest(".svg_container"),a=t.closest(".svg_container");if(n!=s||a!=o)return}const r=i.find(s=>s==t);r&&(t.classList.remove("selectednote","extraselectednote","selectedrelation","extraselectedrelation"),selected=selected.filter(s=>s!==t),extraselected=extraselected.filter(s=>s!==t)),e===null&&(e=Ae.ui.selection.mode.mode=="primary"),n=="note"&&!r&&(e?(t.classList.add("extraselectednote"),extraselected.push(t)):(t.classList.add("selectednote"),selected.push(t)),se=t),(n=="relation"||n=="metarelation")&&(r||(e?(t.classList.add("extraselectedrelation"),extraselected.push(t)):(t.classList.add("selectedrelation"),selected.push(t)),se=t),selected.concat(extraselected).length==0&&(se=null)),document.dispatchEvent(new CustomEvent("scoreselection",{detail:{selected,extraselected}}))}function Lr(t){var e=Array.from(t.svg_elem.getElementsByClassName("relation")).filter(s=>!s.classList.contains("relation--filtered"));if(e.length>0){W(e[0]);var n=e[0].closest("div");if(selected.length>0||extraselected.length>0){var i=W(selected.concat(extraselected)[0]),r=selected.concat(extraselected)[0].closest("div");i!="relation"&&ye(),n!=r&&ye()}e.forEach(s=>{s.classList.contains("selectedrelation")||v(s)})}}window.onmousemove=t=>{le=t.clientX,Me=t.clientY,Ve!=""&&br()};function wr(t){t.key==="Shift"&&N("#layers").addClass("shift-pressed")}function Br(t){t.key==="Shift"&&N("#layers").removeClass("shift-pressed")}function Sr(t){vr()}function Dr(t){if(console.debug("Using globals: meta_keys, type_keys"),!tt()&&t.key!="Enter")if(t.key==z.move_relation_to_front){var e=document.elementFromPoint(le,Me);e.tagName=="circle"&&(e=e.closest("g")),Ue(e),e.onmouseout&&e.onmouseout()}else if(t.key==z.undo)ln();else if(t.key==z.redo)cn();else if(t.key==z.copy)rr();else if(t.key==z.paste)sr();else if(t.key==z.reduce_relations)on(H);else if(t.key==z.select_same_notes)Hi(),X("repeat");else if(t.key==z.naturalize_note)pn();else if(t.key==te.jump_to_next_bookmark)ke(-1);else if(t.key==te.jump_to_previous_bookmark)ke(1);else if(t.key==te.jump_to_context_below)ze(1);else if(t.key==te.jump_to_context_above)ze(-1);else if(t.key==z.deselect_all)ye();else if(t.key==z.delete_all)pt();else if(t.key==z.add_bookmark)En();else if(t.key==custom_conf.relation){t.preventDefault();var n=N("#relations_panel").hasClass("collapsed");n&&we()}else if(t.key==custom_conf.meta_relation){t.preventDefault();var n=N("#relations_panel").hasClass("collapsed");n&&we()}else Lt[t.key]?X(Lt[t.key]):wt[t.key]?Nt(wt[t.key]):Bt[t.key]?Hn(Bt[t.key]):t.key==te.toggle_palette?we():console.log(t)}function Cr(){console.debug("Using globals: non_notes_hidden"),Ie=!Ie,jr(Ie),Ie||Mn()}function jr(t){console.debug("Using globals: document for element selection"),Array.from(document.getElementsByClassName("beam")).forEach(e=>Array.from(e.children).filter(n=>n.tagName=="polygon").forEach(n=>n.classList.toggle("hidden",t))),oi.forEach(e=>Array.from(document.getElementsByClassName(e)).forEach(n=>n.classList.toggle("hidden",t)))}function G(t){var o,a;const e=t.getAttribute("type"),r=(a=(o=(t.classList.contains("relation")?yn:vn).main[e])==null?void 0:o.color)!=null?a:0,s=li.getPropertyValue(`--relation-${r}`);t.setAttribute("color",s)}function we(){N("#relations_panel").hasClass("collapsed")?(N("#relations_panel").removeClass("collapsed"),N("#relations_panel input").removeClass("none")):(N("#relations_panel").addClass("collapsed"),N("#relations_panel input").addClass("none"))}const kr=document.getElementById("relations_panel_toggle");kr.addEventListener("click",we);function ye(){selected.forEach(t=>v(t,!1)),extraselected.forEach(t=>v(t,!0))}function zr(t=null){t||(t=$()[0]);var e=Pe(),n=Wn(!0,t),i=new XMLSerializer().serializeToString(n);e.loadData(i);const r=e.renderToMIDI();var s=vo();return e.loadData(s),r}function Or(t){var e=O(),n=$();ye(),N(".relation").remove(),N(".metarelation").remove();var i=Array.from(e.getElementsByTagName("node")),r=i.filter(s=>s.getAttribute("type")=="relation");i.filter(s=>s.getAttribute("type")=="metarelation"),n.forEach(s=>{r.forEach(o=>mt(s,e,o))}),n.hullPadding=t,n.forEach(Pn),n.forEach(s=>{s.svg_elem.getRootNode().getElementById("hier"+s.id_prefix)&&an(s)})}function Ur(t){var e=0,n=0,i=0,r=0;t.onmousedown=s;function s(l){l.target.tagName!=="INPUT"&&(l=l||window.event,l.preventDefault(),i=l.clientX,r=l.clientY,document.onmouseup=a,document.onmousemove=o,typeof drag_selector!="undefined"&&drag_selector.stop())}function o(l){l=l||window.event,l.preventDefault(),e=i-l.clientX,n=r-l.clientY,i=l.clientX,r=l.clientY,i>=0&&r>=0&&(t.style.top=t.offsetTop-n+"px",t.style.left=t.offsetLeft-e+"px")}function a(){document.onmouseup=null,document.onmousemove=null,typeof drag_selector!="undefined"&&drag_selector.start()}}function Rr(t){window.drag_selector=new ii({selectables:document.getElementsByClassName("relation"),area:N("#layers")[0],draggability:!1,overflowTolerance:{x:1,y:1},autoScrollSpeed:1e-4}),drag_selector.subscribe("dragstart",({items:e,event:n,isDragging:i})=>{N(".ds-selector-area").show()}),drag_selector.subscribe("dragmove",({items:e,event:n,isDragging:i})=>{Ve==""&&!document.getElementById("minimap").classList.contains("dragging")&&((N(".ds-selector").height()>10||N(".ds-selector").width()>10)&&(N("#metadata_input, #relations_panel, #minimap").fadeOut(300),document.getElementById("layers").style.cursor="url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMjJwdCIgaGVpZ2h0PSIyMnB0IiB2aWV3Qm94PSIwIDAgMjIgMjIiIHZlcnNpb249IjEuMSI+CjxnIGlkPSJzdXJmYWNlMSI+CjxwYXRoIHN0eWxlPSIgc3Ryb2tlOm5vbmU7ZmlsbC1ydWxlOm5vbnplcm87ZmlsbDpyZ2IoMCUsMCUsMCUpO2ZpbGwtb3BhY2l0eToxOyIgZD0iTSA0LjQ0OTIxOSAxNC44MDA3ODEgQyA0LjI2OTUzMSAxNC42MjEwOTQgMy45ODA0NjkgMTQuNjIxMDk0IDMuODAwNzgxIDE0LjgwMDc4MSBDIDMuNjIxMDk0IDE0Ljk4MDQ2OSAzLjYyMTA5NCAxNS4yNjk1MzEgMy44MDA3ODEgMTUuNDQ5MjE5IEMgNS43Njk1MzEgMTcuNDE3OTY5IDUuNzY5NTMxIDE5LjI1IDMuODAwNzgxIDIxLjIxODc1IEMgMy42MjEwOTQgMjEuMzk4NDM4IDMuNjIxMDk0IDIxLjY4NzUgMy44MDA3ODEgMjEuODY3MTg4IEMgMy44OTA2MjUgMjEuOTU3MDMxIDQuMDA3ODEyIDIyIDQuMTI1IDIyIEMgNC4yNDIxODggMjIgNC4zNTkzNzUgMjEuOTU3MDMxIDQuNDQ5MjE5IDIxLjg2NzE4OCBDIDYuNzU3ODEyIDE5LjU1NDY4OCA2Ljc1NzgxMiAxNy4xMTMyODEgNC40NDkyMTkgMTQuODAwNzgxIFogTSA0LjQ0OTIxOSAxNC44MDA3ODEgIi8+CjxwYXRoIHN0eWxlPSIgc3Ryb2tlOm5vbmU7ZmlsbC1ydWxlOm5vbnplcm87ZmlsbDpyZ2IoMCUsMCUsMCUpO2ZpbGwtb3BhY2l0eToxOyIgZD0iTSA0LjEyNSAxMS45MTc5NjkgQyAzLjExMzI4MSAxMS45MTc5NjkgMi4yOTI5NjkgMTIuNzM4MjgxIDIuMjkyOTY5IDEzLjc1IEMgMi4yOTI5NjkgMTQuNzYxNzE5IDMuMTEzMjgxIDE1LjU4MjAzMSA0LjEyNSAxNS41ODIwMzEgQyA1LjEzNjcxOSAxNS41ODIwMzEgNS45NTcwMzEgMTQuNzYxNzE5IDUuOTU3MDMxIDEzLjc1IEMgNS45NTcwMzEgMTIuNzM4MjgxIDUuMTM2NzE5IDExLjkxNzk2OSA0LjEyNSAxMS45MTc5NjkgWiBNIDQuMTI1IDE0LjY2Nzk2OSBDIDMuNjIxMDk0IDE0LjY2Nzk2OSAzLjIwNzAzMSAxNC4yNTM5MDYgMy4yMDcwMzEgMTMuNzUgQyAzLjIwNzAzMSAxMy4yNDYwOTQgMy42MjEwOTQgMTIuODMyMDMxIDQuMTI1IDEyLjgzMjAzMSBDIDQuNjI4OTA2IDEyLjgzMjAzMSA1LjA0Mjk2OSAxMy4yNDYwOTQgNS4wNDI5NjkgMTMuNzUgQyA1LjA0Mjk2OSAxNC4yNTM5MDYgNC42Mjg5MDYgMTQuNjY3OTY5IDQuMTI1IDE0LjY2Nzk2OSBaIE0gNC4xMjUgMTQuNjY3OTY5ICIvPgo8cGF0aCBzdHlsZT0iIHN0cm9rZTpub25lO2ZpbGwtcnVsZTpub256ZXJvO2ZpbGw6cmdiKDAlLDAlLDAlKTtmaWxsLW9wYWNpdHk6MTsiIGQ9Ik0gMjEuNzY1NjI1IDEzLjgwODU5NCBMIDEzLjUxNTYyNSA5LjIyMjY1NiBDIDEzLjM0Mzc1IDkuMTI4OTA2IDEzLjEzNjcxOSA5LjE1MjM0NCAxMi45ODgyODEgOS4yODEyNSBDIDEyLjg0Mzc1IDkuNDEwMTU2IDEyLjc5Mjk2OSA5LjYxMzI4MSAxMi44NjcxODggOS43OTY4NzUgTCAxNi41MzEyNSAxOC45NjA5MzggQyAxNi42MDE1NjIgMTkuMTMyODEyIDE2Ljc2OTUzMSAxOS4yNSAxNi45NTMxMjUgMTkuMjUgQyAxNi45NTMxMjUgMTkuMjUgMTYuOTU3MDMxIDE5LjI1IDE2Ljk1NzAzMSAxOS4yNSBDIDE3LjE0MDYyNSAxOS4yNSAxNy4zMDg1OTQgMTkuMTQwNjI1IDE3LjM3ODkwNiAxOC45NzI2NTYgTCAxOC42ODM1OTQgMTUuOTMzNTk0IEwgMjEuNzIyNjU2IDE0LjYyODkwNiBDIDIxLjg4MjgxMiAxNC41NjI1IDIxLjk4ODI4MSAxNC40MDYyNSAyMiAxNC4yMzA0NjkgQyAyMi4wMDc4MTIgMTQuMDU4NTk0IDIxLjkxNzk2OSAxMy44OTQ1MzEgMjEuNzY1NjI1IDEzLjgwODU5NCBaIE0gMjEuNzY1NjI1IDEzLjgwODU5NCAiLz4KPHBhdGggc3R5bGU9IiBzdHJva2U6bm9uZTtmaWxsLXJ1bGU6bm9uemVybztmaWxsOnJnYigwJSwwJSwwJSk7ZmlsbC1vcGFjaXR5OjE7IiBkPSJNIDUuNjY0MDYyIDEyLjc2NTYyNSBDIDUuNTc4MTI1IDEyLjYyODkwNiA1LjQ3MjY1NiAxMi41MDc4MTIgNS4zNTU0NjkgMTIuNDAyMzQ0IEMgNS4zMzk4NDQgMTIuMzg2NzE5IDUuMzI0MjE5IDEyLjM3NSA1LjMwODU5NCAxMi4zNjMyODEgQyA1LjIxMDkzOCAxMi4yNzczNDQgNS4xMDU0NjkgMTIuMjA3MDMxIDQuOTkyMTg4IDEyLjE0NDUzMSBDIDQuOTYwOTM4IDEyLjEyODkwNiA0LjkyOTY4OCAxMi4xMDkzNzUgNC44OTg0MzggMTIuMDkzNzUgQyA0Ljc3MzQzOCAxMi4wMzUxNTYgNC42NDQ1MzEgMTEuOTg4MjgxIDQuNTA3ODEyIDExLjk1NzAzMSBDIDQuNDY4NzUgMTEuOTQ5MjE5IDQuNDI1NzgxIDExLjk0OTIxOSA0LjM4MjgxMiAxMS45NDE0MDYgQyA0LjI2OTUzMSAxMS45MjU3ODEgNC4xNTIzNDQgMTEuOTE3OTY5IDQuMDM5MDYyIDExLjkyNTc4MSBDIDMuNjMyODEyIDExLjk0NTMxMiAzLjI2NTYyNSAxMi4wOTc2NTYgMi45Njg3NSAxMi4zMzU5MzggQyAzLjE5MTQwNiAxMi40OTYwOTQgMy40MTQwNjIgMTIuNjQ4NDM4IDMuNjU2MjUgMTIuNzkyOTY5IEMgMy43NSAxMi44NDc2NTYgMy44NTkzNzUgMTIuODY3MTg4IDMuOTY4NzUgMTIuODUxNTYyIEMgNC4zNDc2NTYgMTIuNzg1MTU2IDQuNzUzOTA2IDEyLjk3NjU2MiA0LjkzNzUgMTMuMzM1OTM4IEMgNC45ODgyODEgMTMuNDMzNTk0IDUuMDcwMzEyIDEzLjUxMTcxOSA1LjE2Nzk2OSAxMy41NTA3ODEgQyA1LjQyMTg3NSAxMy42NTYyNSA1LjY4NzUgMTMuNzM4MjgxIDUuOTQ5MjE5IDEzLjgyODEyNSBDIDUuOTQ5MjE5IDEzLjgwMDc4MSA1Ljk1NzAzMSAxMy43NzczNDQgNS45NTcwMzEgMTMuNzUgQyA1Ljk1NzAzMSAxMy4zODY3MTkgNS44NDc2NTYgMTMuMDUwNzgxIDUuNjY0MDYyIDEyLjc2NTYyNSBaIE0gNS42NjQwNjIgMTIuNzY1NjI1ICIvPgo8cGF0aCBzdHlsZT0iIHN0cm9rZTpub25lO2ZpbGwtcnVsZTpub256ZXJvO2ZpbGw6cmdiKDAlLDAlLDAlKTtmaWxsLW9wYWNpdHk6MTsiIGQ9Ik0gMTMuMzgyODEyIDEzLjU1ODU5NCBDIDExLjE5MTQwNiAxMy44OTg0MzggOC44NTkzNzUgMTMuNzUgNi44MDQ2ODggMTMuMTUyMzQ0IEMgNi44NDc2NTYgMTMuMzQzNzUgNi44NzUgMTMuNTQyOTY5IDYuODc1IDEzLjc1IEMgNi44NzUgMTMuODcxMDk0IDYuODU1NDY5IDEzLjk4ODI4MSA2LjgzOTg0NCAxNC4xMDkzNzUgQyA4LjE1NjI1IDE0LjQ2ODc1IDkuNTY2NDA2IDE0LjY2Nzk2OSAxMSAxNC42Njc5NjkgQyAxMS45MjU3ODEgMTQuNjY3OTY5IDEyLjgzOTg0NCAxNC41ODIwMzEgMTMuNzM0Mzc1IDE0LjQyOTY4OCBaIE0gMTMuMzgyODEyIDEzLjU1ODU5NCAiLz4KPHBhdGggc3R5bGU9IiBzdHJva2U6bm9uZTtmaWxsLXJ1bGU6bm9uemVybztmaWxsOnJnYigwJSwwJSwwJSk7ZmlsbC1vcGFjaXR5OjE7IiBkPSJNIDExIDAgQyA0LjkzMzU5NCAwIDAgMy4yODkwNjIgMCA3LjMzMjAzMSBDIDAgOC45NDE0MDYgMC44MDQ2ODggMTAuNDkyMTg4IDIuMjM4MjgxIDExLjc1NzgxMiBDIDIuNDY4NzUgMTEuNTM5MDYyIDIuNzM4MjgxIDExLjM1NTQ2OSAzLjAzNTE1NiAxMS4yMjY1NjIgQyAxLjY3OTY4OCAxMC4xMDkzNzUgMC45MTc5NjkgOC43MzgyODEgMC45MTc5NjkgNy4zMzIwMzEgQyAwLjkxNzk2OSAzLjc5Njg3NSA1LjQ0MTQwNiAwLjkxNzk2OSAxMSAwLjkxNzk2OSBDIDE2LjU1ODU5NCAwLjkxNzk2OSAyMS4wODIwMzEgMy43OTY4NzUgMjEuMDgyMDMxIDcuMzMyMDMxIEMgMjEuMDgyMDMxIDguNzUzOTA2IDIwLjM0Mzc1IDEwLjEwMTU2MiAxOC45ODgyODEgMTEuMjE4NzUgTCAxOS44Mzk4NDQgMTEuNjg3NSBDIDIxLjIyNjU2MiAxMC40Mzc1IDIyIDguOTEwMTU2IDIyIDcuMzMyMDMxIEMgMjIgMy4yODkwNjIgMTcuMDY2NDA2IDAgMTEgMCBaIE0gMTEgMCAiLz4KPC9nPgo8L3N2Zz4K), auto"),document.elementsFromPoint(le,Me).map(r=>{switch(r.tagName){case"path":return r;case"use":return r.parentElement.parentElement;case"circle":return r.parentElement;default:return!1}}).filter(r=>{if(typeof r=="undefined"||typeof r.classList=="undefined")return!1;var s=n.shiftKey;return r.classList.contains("relation")&&!r.classList.contains("relation--filtered")&&!r.classList.contains("selectedrelation")&&!r.classList.contains("extraselectedrelation")&&!s||r.classList.contains("note")&&!r.classList.contains("selectednote")&&!r.classList.contains("extraselectednote")||r.classList.contains("metarelation")&&!r.classList.contains("selectedrelation")&&!r.classList.contains("extraselectedrelation")&&!s}).forEach(v))}),drag_selector.subscribe("callback",({items:e,event:n,isDragging:i})=>{document.getElementById("layers").style.cursor="default",N(".ds-selector-area").hide(),N("#metadata_input, #relations_panel, #minimap").fadeIn(300)})}function ce(){if(le!=null){var t=[document.elementFromPoint(le,Me)].map(e=>{if(e)switch(e.tagName){case"path":return e;case"use":return e.parentElement.parentElement;case"circle":return e.parentElement;default:return!1}}).filter(e=>typeof e=="undefined"||typeof e.classList=="undefined"?!1:e.classList.contains("relation")&&!e.classList.contains("relation--filtered")||e.classList.contains("metarelation"))[0];t=t?t.getAttribute("type"):"",t?(N(".jBox-Mouse").show(),he.setContent(t)):N(".jBox-Mouse").hide()}}function Yr(){typeof he!="undefined"&&he.destroy(),he=new ri("Mouse",{attach:"#layers",trigger:"mouseenter",onPosition:ce})}function bt(t){var e=t.svg_elem,n=t.id_prefix,i=e.getRootNode().getElementById("hier"+n);return i||(i=e.getRootNode().getElementById("tree"+n),i)?(i.parentNode.removeChild(i),!0):!1}function bn(t,e){var n=t.svg_elem,i=n.children[0].getAttribute("height"),r=n.getElementsByClassName("definition-scale")[0].getAttribute("viewBox"),s,o,a,l;t.old_viewbox?([s,o,a,l]=t.old_viewbox.split(" "),i=t.old_height):([s,o,a,l]=r.split(" "),t.old_viewbox=r,t.old_height=i),n.getElementsByClassName("definition-scale")[0].setAttribute("viewBox",[s,Number(o)-e,a,Number(l)+e].join(" "));var c=Number(i.split("p")[0]);n.children[0].setAttribute("height",c*((l-(o-e))/(l-o))+"px")}function $r(t){var e=t.svg_elem;t.id_prefix;var n=bt(t);n&&(e.getElementsByClassName("definition-scale")[0].setAttribute("viewBox",t.old_viewbox),e.children[0].setAttribute("height",t.old_height))}function _n(){document.getElementById("minimap").width=100,ni(document.querySelector("#minimap"),{viewport:null,styles:{".svg_container":"rgba(0,0,0,0.30)",".layer":"rgba(0,0,0,0.00)"},back:"rgba(0,0,0,0.30)",view:"rgba(0,0,0,0.20)",drag:"rgba(0,0,0,0.30)",interval:null})}var lt=[];function En(){if(se)if(se.classList.contains("note")){var t=se,e=document.createElementNS("http://www.w3.org/2000/svg","rect"),n=H.id_prefix?H.id_prefix:"0";e.dataset.draw_context=n,e.classList.add("bookmark"),e.setAttribute("fill","red"),e.setAttribute("width","500px"),e.setAttribute("height","1500px"),e.setAttribute("transform","translate(-120 -750)"),e.setAttribute("x",t.children[0].children[0].getAttribute("x")),e.setAttribute("y",t.children[0].children[0].getAttribute("y")),N(H.svg_elem).find(".page-margin")[0].prepend(e),lt.push(e),lt.sort(function(i,r){return i.getAttribute("x")-r.getAttribute("x")})}else return!1;else return!1}const Qr=document.getElementById("addbookmarkbutton");Qr.addEventListener("click",En);function ke(t=1){var e=x();function n(c){c.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}if(e){var i=e.id_prefix?e.id_prefix:"0",r=lt.filter(c=>c.dataset.draw_context==i),s=r.map(c=>c.getBoundingClientRect().x),o=s.findIndex(c=>c>=window.innerWidth),a=s.filter(c=>c<=0).length-1;if(t==1&&o!=-1)var l=r[o];else if(t==-1&&a!=-1)var l=r[a];else return!1;n(l)}}const Hr=document.getElementById("previousbookmarkbutton");Hr.addEventListener("click",()=>ke(-1));const Vr=document.getElementById("nextbookmarkbutton");Vr.addEventListener("click",()=>ke(1));function ze(t=1){function e(o){o.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})}var n=$().sort((o,a)=>o.view_elem.getBoundingClientRect().y-a.view_elem.getBoundingClientRect().y),i=n.map(o=>o.view_elem.getBoundingClientRect().y),r=n.map(o=>o.view_elem.getBoundingClientRect().bottom),s;if(t==1)s=r.findIndex(o=>o>window.innerHeight);else if(t==-1)s=i.filter(o=>o<0).length-1;else return!1;s!=-1&&e(n[s].view_elem)}const Fr=document.getElementById("previouscontextbutton");Fr.addEventListener("click",()=>ze(-1));const Pr=document.getElementById("nextcontextbutton");Pr.addEventListener("click",()=>ze(1));function Wr(){var t=O(),e=Array.from(document.getElementsByClassName("note")).map(i=>i.id),n=Array.from(t.getElementsByTagName("arc")).map(i=>i.getAttribute("to"));e.forEach(i=>{var r=i.replace(/(^\d+-?)/,"");n.includes(`#gn-${r}`)||document.getElementById(i).classList.add("hidden")})}function Mn(){Array.from(document.querySelectorAll("g.note")).forEach(t=>t.classList.remove("hidden"))}function qr(){Xe=!Xe,Xe?Mn():Wr()}const Zr=()=>he,Ne=()=>Ve,Nn=t=>Ve=t,x=()=>H,Gr=t=>{H==null||H.layer.layer_elem.classList.remove("layer--active"),H=t,H.layer.layer_elem.classList.add("layer--active")};function An(t,e,n){if(t.children.length==0){t.y=e;return}t.children.forEach(i=>An(i,e,n)),t.y=n+t.children.map(i=>i.y).reduce((i,r)=>i>r?i:r)}function Tn(t,e,n){t.children.length!=0&&(Math.abs(e-t.y)>n&&(t.y+=(e-n-t.y)/2),t.children.forEach(i=>Tn(i,t.y,n)))}function Fe(t){return t.children.length==0?[t]:t.children.flatMap(Fe)}function In(t){t.children.forEach(In),!(t.children.length==0||t.x!=null)&&(t.x=Kt(t.children.map(e=>e.x)))}function Xr(t,e=0,n=-500){In(t),An(t,e,n),Tn(t,t.y,n)}function xn(t,e=100){var n=Be(),i=Wt(t.label,[t.x,t.y+(t.children.length==0?e:0)]);i.style.fontFamiy="sans-serif",i.style.fontSize=e+"px",i.style.textAnchor="middle",i.classList.add("nodetext");var r=t.children.map(o=>Ft([t.x,t.y],[o.x,o.y])),s=t.children.flatMap(o=>xn(o,e));return r.forEach(o=>n.appendChild(o)),s.forEach(o=>n.appendChild(o)),n.appendChild(i),n}function Jr(t,e=25){var n=t.getBBox(),i=Li([n.x-e,n.y-e],n.width+e,n.height+e);t.parentNode.insertBefore(i,t)}function Ln(t){var e,n,i=mei.createElement("label");if(i.append(t.label),console.log(t.note_id),t.note_id){var r=mei.createElement("note");r.setAttribute("sameas","#"+t.note_id),i.appendChild(r)}return t.children.length==0?e=mei.createElement("eLeaf"):(e=mei.createElement("eTree"),n=t.children.map(Ln)),e.appendChild(i),n&&n.forEach(s=>e.appendChild(s)),e}function Kr(t){var e=O(),n=e.parentNode;n.querySelector("eTree")&&n.removeChild(n.querySelector("eTree")),n.appendChild(t)}function wn(t){var e=t.children[0],n={label:e.textContent};e.children.length!=0&&(n.note_id=e.querySelector("note").getAttribute("sameas").replace("#",""));var i=Array.from(t.children);return i.shift(),n.children=i.map(wn),n}function es(t){return wn(t)}function Bn(t,e){e.note_id&&(e.x=S(y(document,w(t,e.note_id)))[0]),e.children.forEach(n=>Bn(t,n))}function Sn(t){var e=mei.querySelector("eTree");if(!e){console.log("No tree to load");return}var n=es(e),i=JSON.stringify(n),r=document.getElementById("json-tree");r.value=i}function me(t){return JSON.parse(document.getElementById("json-tree").value)}function ts(t){var e=Fe(t);return e[0].hasOwnProperty("x")}function ns(t){var e=Fe(t);return e[0].hasOwnProperty("note_id")}function is(t){var e=me();if(!!e){var n=Ln(e);Kr(n)}}function Dn(t){var e=me();if(!!e){var n=document.getElementById("json-tree"),i=selected.concat(extraselected);selected.length==0?i=Array.from(t.svg_elem.getElementsByClassName("note")):selected.length==1?selected[0].classList.contains("relation")&&(i=relation_get_notes(selected[0]).map(a=>y(document,w(t,a.getAttribute("xml:id"))))):selected[0].classList.contains("metarelation")||selected.length>1;var r=i.map(a=>[S(a)[0],a]);r.sort((a,l)=>a[0]-l[0]);var s=Fe(e);if(s.length!=r.length){console.log("Wrong length of list, expected "+s.length+" got "+r.length);return}for(let a in s)s[a].x=r[a][0],s[a].note_id=r[a][1].id;var o=JSON.stringify(e);n.value=o,t.svg_elem.getRootNode().getElementById("tree"+t.id_prefix)&&Cn(t)}}function Cn(t,e=0,n=-1e3){var i=t.svg_elem,r=t.id_prefix;bt(t);var s=me();if(!(!s&&(console.log("No tree in input, attempting to load from XML"),Sn(),s=me(),!s))&&!(!ns(s)&&(console.log("Tree not aligned, attempting to align to selection"),Dn(t),s=me(),!s))){ts(s)||Bn(t,s),Xr(s,e,n);var o=xn(s);o.id="tree"+r,Re(i,o),Array.from(o.getElementsByTagName("text")).forEach(Jr),bn(t,-s.y)}}class rs{constructor(e){this.layers=e,this.jsonInput=document.getElementById("json-tree"),this.saveBtn=document.getElementById("json-tree-save"),this.loadBtn=document.getElementById("json-tree-load"),this.alignBtn=document.getElementById("json-tree-align")}get jsonTree(){try{return JSON.parse(this.jsonInput.value.trim())}catch{return null}}onTap({target:e}){const n=x();if(e==this.saveBtn)return is();if(e==this.loadBtn)return Sn();if(e==this.alignBtn)return Dn(n)}onSubmit(e){if(e.target.id=="json-tree-form"&&(e.preventDefault(),this.jsonTree)){const n=x();Cn(n)}}}class ss{constructor(e){this.layers=e,this.$ctn=document.getElementById("layer-menu-new"),this.$sliced=document.getElementById("layer-sliced"),this.$tied=document.getElementById("layer-tied"),this.$createBtn=document.getElementById("layer-new")}create(){fo(x(),this.$sliced.checked,this.$tied.checked)}onChange({target:e}){console.log(e)}onTap(e){!e.composedPath().includes(this.$ctn)||e.target==this.$createBtn&&(this.create(),console.log(this.layers))}}class os{constructor(e){R(this,"reduce",e=>on(e));R(this,"unreduce",e=>nr(e));this.layers=e,this.ctn=document.getElementById("layers-menu-reductions"),this.reduceBtn=document.getElementById("layers-menu-reduce"),this.unreduceBtn=document.getElementById("layers-menu-unreduce"),this.playReductionBtn=document.getElementById("layers-menu-play-reduction")}play(e){const n=zr(e);rt.loadSound(n,e.id_prefix),rt.play()}onTap(e){if(!e.composedPath().includes(this.ctn))return;const n=this.layers.getAll()[0];if(e.target==this.reduceBtn)return this.reduce(n);if(e.target==this.unreduceBtn)return this.unreduce(n);if(e.target==this.playReductionBtn)return this.play(n)}}class as{constructor(e){this.layers=e,this.on=document.getElementById("relations-tree-on"),this.off=document.getElementById("relations-tree-off"),this.drawRoots=document.getElementById("relations-tree-roots-low"),this.visible=!1,this.shouldDrawRootsLow=!1}draw(){const e=x();this.visible?an(e,50,this.shouldDrawRootsLow):$r(e)}onChange({target:e}){e.name=="relations-tree"&&(console.log(x()),this.visible=e.value=="on",this.draw()),e==this.drawRoots&&(this.shouldDrawRootsLow=e.checked,this.draw())}onScoreLoad(){this.updateToggles()}updateToggles(e=x()){console.log(e);const n=e.svg_elem.querySelector("#hier");console.log(n),this[n?"on":"off"].checked=!0}}var _e;class ls{constructor(){ee(this,_e,!1);R(this,"getAll",()=>$());this.ctn=document.getElementById("layers-menu"),this.toggleBtn=document.getElementById("layers-menu-toggle"),this.layersEls=document.getElementsByClassName("layer-new-ui"),this.visibleLayer=1,this.activeLayer=1,this.$visibleLayer=document.getElementById("visible-layer"),this.$currentLayer=document.getElementById("current-layer"),this.new=new ss(this),this.reductions=new os(this),this.tree=new as(this),this.jsonTree=new rs(this),this.previousLayerBtn=document.getElementById("layers-nav-previous"),this.nextLayerBtn=document.getElementById("layers-nav-next"),this.$saveSettingsCtn=document.getElementById("layer-menu-settings"),this.$shouldSave=document.getElementById("should-save-layer"),this.$lockBtn=document.getElementById("layer-lock"),this.initObserver()}get contexts(){return this.getAll()}onTap(e){if(!!e.composedPath().includes(this.ctn)){if(e.target==this.toggleBtn)return this.toggleVisibility();if(e.target==this.nextLayerBtn)return this.moveBy(1);if(e.target==this.previousLayerBtn)return this.moveBy(-1);if(e.target==this.$lockBtn)return this.toggleLock();this.new.onTap(e),Array.from(this.layersEls).forEach((n,i)=>{n.dataset.position=i+1}),this.addMouseListeners(),this.observe(),this.updateNavigation(),this.updateLayersCount(),this.reductions.onTap(e),this.jsonTree.onTap(e)}}onChange(e){!e.composedPath().includes(this.ctn)||(this.tree.onChange(e),this.new.onChange(e))}onScoreLoad(){this.addMouseListeners(),this.updateLayersCount(),this.tree.onScoreLoad()}toggleVisibility(e=!B(this,_e)){de(this,_e,e),this.ctn.classList.toggle("layers-menu--visible",e)}setCurrentLayer(e=1){console.log(e);const n=this.contexts.find(i=>i.layer.layer_number+1==e);n&&(Gr(n),this.$currentLayer.innerHTML=e,this.activeLayer=e,this.updateLayersCount(),this.checkLockState(n.canEdit),this.tree.updateToggles(n))}updateLayersCount(){const e=this.contexts.length==1;V.classList.toggle("has-1-layer",e),V.classList.toggle("has-many-layers",!e),this.$saveSettingsCtn.classList.toggle("layers-menu__saveSettings--hidden",e||this.activeLayer==1)}updateNavigation(){this.$visibleLayer.innerHTML=this.visibleLayer,this.previousLayerBtn.toggleAttribute("disabled",this.visibleLayer==1),this.nextLayerBtn.toggleAttribute("disabled",this.visibleLayer==this.contexts.length)}observe(){if(this.contexts.length<2)return this.contexts[0].observing=!1,this.observer.disconnect();this.contexts.filter(e=>!e.observing).forEach(e=>{e.layer.layer_elem.childElementCount==1&&e.layer.layer_elem.insertAdjacentHTML("beforeend",`<div class="layer-intersection-landmark" data-position="${e.layer.layer_number+1}"></div>`),this.observer.observe(e.layer.layer_elem.querySelector(".layer-intersection-landmark")),e.observing=!0})}initObserver(){this.observer=new IntersectionObserver(e=>{e.forEach(r=>{var o;const s=this.contexts.find(a=>r.target.dataset.position==a.layer.layer_number+1);s&&(s.visibleHeight=(o=r.intersectionRect.height)!=null?o:0)});const n=Math.max(...this.contexts.map(r=>r.visibleHeight)),i=this.contexts.find(r=>r.visibleHeight==n);this.visibleLayer=parseInt(i.layer.layer_elem.dataset.position),this.updateNavigation()},{threshold:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]})}moveBy(e=0){const n=this.visibleLayer+e;if(ae(n,1,this.contexts.length)==n){const i=this.contexts.reverse()[n-1].layer.layer_elem;this.contexts.reverse(),i.scrollIntoView()}}addMouseListeners(){}markAsCurrent(e){this.setCurrentLayer(parseInt(e.target.dataset.position))}toggleLock(e=!x().canEdit){x().canEdit=e,this.checkLockState(e)}checkLockState(e){this.$lockBtn.classList.toggle("lock-path--unlocked",e)}}_e=new WeakMap;const ct=new ls,cs=["note","relation","metarelation"];var Ee,F;class ds{constructor(){ee(this,Ee,void 0);ee(this,F,new Ti);this.loaded=!1,this.mei=null,this.layersCtn=document.getElementById("layers")}get selection(){return B(this,Ee)}set selection(e){B(this,F).clear(),de(this,Ee,e)}get flatSelection(){return B(this,F).remember("flatSelection",()=>Object.values(this.selection).flat())}get hasSelection(){return B(this,F).remember("hasSelection",()=>this.flatSelection.length>0)}get selectionType(){return B(this,F).remember("selectionType",()=>{var e;return(e=cs.find(n=>{var i;return(i=this.flatSelection[0])==null?void 0:i.classList.contains(n)}))!=null?e:null})}get selectedRelationTypes(){return B(this,F).remember("selectedRelationTypes",()=>!this.hasSelection||this.selectionType=="note"?null:new Set(this.flatSelection.map(e=>e.getAttribute("type")).filter(e=>e)))}onScoreLoad(){this.loaded=!0,this.mei=window.mei,B(this,F).clear(),ct.setCurrentLayer(1)}onScoreSelection({detail:e}){this.selection=e}onTap(e){if(!this.loaded||!e.composedPath().includes(this.layersCtn))return;const n=e.composedPath().find(i=>i.classList.contains("layer"));n&&ct.setCurrentLayer(parseInt(n.dataset.position))}}Ee=new WeakMap,F=new WeakMap;const T=new ds;class Ut{constructor(e,n){R(this,"createFilterElement",({type:e,checked:n})=>`
    <li>
        <label class="checkable color-relation-${e}" for="${this.namespace}-filter-${e}">
            ${dt(e)}
            <input class="checkable__input" type="checkbox" id="${this.namespace}-filter-${e}" data-type="${e}" ${n?"checked":""}>
            <span class="checkbox checkbox--colored">
                <svg class="checkable__icon btn__icon" width="12" height="10">
                    <use xlink:href="#check-path"/>
                </svg>
            </span>
        </label>
    </li>
  `);this.namespace=e,this.ctn=document.getElementById(n.filterCtnId),this.paths=T.layersCtn.getElementsByClassName(e),this.fields=[]}onChange(e){e.composedPath().includes(this.ctn)&&this.toggleRelationsPaths(e.target.dataset.type,e.target.checked)}toggleRelationsPaths(e,n){Array.from(this.paths).filter(i=>i.getAttribute("type")==e).forEach(i=>i.classList.toggle("relation--filtered",!n))}getRelations(){const e=new Set(Array.from(this.paths,n=>n.getAttribute("type")));this.fields=Array.from(e,n=>({type:n,checked:!0,el:null}))}hasRelationType(e){return this.fields.some(n=>n.type==e)}wasLastOfType(e){return!Array.from(this.paths).some(n=>n.getAttribute("type")==e)}render(){let e=this.fields.map(n=>this.createFilterElement(n)).join(" ");this.ctn.innerHTML=e}}class us{constructor(){R(this,"createFiltersGroups",()=>[new Ut("relation",{filterCtnId:"relations-filters"}),new Ut("metarelation",{filterCtnId:"meta-relations-filters"})]);R(this,"createMutationObserver",()=>new MutationObserver(e=>{if(e.filter(s=>s.type=="attributes"&&s.attributeName=="type").filter(s=>s.target.getAttribute("type")!=s.oldValue).length>0)return this.update();const i=e.length==1&&e.filter(s=>{var o;return s.type=="childList"&&((o=s.addedNodes)==null?void 0:o.length)==1}).map(s=>{var o;return(o=s.addedNodes)==null?void 0:o.item(0)}).find(it.isElement);if(i){const s=i.getAttribute("type");if(!this.groups.some(a=>a.hasRelationType(s)))return this.update()}const r=e.length==1&&e.filter(s=>{var o;return s.type=="childList"&&((o=s.removedNodes)==null?void 0:o.length)==1}).map(s=>{var o;return(o=s.removedNodes)==null?void 0:o.item(0)}).find(it.isElement);if(r){const s=r.getAttribute("type");if(this.groups.some(a=>a.wasLastOfType(s)))return this.update()}}));this.visible=!1,this.ctn=document.getElementById("filters"),this.toggleBtn=document.getElementById("filters-toggle"),this.observer=this.createMutationObserver(),this.groups=this.createFiltersGroups()}onTap({target:e}){e==this.toggleBtn&&this.toggle()}onChange(e){this.groups.forEach(n=>n.onChange(e))}onScoreLoad(){this.toggle(!1),this.observer.disconnect(),this.update(),this.observe()}observe(){this.observer.observe(document.querySelector("#layers .svg_container > svg .page-margin"),{subtree:!0,childList:!0,attributeOldValue:!0,attributeFilter:["type"]})}toggle(e=!this.visible){this.visible=e,this.ctn.classList.toggle("fly-out--expanded",e),this.ctn.classList.toggle("fly-out--collapsed",!e)}update(){this.groups.forEach(e=>e.getRelations()),this.groups.forEach(e=>e.render())}}const gs=new us;var ge={title:{label:"Title",saveBtn:"Update title",placeholder:"The name \u266A of the song \u266B"},roles:{composer:{label:"Composer",saveBtn:"Update composer",placeholder:"Wolfgang Amadeus Mozart"},analyst:{label:"Analyst",saveBtn:"Assign responsibility",placeholder:"Maybe\u2026 you?"},annotator:{label:"Annotator",saveBtn:"Assign responsibility",placeholder:"Maybe\u2026 you?"}}};const jn=(t,{label:e,placeholder:n=""},i="")=>`
  <label class="fillable fly-out__title" for="metadata-${t}">
      ${e}
      <input
          class="fillable__input"
          id="metadata-${t}"
          type="text"
          placeholder="${n}"
          value="${i}"
      >
  </label>
`,kn=(t,{saveBtn:e})=>`
  <button
      class="btn btn--plain btn--small"
      id="metadata-${t}-assign"
      type="button"
      data-role="${t}"
  >${e}</button>
`,hs=t=>t.map(({role:e,config:n,value:i})=>`
    <hr class="fly-out__hr">
    ${jn(e,n,i)}
    ${kn(e,n)}
  `).join(""),ms=new DOMParser,fs=new RegExp(/^metadata-(\w+)-assign$/);class ps{constructor(){this.visible=!1,this.ctn=document.getElementById("metadata"),this.toggleBtn=document.getElementById("metadata-toggle"),this.persRoles=Object.keys(ge.roles),this.formDOM={ctn:document.getElementById("metadata-form")},this.formDOM.inputs=this.formDOM.ctn.getElementsByClassName("fillable__input"),this.scoreHead={titleStmt:null,title:null,respStmt:null,respPersName:[]}}onTap({target:e}){var i;if(e==this.toggleBtn)return this.toggle();let n=(i=e.id.match(fs))==null?void 0:i[1];n&&this.updateScoreMetadata(n)}onScoreLoad(){this.initScore(),this.initFields()}toggle(e=!this.visible){this.visible=e,this.ctn.classList.toggle("fly-out--expanded",e),this.ctn.classList.toggle("fly-out--collapsed",!e)}updateScoreMetadata(e){const n=[...this.formDOM.inputs].find(({id:s})=>s=`metadata-${e}`);if(!n)return;const i=n.value;if(e=="title"){this.scoreHead.title[0].innerHTML=i;return}const r=this.persNames.find(s=>s.role==e);r.value=i,r.el.innerHTML=i,e!="composer"&&T.flatSelection.forEach(s=>{const o=b(s),a=y(T.mei,o);(a.tagName=="note"?a:a.firstChild).setAttribute("resp",e)})}initScore(){this.scoreHead.titleStmt=T.mei.querySelector("meiHead fileDesc titleStmt"),!!this.scoreHead.titleStmt&&(this.initStmtEl("title"),this.initStmtEl("respStmt"),this.initRoles())}initStmtEl(e){if(this.scoreHead[e]=this.scoreHead.titleStmt.getElementsByTagName(e),!this.scoreHead[e].length){const n=T.mei.createElement(e);this.scoreHead.titleStmt.appendChild(n)}}initRoles(){this.scoreHead.respPersName=this.scoreHead.respStmt[0].getElementsByTagName("persName"),this.persNames=Array.from(this.scoreHead.respPersName).filter(e=>this.persRoles.includes(e.getAttribute("role"))).map(e=>({el:e,role:e.getAttribute("role"),value:e.innerHTML,config:ge.roles[e.getAttribute("role")]})),this.persRoles.filter(e=>!this.persNames.find(n=>n.role==e)).forEach(e=>this.initRole(e))}initRole(e){const n=ms.parseFromString(`<persName role="${e}" xml:id="${e}" />`,"text/xml").firstChild;this.scoreHead.respStmt[0].appendChild(n),this.persNames.push({el:n,role:e,value:"",config:ge.roles[e]})}initFields(){this.formDOM.ctn.innerHTML=jn("title",ge.title,this.scoreHead.title[0].innerHTML)+kn("title",ge.title)+hs(this.persNames)}}const ys=new ps;class vs{constructor(){this.update()}onResize(){this.update()}update(){this.w=window.innerWidth,this.h=window.innerHeight}}const ve=new vs;class bs{constructor(){this.toLeftBtn=document.getElementById("to-left"),this.toRightBtn=document.getElementById("to-right")}onTap(e){if(e.target==this.toLeftBtn)return this.toLeft();if(e.target==this.toRightBtn)return this.toRight()}toLeft(){this.goTo(-(ve.w-200))}toRight(){this.goTo(ve.w-200)}goTo(e){V.scrollBy(e,0)}}const _s=new bs;class zn{constructor(e){R(this,"hide",()=>this.toggleVisibility(!1));this.ctn={el:document.getElementById(e)},this.closeBtn=this.ctn.el.querySelector(".fly-out__closeBtn"),this.visible=!1}onTap(e){if(!!e.composedPath().includes(this.ctn.el)&&e.target==this.closeBtn)return this.toggleVisibility(!1)}toggleVisibility(e=!this.visible){this.ctn.el.classList.toggle("fly-out--visible",e),this.visible=e}}function Es(t,e=null){t.preventDefault(),e&&e.call()}const Ms=10,Rt=(t,e=1)=>`${pe(t/Ms,e)}rem`,xe=10;var K;class Ns extends zn{constructor(e){super(e);ee(this,K,!1);this.dragHandle={el:this.ctn.el.querySelector(".fly-out__drag")},this.visible=!1,this.x=0,this.y=0,this.computeValues()}onTapStart(e){e.target==this.dragHandle.el&&Es(e,()=>this.toggleDragging(!0))}onTapMove(e,n){this.visible&&B(this,K)&&this.updatePosition(e,n)}onTapEnd(){this.visible&&B(this,K)&&(this.toggleDragging(!1),this.computeValues())}onResize(){!this.visible||this.computeValues()}updatePosition(e=this.x,n=this.y){this.x=e-this.ctn.handleDeltaX,this.y=n-this.ctn.handleDeltaY,this.ctn.el.style.setProperty("--fly-out-x",Rt(this.x,2)),this.ctn.el.style.setProperty("--fly-out-y",Rt(this.y,2))}toggleDragging(e=!B(this,K)){de(this,K,e),this.ctn.el.classList.toggle("fly-out--grabbing",e),V.classList.toggle("dragging-fly-out",e)}snapInViewport(){const e=ae(this.x,xe,ve.w-this.ctn.width-xe),n=ae(this.y,xe,ve.h-this.ctn.height-xe);(e!=this.x||n!=this.y)&&(this.ctn.el.classList.add("fly-out--snapping"),this.ctn.el.addEventListener("transitionend",this.onSnapTransitionEnd.bind(this)),this.updatePosition(e+this.ctn.handleDeltaX,n+this.ctn.handleDeltaY))}onSnapTransitionEnd({propertyName:e}){e=="transform"&&(this.ctn.el.classList.remove("fly-out--snapping"),this.ctn.el.removeEventListener("transitionend",this.onSnapTransitionEnd.bind(this)))}computeValues(){const e=["x","y","width","height"];Object.assign(this.ctn,jt(this.ctn.el,e)),Object.assign(this.dragHandle,jt(this.dragHandle.el,e)),this.ctn.handleDeltaX=this.dragHandle.x-this.ctn.x+this.dragHandle.width/2,this.ctn.handleDeltaY=this.dragHandle.y-this.ctn.y+this.dragHandle.height/2,this.snapInViewport()}}K=new WeakMap;const _t={hideIfCompact:"hide-when-compact",hideIfNotCompact:"hide-when-not-compact"},As=t=>`
  <div class="fly-out__headerRow">
      <div class="fly-out__title fly-out__title--big">
          ${dt(t)}s
      </div>
  </div>
`,Ts=(t,e,n)=>`
  <button
      type="button"
      class="
        btn btn--hollow btn--relation color-relation-${t}
        ${n>2?_t.hideIfCompact:""}
      "
      data-relation-name="${t}"
      data-relation-type="${e}"
  >
      ${dt(t)}
  </button>
`,Is=t=>`
  <button
      type="button"
      class="fly-out__showMore ${_t.hideIfNotCompact} | btn btn--hollow"
  >
      <span class="visually-hidden">View more ${t}</span>
      &hellip;
  </button>
`,xs=(t,e)=>`
  <form
      class="btn-group btn-group--free-field hide-when-compact"
      id="free-field-${e}-form"
  >
      ${Ls(e,{label:"Or type a "+t.name})}
      ${ws(t.additional,e)}

      <button class="btn btn--plain btn--small">
          Assign <span class="visually-hidden>${e}</span>
      </button>
  </form>
`,Ls=(t,{label:e,placeholder:n=""})=>`
  <label
      class="fillable fly-out__relationsField ${_t.hideIfCompact}"
      for="free-field-${t}"
  >
      <span class="fillable__label">
          <span class="fillable__label__text">${e}</span>
          <svg class="fillable__label__triangle | btn__icon" width="10" height="8">
              <use xlink:href="#triangle-path"/>
          </svg>
      </span>

      <input
          class="fillable__input"
          id="free-field-${t}"
          type="text"
          list="datalist-${t}"
          placeholder="${e}"
          data-relation-type="${t}"
      >
  </label>
`,ws=(t,e)=>`
  <datalist id="datalist-${e}">${Bs(t)}</datalist>
`,Bs=t=>t.map(Ss).join(""),Ss=t=>`<option value="${t}">`;var oe;class Je{constructor(e,n,i={}){ee(this,oe,!1);this.type=e,this.name=n.name,this.eventCallbacks=i,this.initHtml(n)}get isVisible(){return B(this,oe)}show(){this.toggleVisibility(!0)}hide(){this.toggleVisibility(!1)}toggleVisibility(e=!B(this,oe)){de(this,oe,e),this.ctn.classList.toggle("fly-out__relationsBtnsCtn--visible",e)}select(e){if(this.unselect(),!e)return;const n=Array.from(this.btns).filter(s=>e.has(s.dataset.relationName));if(n.forEach(s=>s.classList.add("btn--selected")),e.size<=n.length)return;const i=n.map(s=>s.dataset.relationName),r=[...e].filter(s=>!i.includes(s));this.freeFieldCtn.classList.add("fly-out__relationsField--selected"),r.length==1&&(this.freeField.value=r[0])}unselect(){Array.from(this.selectedBtns).forEach(e=>e.classList.remove("btn--selected")),this.freeFieldCtn.classList.remove("fly-out__relationsField--selected"),this.freeField.value=""}initHtml(e){var s;const n=As(e.name);let i=Object.keys(e.main).map((o,a)=>Ts(o,this.type,a)).join("");(e.main.length>3||"additional"in e)&&(i+=Is(this.type)),i=`<div class="btn-group">${i}</div>`;const r="additional"in e?xs(e,this.type):"";this.ctn=document.getElementById(`${this.type}-btns`),this.ctn.innerHTML=n+i+r,this.btns=this.ctn.getElementsByClassName("btn--relation"),this.selectedBtns=this.ctn.getElementsByClassName("btn--selected"),this.freeField=this.ctn.querySelector(`#free-field-${this.type}`),this.freeFieldCtn=(s=this.freeField)==null?void 0:s.parentElement}}oe=new WeakMap;const Ds=new RegExp(/^free-field-(\w+)-form$/);class Cs extends Ns{constructor(){super("relations-menu");this.innerCtn=document.getElementById("relations-btns-ctn"),this.deleteBtn=this.ctn.el.querySelector(".fly-out__deleteBtn"),this.init()}get visibleGroups(){return[this.relations,this.metarelations,this.comborelations].filter(({isVisible:e})=>e)}onTap(e){if(super.onTap(e),e.target==this.deleteBtn)return pt();const{dataset:n,classList:i}=e.target,r=i.contains("fly-out__compact"),s=i.contains("fly-out__showMore");if(r||s)return this.compact(r),this.computeValues();!(n==null?void 0:n.hasOwnProperty("relationType"))||i.contains("btn--relation")&&this[n.relationType].eventCallbacks.tap(n.relationName)}onSubmit(e){var r,s;const n=(r=e.target.id.match(Ds))==null?void 0:r[1];if(!n)return;e.preventDefault();const{value:i}=(s=this[n])==null?void 0:s.freeField;i&&this[n].eventCallbacks.tap(i)}onScoreSelection(){const{hasSelection:e,selectionType:n,selectedRelationTypes:i}=T;this.relations.select(n=="relation"?i:new Set),this.metarelations.select(n=="metarelation"?i:new Set),this.toggleVisibility(e),this.reorder(),this.relations.show(),this.metarelations.toggleVisibility(n!="note"),this.compact(),this.deleteBtn.disabled=!e||n=="note",T.flatSelection.length==1&&this.computeValues()}reorder(){if(T.flatSelection.length!==1)return;const e=Tr(T.selectionType);for(let n=e.length-1;n>0;n--)this.innerCtn.insertBefore(this[e[n-1]].ctn,this[e[n]].ctn)}compact(e=null){if(!T.flatSelection.length)return;e!=null&&(this.ctn.el.classList.toggle("fly-out--relations-compact",e),this.ctn.el.classList.toggle("fly-out--big",!e));const n=T.selectionType=="note"&&T.flatSelection.length>2&&T.selection.extraselected.length<3;this.comborelations.toggleVisibility(n)}init(){this.relations=new Je("relations",yn,{tap:X}),this.metarelations=new Je("metarelations",vn,{tap:Nt}),this.comborelations=new Je("comborelations",at,{tap:Hn}),this.title=this.ctn.el.querySelector(".fly-out__title")}}const js=new Cs,ks=t=>{console.log(t);const e=T.selectionType;return t.length?(e=="note"?Pi(t).map(zs):t.map(Os)).join(""):"-"},zs=t=>`<li class="selection__listItem">${t.toUpperCase()}</li>`,Os=t=>`<li class="selection__listItem">${t.getAttribute("type")}</li>`;class Us extends zn{constructor(){super("selection-legend");this.title=document.getElementById("selection-type"),this.primary=document.getElementById("selection-primary"),this.primaryList=document.getElementById("selection-list-primary"),this.secondary=document.getElementById("selection-secondary"),this.secondaryList=document.getElementById("selection-list-secondary"),this.hide()}update({selected:e,extraselected:n}){this.toggleVisibility(T.hasSelection),this.visible&&(this.updateTitle(),this.updateRow("primary",n),this.updateRow("secondary",e))}updateTitle(){this.title.innerHTML=T.selectionType?`Selected ${T.selectionType}s`:"Selection is empty"}updateRow(e,n){this[e].classList.toggle("none",!n.length),this[`${e}List`].innerHTML=ks(n)}}class Rs{constructor(){this.primary=document.getElementById("selection-mode-primary"),this.secondary=document.getElementById("selection-mode-secondary")}set(e){this.mode=e,this.updateBtns()}updateBtns(){this[this.mode].checked=!0}onChange({target:e}){e.name=="selection-mode"&&this.set(e.value)}}class Ys{constructor(){this.selectBtn=document.getElementById("select-all"),this.unselectBtn=document.getElementById("unselect-all"),this.legend=new Us,this.mode=new Rs}selectAll(){const e=x();e&&Lr(e)}selectNone(){ye()}onTap({target:e}){if(e==this.selectBtn)return this.selectAll();if(e==this.unselectBtn)return this.selectNone()}onScoreSelection(e){this.legend.update(e)}}const $s=new Ys,Ke=1,On=1.1,Qs=1/On;class Hs{constructor(){this.zoomInBtn=document.getElementById("zoom-in"),this.zoomOutBtn=document.getElementById("zoom-out"),this.resetBtn=document.getElementById("zoom-reset"),this.levelEl=document.getElementById("zoom-level")}onTap({target:e}){if(e==this.zoomInBtn)return this.in();if(e==this.zoomOutBtn)return this.out();if(e==this.resetBtn)return this.reset()}in(){this.by(On)}out(){this.by(Qs)}reset(){this.by(Ke)}by(e=1){const n=x();!n||(n.zoom=e==Ke?Ke:n.zoom*e,n.svg_elem.style.transform=`scale(${n.zoom})`,this.levelEl.innerHTML=this.format(n.zoom))}format(e){return`${Math.round(e*100)}%`}}const Vs=new Hs;class Fs{constructor(){this.btn=document.getElementById("new-note"),this.isActive=!1}toggle(){var e;this.isActive=(e=fn())!=null?e:!1,this.btn.classList.toggle("btn--something-active-for-new-note",this.isActive)}enable(){hn(),this.btn.classList.add("btn--something-active-for-new-note"),this.isActive=!0}disable(){mn(),this.btn.classList.remove("btn--something-active-for-new-note"),this.isActive=!1}onTap({target:e}){e==this.btn&&this.toggle()}}const Ps=new Fs;class Ws{constructor(e="",n){this.ctn=document.getElementById(`${e}-progress-ctn`),this.setMinMax(n),this.update(n.value)}setMinMax({min:e,max:n}){this.min=parseInt(e),this.max=parseInt(n)}update(e=this.value){e=parseFloat(e);let n=(e-this.min)/(this.max-this.min);n=pe(n,3),this.setBar(n)}setBar(e){this.ctn.style.setProperty("--progress",ae(0,e,1))}}class qs{constructor(){this.input=document.getElementById("relation-width");const{min:e,max:n,value:i}=this.input;this.progressBar=new Ws("relation-width",{min:e,max:n,value:i}),this.throttling=!1}onInput({target:e}){e!=this.input||this.throttling||(this.throttling=!0,requestAnimationFrame(()=>{const n=parseInt(e.value);this.progressBar.update(n),Or(n),this.throttling=!1}))}}const Zs=new qs,Gs=1e4;class Xs{constructor(){this.ctn=document.getElementById("player-and-score-settings"),this.toggleVisibilityBtn=document.getElementById("score-settings-toggle"),this.toggleShadesBtn=document.getElementById("settings-shades"),this.toggleStemsBtn=document.getElementById("settings-stems"),this.toggleTonesBtn=document.getElementById("settings-non-related-tones"),this.expanded=!1,this.autoCloseTimer=null,this.brightShades=!0}get interacting(){const e=this.hasInteractionWith(this.ctn),n=this.hasInteractionWith(document.activeElement);return e||n}hasInteractionWith(e){return getComputedStyle(e).getPropertyValue("--in-player-and-score-settings").trim()=="1"}startAutoCloseTimer(){clearTimeout(this.autoCloseTimer),this.autoCloseTimer=setTimeout(()=>{if(this.interacting)return this.startAutoCloseTimer();this.toggleVisibility(!1)},Gs)}onTap(e){if(!e.composedPath().includes(this.ctn))return this.toggleVisibility(!1);if(this.startAutoCloseTimer(),e.target==this.toggleVisibilityBtn)return this.toggleVisibility(!0);if(e.target==this.toggleShadesBtn)return this.toggleShades();if(e.target==this.toggleStemsBtn)return this.toggleStems();if(e.target==this.toggleTonesBtn)return qr()}toggleVisibility(e=!this.expanded){this.expanded=e,V.classList.toggle("ui-score-settings-visible",e)}toggleShades(e=!this.brightShades){this.brightShades=e,V.classList.toggle("shades-alternate",!e)}toggleStems(){Cr()}}const Js=new Xs;class Ks{constructor(){this.ctn=document.getElementById("ui"),this.init()}onTap(e){var n,i,r,s,o,a,l,c,d,h;(n=this.relations)==null||n.onTap(e),(i=this.scoreSettings)==null||i.onTap(e),!!e.composedPath().includes(this.ctn)&&((r=this.mainMenu)==null||r.onTap(e),(s=this.zoom)==null||s.onTap(e),(o=this.selection)==null||o.onTap(e),(a=this.metadata)==null||a.onTap(e),(l=this.navigation)==null||l.onTap(e),(c=this.filters)==null||c.onTap(e),(d=this.newNote)==null||d.onTap(e),(h=this.layersMenu)==null||h.onTap(e))}onTapStart(e){var n;(n=this.relations)==null||n.onTapStart(e)}onTapMove(e,n){var i;(i=this.relations)==null||i.onTapMove(e,n)}onTapEnd(){var e;(e=this.relations)==null||e.onTapEnd()}onResize(){var e;(e=this.relations)==null||e.onResize()}onScoreLoad(e){var n,i,r;(n=this.filters)==null||n.onScoreLoad(e),(i=this.metadata)==null||i.onScoreLoad(e),(r=this.layersMenu)==null||r.onScoreLoad(e)}onScoreSelection({detail:e}){var n,i;(n=this.selection)==null||n.onScoreSelection(e),(i=this.relations)==null||i.onScoreSelection()}init(){this.startScreen=Mi,this.mainMenu=Ai,this.zoom=Vs,this.selection=$s,this.navigation=_s,this.metadata=ys,this.filters=gs,this.relations=js,this.newNote=Ps,this.relationWidth=Zs,this.scoreSettings=Js,this.layersMenu=ct}}const eo=new Ks;class to{constructor(){this.undoBtn=document.getElementById("undo"),this.redoBtn=document.getElementById("redo"),this.updateBtns(0,0)}onTap({target:e}){if(e==this.undoBtn)return this.undo();if(e==this.redoBtn)return this.redo()}undo(){ln()}redo(){cn()}updateBtns(e=0,n=0){this.undoBtn.toggleAttribute("disabled",e==0),this.redoBtn.toggleAttribute("disabled",n==0)}onUndoRedo({detail:e}){this.updateBtns(e.undoAbleCount,e.redoAbleCount)}}const no=new to;class io{constructor(){this.init()}init(){V.classList.replace("loading","ready"),this.viewport=ve,yi(this),this.ui=eo,this.score=T,this.player=rt,this.history=no}}const Ae=new io;function Un(t,e,n){const i=new Blob([t],{type:n}),r=document.createElement("a");r.style.display="none",r.href=URL.createObjectURL(i),r.download=e,document.body.appendChild(r),r.click(),setTimeout(()=>{URL.revokeObjectURL(r.href),r.remove()},0)}function ro(t,e,n,i,r){var s=[],o=t.getRootNode().createElement("node");o.setAttribute("type","relation");var a=t.getRootNode().createElement("label");typeof i!="undefined"&&a.setAttribute("type",i),o.appendChild(a);var l;typeof r=="undefined"?l="he-"+ut(5):l=r,o.setAttribute("xml:id",l),t.appendChild(o),s.push(o);for(var c=0;c<e.length;c++){var d=mei.createElement("arc");d.setAttribute("from","#"+l),d.setAttribute("to","#"+e[c].getAttribute("xml:id")),d.setAttribute("type","primary"),t.appendChild(d),s.push(d)}for(var c=0;c<n.length;c++){var d=mei.createElement("arc");d.setAttribute("from","#"+l),d.setAttribute("to","#"+n[c].getAttribute("xml:id")),d.setAttribute("type","secondary"),t.appendChild(d),s.push(d)}return[l,s.reverse()]}function so(t,e,n,i,r){var s=[],o=t.getRootNode().createElement("node");o.setAttribute("type","metarelation");var a=t.getRootNode().createElement("label");typeof i!="undefined"&&a.setAttribute("type",i),o.appendChild(a);var l;typeof r=="undefined"?l="he-"+Math.floor(Math.random()*(1<<20)).toString(16):l=r,o.setAttribute("xml:id",l),t.appendChild(o),s.push(o);for(var c=0;c<e.length;c++){var d=t.getRootNode().createElement("arc");d.setAttribute("from","#"+l),d.setAttribute("to","#"+e[c].getAttribute("xml:id")),d.setAttribute("type","primary"),t.appendChild(d),s.push(d)}for(var c=0;c<n.length;c++){var d=t.getRootNode().createElement("arc");d.setAttribute("from","#"+l),d.setAttribute("to","#"+n[c].getAttribute("xml:id")),d.setAttribute("type","secondary"),t.appendChild(d),s.push(d)}return[l,s.reverse()]}function oo(t,e,n){const i=n.findIndex(s=>s.nodeType==Node.ELEMENT_NODE&&(s.tagName=="note"||s.getElementsByTagName("note").length>0))==-1;if((e.tagName=="beam"||e.tagName=="measure")&&i)return null;if(e.tagName=="chord"&&i)return Xi(mei,e);var r=e.cloneNode();return t?r.setAttribute("corresp",e.getAttribute("xml:id")):r.setAttribute("copyof",e.getAttribute("xml:id")),n.forEach(s=>r.appendChild(s)),r}function Rn(t,e){if(e.nodeType!=Node.ELEMENT_NODE)return[e.cloneNode(),!1];var n=document.getElementById(w(t,b(e)));if(e.tagName=="note"&&(!n||n.classList.contains("hidden")))return[Zi(mei,e),!0];var i=Array.from(e.childNodes).map(o=>Rn(t,o)),r=i.map(o=>o[0]).filter(o=>o!=null),s=r.length!=e.childNodes.length||i.find(o=>o[1])!=null;return[oo(s,e,r),s]}function ao(t=null){t||(t=$()[0]);var e=t.mei_score,[n,i]=Rn(t,e),r=e.parentElement.getElementsByTagName("score").length,s=r+"-";return ft(n,s),e.parentNode.insertBefore(n,e.nextSibling),n}function Et(t,e){if(!t.contains(e))return console.log("Score element not in MEI, aborting"),null;var n=Ji(t),i;e.hasAttribute("xml:id")?i=y(n,e.getAttribute("xml:id")):i=n.getElementsByTagName("score")[0];var r=i.parentElement;for(let s of Array.from(r.getElementsByTagName("score")))s!==i&&r.removeChild(s);return n}function lo(t,e,n=!1){var i=Pe(),r=Wn(!0,t),s=new XMLSerializer().serializeToString(r);i.loadData(s),i.renderToMIDI();var o=Array.from(r.getElementsByTagName("note")),a=o.map(_=>_.getAttribute("xml:id")),l={};if(a.forEach(_=>{if(!_)return;let A=i.getTimeForElement(_);l[A]?l[A].push(_):l[A]=[_]}),n){let _=Object.keys(l);l={},_.forEach(A=>l[A]=i.getElementsAtTime(Number(A)+1).notes)}var c=e.getElementsByTagName("scoreDef")[0].cloneNode(!0),d=c.getElementsByTagName("staffDef"),h=mei.createElement("score");h.setAttribute("xml:id",e.getAttribute("xml:id")+"-sliced");var u=mei.createElement("section");u.setAttribute("xml:id",e.getAttribute("xml:id")+"-slicedsection"),h.appendChild(c),h.appendChild(u);var g=Object.keys(l);console.log(l);for(var m in g){let _=g[m],A=l[_],M=mei.createElement("measure");M.setAttribute("xml:id","measure-"+_),u.appendChild(M);for(var p of d){let E=mei.createElement("staff");E.setAttribute("n",p.getAttribute("n")),M.appendChild(E)}A.forEach(E=>{let D=y(mei,E),U=D.cloneNode(!0);U.setAttribute("corresp",E);let Gn=D.closest("staff").getAttribute("n"),Tt=D.closest("layer").getAttribute("n"),It=D.closest("chord"),qe=M.querySelector('staff[n="'+Gn+'"]');qe||(console.log("Could not find staff"),abort());let J=qe.querySelector('layer[n="'+Tt+'"]');if(J||(J=mei.createElement("layer"),J.setAttribute("n",Tt),qe.appendChild(J)),U.removeAttribute("dots"),U.removeAttribute("dots.ges"),It){let q=It.getAttribute("xml:id"),Z=J.querySelector('chord[corresp="'+q+'"]');Z||(Z=mei.createElement("chord"),Z.setAttribute("corresp",q),Z.setAttribute("dur",4),Z.setAttribute("dur.ges",4),Z.setAttribute("dur.ppq",2),J.appendChild(Z)),Z.appendChild(U)}else U.setAttribute("dur",4),U.setAttribute("dur.ges",4),U.setAttribute("dur.ppq",2),J.appendChild(U);if(m>0&&l[g[m-1]].includes(E)){U.setAttribute("xml:id",_+E);let q=mei.createElement("tie");q.setAttribute("xml:id","tie"+_+E),q.setAttribute("endid",_+E),m>1&&l[g[m-2]].includes(E)?q.setAttribute("startid",g[m-1]+E):q.setAttribute("startid",E),M.appendChild(q)}});for(var f of M.querySelectorAll("staff"))if(!f.querySelector("note")){let E=f.querySelector("layer");E||(E=mei.createElement("layer"),f.appendChild(E));let D=mei.createElement("rest");D.setAttribute("dur",4),D.setAttribute("dur.ges",4),D.setAttribute("dur.ppq",2),E.appendChild(D)}}return h}function co(t,e=!1){var n=t.mei_score,i=lo(t,n,e),r=n.parentElement.getElementsByTagName("score").length,s=r+"-";return ft(i,s),n.parentNode.insertBefore(i,n.nextSibling),i}function Yn(t,e,n){var i=[],r=t.svg_elem,s=t.id_prefix,o=s+n.getAttribute("xml:id"),a=gt(n),l=$e(e,n).map(u=>document.getElementById(w(t,j(u)))),c=P(e,n).map(u=>document.getElementById(w(t,j(u)))),d=l.concat(c);if(d.sort((u,g)=>{if(!u)return-1;if(!g)return 1;var m=S(u),p=S(g);return m[0]-p[0]?m[0]-p[0]:m[1]-p[1]}),!d[0])return console.log("Note missing, relation not drawn"),null;var h=Vt(d.map(S));return h.setAttribute("id",o),s!=""&&h.setAttribute("oldid",n.getAttribute("xml:id")),h.classList.add("relation"),h.setAttribute("type",a),G(h),Ae.ui.scoreSettings.brightShades||G(h),h.addEventListener("wheel",u=>{u.preventDefault(),Ue(u.target),u.target.onmouseout()},C),h.onclick=()=>v(h),h.onmouseover=function(){l.forEach(u=>u.classList.add("extrahover")),c.forEach(u=>u.classList.add("selecthover"))},h.onmouseout=function(){l.forEach(u=>u.classList.remove("extrahover")),c.forEach(u=>u.classList.remove("selecthover"))},Re(r,h),i.push(h),i}function $n(t,e,m){var i=[],r=t.svg_elem,s=t.id_prefix,o=s+m.getAttribute("xml:id"),a=gt(m),l=Ye(e,m).map(p=>document.getElementById(t.id_prefix+b(p))),c=$e(e,m).map(p=>document.getElementById(w(t,j(p)))),d=P(e,m).map(p=>document.getElementById(w(t,j(p))));if(l.indexOf(null)!=-1)return console.log("Missing relation, not drawing metarelation"),[];var h=l.map(Fi),u=Kt(h.map(p=>p[0])),g=l.concat([r.getElementsByClassName("system")[0]]).map(p=>p.getBBox().y).sort((p,f)=>p>f)[0]-500;h.push([u,g]);var m=Be();return m.style.setProperty("--shade-alternate","#000"),m.setAttribute("id",o),m.classList.add("metarelation"),m.setAttribute("type",a),m.appendChild(Pt([u,g],200)),h.forEach(p=>{var f=Ft([u,g],p);m.appendChild(f)}),G(m),Ae.ui.scoreSettings.brightShades||G(m),m.addEventListener("wheel",p=>{p.preventDefault(),Ue(p.target.closest("g")),p.target.onmouseout()},C),m.onclick=()=>v(m),m.onmouseover=function(p){c.forEach(f=>{f.classList.contains("relation")?f.classList.add("extrarelationhover"):f.children[0].classList.add("extrarelationhover")}),d.forEach(f=>{f.classList.contains("relation")?f.classList.add("relationhover"):f.children[0].classList.add("relationhover")})},m.onmouseout=function(p){c.forEach(f=>{f.classList.contains("relation")?f.classList.remove("extrarelationhover"):f.children[0].classList.remove("extrarelationhover")}),d.forEach(f=>{f.classList.contains("relation")?f.classList.remove("relationhover"):f.children[0].classList.remove("relationhover")})},Re(r,m),i.push(m),i}window.selected=[];window.extraselected=[];var ie;window.mei=null;var I,Yt,Qn,re,et=new FileReader,fe,be=[],Mt=[],L=[],Oe=[];window.addEventListener("beforeunload",function(t){var e="Leave app? You may lose unsaved changes.";return t.preventDefault(),t.returnValue=e,e});N(document).ready(function(){document.getElementsByTagName("html")[0].classList.remove("loader"),Ur(document.getElementById("relations_panel")),_n(),po()});window.onerror=function(e,n,i){return document.getElementsByTagName("html")[0].classList.remove("loader"),alert(`An error occured: ${e}
 Please report the relevant console log as a GitHub issue.
 The app will try to continue running nonetheless.`),!1};function X(t,e,n=!1){if(console.debug("Using globals: selected, extraselected, mei, undo_actions"),!(selected.length==0&&extraselected==0)){var i,r;if(selected.concat(extraselected)[0].classList.contains("relation")){var s=[];selected.concat(extraselected).forEach(d=>{s.push([d.getAttribute("type"),t]);var h=Ce(d),u=[y(document,h)].concat(Zt(document,h));u.forEach(m=>m.setAttribute("type",t));var g=y(mei,h);g.getElementsByTagName("label")[0].setAttribute("type",t),u.forEach(G)}),be.push(["change relation type",s.reverse(),selected,extraselected])}else if(selected.concat(extraselected)[0].classList.contains("note")){er(t,extraselected,selected);var o=[],a=extraselected.map(d=>Ot(I,d)),l=selected.map(d=>Ot(I,d));o.push(a.concat(l)),[i,r]=ro(I,a,l,t,e),o.push(r);for(var c=0;c<L.length;c++){let d=Yn(L[c],I,y(I.getRootNode(),i));d&&(o.push(d),ht(L[c],I,y(I.getRootNode(),i)))}be.push(["relation",o.reverse(),selected,extraselected]),selected.concat(extraselected).forEach(v)}n||He(),ce()}}function Hn(t){var e=selected.concat(extraselected);if(!(e.length<3||extraselected.length>2)){e.sort((r,s)=>{var[o,a]=S(r),[l,c]=S(s);return o-l});var n=e.shift(),i=e.pop();selected=selected.filter(r=>r==n||r==i),X(at.main[t].outer),extraselected=[n,i],selected=e,X(at.main[t].total),ce()}}function Nt(t,e,n=!1){if(console.debug("Using globals:  mei_graph, selected, extraselected"),!(selected.length==0&&extraselected==0)){var i=W(selected.concat(extraselected)[0]);if(i=="relation"||i=="metarelation"){var r=[],a,l,s=extraselected.map(d=>y(I.getRootNode(),Ce(d))),o=selected.map(d=>y(I.getRootNode(),Ce(d))),[a,l]=so(I,s,o,t,e);r.push(l);for(var c=0;c<L.length;c++)r.push($n(L[c],I,y(I.getRootNode(),a)));be.push(["metarelation",r,selected,extraselected]),selected.concat(extraselected).forEach(v),ce(),n||He()}}}var Vn;function uo(){console.debug("Using globals: mei");var t=mei.getElementsByTagName("graph");if(t.length)return t[0];var e=mei.createElement("graph");return e.setAttribute("type","directed"),mei.getElementsByTagName("body")[0].appendChild(e),e}function go(){var t=mei.cloneNode(!0);for(var e of L)if(!e.canSave){console.log("Trying to remove layer",e);var n=y(t,e.mei_score.getAttribute("xml:id"));n.parentElement.removeChild(n),console.log("Found and tried to remove ",n)}var i=new XMLSerializer().serializeToString(t);Un(i,fe+".mei","text/xml")}function ho(){var t=new XMLSerializer().serializeToString(N("#svg_output")[0]);Un(t,fe+".svg","text/xml")}function Fn(t){console.debug("Using globals: selected_extraselected, upload, reader, filenmae");const e=t.target.files;selected=[],extraselected=[],e.length==1&&(et.onload=function(n){re=et.result,mo(),Yr()},et.readAsText(e[0]),fe=e[0].name.split(".").slice(0,-1).join("."),fe==""&&(fe=e[0].name))}function Pn(t){console.debug("Using globals: mei_graph, mei, selected, extraselected, document");var e=Array.from(I.getElementsByTagName("node")),n=e.filter(r=>r.getAttribute("type")=="relation"),i=e.filter(r=>r.getAttribute("type")=="metarelation");n.forEach(r=>{Yn(t,I,r)&&ht(t,I,r)}),i.forEach(r=>$n(t,I,r))}function mo(t){console.debug("Using globals data, parser, mei, jquery document, document, mei_graph, midi, changes, undo_cations, redo_actions, reduce_actions, rerendered_after_action");var e=new DOMParser;try{mei=e.parseFromString(re,"text/xml"),mei.getElementsByTagName("parsererror").length>0&&console.log("This is not a valid XML or MEI file. However it could be ABC or Humdrum, for instance")}catch{N("#score-file-picker").val("")}if(ie=new verovio.toolkit,mei.documentElement.namespaceURI!="http://www.music-encoding.org/ns/mei"){try{let l=ie.renderData(re,{pageWidth:2e4,pageHeight:1e4,breaks:"none"})}catch{if(!new_svg)return console.log("Verovio could not generate SVG from non-MEI file."),N("#score-file-picker").val(""),!1}re=ie.getMEI(),e=new DOMParser;try{mei=e.parseFromString(re,"text/xml")}catch{return alert("Cannot parse this XML file as valid MEI."),N("#score-file-picker").val(""),!1}}else mei=Wi(mei);try{I=uo()}catch{return alert("Cannot parse this XML file as valid MEI."),N("#score-file-picker").val(""),!1}L=[],Oe=[],document.getElementById("layers").innerHTML="",L.hullPadding=200;var n=Array.from(mei.getElementsByTagName("body")[0].getElementsByTagName("score"));for(let l in n){let c=n[l],d=Et(mei,c),[h,u]=Zn(d);if(!u)return console.log("Verovio could not generate SVG from MEI."),!1;var i=tn(),[r,s]=nn(i);s.innerHTML=u;var o={mei:d,layer_elem:i,layer_number:0,score_elem:c,id_mapping:je(c),number_of_views:1};const g=l==0;Oe.push(o);var a={mei_score:c,svg_elem:s,view_elem:r,layer:o,layer_number:0,id_prefix:"",zoom:1,reductions:[],forceSaveLayer:g,lockLayer:g,canSave:!0,canEdit:!g};g?(Yt=ie.renderToMIDI(),Qn=Yt):a.id_prefix=L.length,qn(a)}return be=[],Mt=[],Vn=0,Ae.ui.scoreSettings.toggleShades(!0),document.onkeypress=function(l){Dr(l)},document.onkeydown=wr,document.onkeyup=Br,document.getElementById("layers").onclick=Sr,document.dispatchEvent(new Event("scoreload")),Rr(),!0}function Wn(t=!1,e=L[0]){e.svg_elem;var n=Et(mei,e.layer.score_elem);return Array.from(n.getElementsByTagName("note")).forEach(i=>{let r=document.getElementById(w(e,b(i)));if(!r||r.classList.contains("hidden")){var s=i.parentNode;if(t&&!["chord","bTrem","fTrem"].includes(s.tagName)){var o=qi(n,i);s.insertBefore(o,i)}s.removeChild(i)}}),Array.from(n.getElementsByTagName("chord")).forEach(i=>{i.parentNode,i.getElementsByTagName("note").length==0&&i.parentNode.removeChild(i)}),n}function fo(t,e=!1,n=!1){var i;e?i=co(t,n):i=ao(t);let r=Et(mei,i);var[s,o]=Zn(r);if(!o)return console.log("Verovio could not generate SVG from MEI."),!1;var a=tn(),[l,c]=nn(a);c.innerHTML=o;var d={mei:r,layer_elem:a,layer_number:Oe.length,score_elem:i,id_mapping:je(i),number_of_views:1};Oe.push(d);var h={mei_score:i,svg_elem:c,view_elem:l,layer:d,layer_number:d.layer_number,id_prefix:"",zoom:1,reductions:[],forceSaveLayer:!1,lockLayer:!1,canSave:!0,canEdit:!0};h.id_prefix=L.length,qn(h)}function qn(t){t.measure_map=lr(t),L.reverse(),L.push(t),L.reverse();for(let e of t.svg_elem.getElementsByClassName("note"))e.onclick=()=>v(e);console.groupCollapsed("notes output from `pitch_grid()`");for(let e of t.svg_elem.getElementsByClassName("staff")){let[n,i]=hr(e);e.y_to_p=n,e.p_to_y=i}console.groupEnd(),Pn(t),_n()}function Zn(t){var e=new XMLSerializer().serializeToString(Ki(t)),n=ie.renderData(e,{pageWidth:2e4,pageHeight:1e4,breaks:"none"});return[e,n]}function po(){[["add_bookmark","addbookmarkbutton"],["jump_to_next_bookmark","previousbookmarkbutton"],["jump_to_previous_bookmark","nextbookmarkbutton"],["jump_to_context_below","previouscontextbutton"],["jump_to_context_above","nextcontextbutton"]].forEach(e=>document.getElementById(e[1]).setAttribute("title",si[e[0]]||te[e[0]]||z[e[0]]))}console.log("Main webapp library is loaded");const $=()=>L,O=()=>I,yo=()=>Qn,Pe=()=>ie,vo=()=>re,We=()=>be,At=()=>Mt,bo=t=>Mt=t,_o=()=>Vn;
