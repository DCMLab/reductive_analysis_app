var ni=Object.defineProperty;var ii=(t,e,n)=>e in t?ni(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var U=(t,e,n)=>(ii(t,typeof e!="symbol"?e+"":e,n),n),wt=(t,e,n)=>{if(!e.has(t))throw TypeError("Cannot "+n)};var S=(t,e,n)=>(wt(t,e,"read from private field"),n?n.call(t):e.get(t)),ne=(t,e,n)=>{if(e.has(t))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(t):e.set(t,n)},ge=(t,e,n,i)=>(wt(t,e,"write to private field"),i?i.call(t,n):e.set(t,n),n);import"./app.9e857949.js";import{S as ri,i as si,p as oi,$ as E,a as ai,D as li,j as ci}from"./vendor.273dcb72.js";const Bt={},St={},Dt={},z={undo:"U",redo:"I",deselect_all:"d",delete_all:"D",add_bookmark:"^",move_relation_to_front:"z",reduce_relations:"r",select_same_notes:"+",naturalize_note:"Z",copy:"C",paste:"V"},ie={pan_left:"[",pan_right:"]",jump_to_next_bookmark:"{",jump_to_previous_bookmark:"}",jump_to_context_below:",",jump_to_context_above:".",toggle_palette:"-",switch_context_on_hover:!1},di={relation:"R",meta_relation:"M"},ui=["barLineAttr","fermata","rest","stem","flag","tie","artic","slur","dynam","tempo","tupletNum","dir","verse"],gi=[],V=document.documentElement,hi=getComputedStyle(V),it=()=>["INPUT","SELECT","TEXTAREA"].includes(document.activeElement.tagName),mi=(t,e)=>{var n;return(n=e==null?void 0:e.every(i=>t==null?void 0:t.includes(i)))!=null?n:!1},fi=Object.freeze({shift:16,control:17,escape:27,left:37,right:39,a:65,h:72,s:83,x:88,z:90}),Q=({keyCode:t},e)=>t===fi[e];function he(t,e=null){const n=rt(t);return e?mi(n,[e].flat()):!!n.length}function rt({metaKey:t,shiftKey:e,ctrlKey:n,altKey:i}){const r={meta:t,shift:e,ctrl:n,alt:i};return Object.keys(r).filter(s=>r[s])}const Xe=/Macintosh/.test(navigator.userAgent)?"meta":"ctrl";function Ct(t){let e=!1,n=Object.defineProperty({},t,{get:()=>{e=!0}});try{window.addEventListener("test",n,n),window.removeEventListener("test",n,n)}catch{e=!1}return e}const pi=function({capture:t=!1,passive:e=!0,once:n=!1}={}){return yi.capture?{capture:t,passive:e,once:n}:t},yi={passive:Ct("passive"),capture:Ct("capture")},C=pi({capture:!0,passive:!1});let Ie=null;const Je={x:0,y:0};class vi{tick({x:e,y:n},i){Ie||window.requestAnimationFrame(r=>{this.update(e,n);const s=Ie;Ie=null,s(Je)}),Ie=i}update(e,n){Je.x=e,Je.y=n}}const jt=new vi,bi=100;let kt=null;function _i(t,e=bi){clearTimeout(kt),V.classList.add("resizing"),kt=setTimeout(()=>{V.classList.remove("resizing"),t()},e)}class Ei{constructor(e){this.app=e,this.init()}init(){window.addEventListener("resize",this.onResize.bind(this)),document.addEventListener("click",this.onTap.bind(this),C),document.addEventListener("mousedown",this.onTapStart.bind(this),C),document.addEventListener("mousemove",this.onMouseMove.bind(this),C),document.addEventListener("mouseup",this.onTapEnd.bind(this),C),document.addEventListener("touchstart",this.onTapStart.bind(this),C),document.addEventListener("touchmove",this.onTouchMove.bind(this),C),document.addEventListener("touchend",this.onTapEnd.bind(this),C),document.addEventListener("keydown",this.onKeyDown.bind(this)),document.addEventListener("keyup",this.onKeyUp.bind(this)),document.addEventListener("change",this.onChange.bind(this),C),document.addEventListener("input",this.onInput.bind(this),C),document.addEventListener("submit",this.onSubmit.bind(this),C),document.addEventListener("undoredo",this.onUndoRedo.bind(this)),document.addEventListener("scoreload",this.onScoreLoad.bind(this)),document.addEventListener("scoreselection",this.onScoreSelection.bind(this))}onResize(){_i(()=>{var e,n;(e=this.app.viewport)==null||e.onResize(),(n=this.app.ui)==null||n.onResize()})}onTap(e){var n,i,r,s;(n=this.app.score)==null||n.onTap(e),(i=this.app.player)==null||i.onTap(e),(r=this.app.ui)==null||r.onTap(e),(s=this.app.history)==null||s.onTap(e)}onTapStart(e){var n;(n=this.app.ui)==null||n.onTapStart(e)}onTapEnd(){var e;(e=this.app.ui)==null||e.onTapEnd()}onMouseMove(e){jt.tick(e,({x:n,y:i})=>{var r;(r=this.app.ui)==null||r.onTapMove(n,i)})}onTouchMove(e){const n={x:Math.round(e.touches[0].clientX),y:Math.round(e.touches[0].clientY)};jt.tick(n,({x:i,y:r})=>{var s;(s=this.app.ui)==null||s.onTapMove(i,r)})}onChange(e){var n,i,r,s,o,a,c,l,d,m,u,g;(n=this.app.player)==null||n.onChange(e),(r=(i=this.app.ui)==null?void 0:i.filters)==null||r.onChange(e),(o=(s=this.app.ui)==null?void 0:s.mainMenu)==null||o.onChange(e),(c=(a=this.app.ui)==null?void 0:a.startScreen)==null||c.onChange(e),(m=(d=(l=this.app.ui)==null?void 0:l.selection)==null?void 0:d.mode)==null||m.onChange(e),(g=(u=this.app.ui)==null?void 0:u.layersMenu)==null||g.onChange(e)}onInput(e){var n,i;(i=(n=this.app.ui)==null?void 0:n.relationWidth)==null||i.onInput(e)}onSubmit(e){var n,i,r,s,o;(i=(n=this.app.ui)==null?void 0:n.relations)==null||i.onSubmit(e),(o=(s=(r=this.app.ui)==null?void 0:r.layersMenu)==null?void 0:s.jsonTree)==null||o.onSubmit(e)}onUndoRedo(e){var n;(n=this.app.history)==null||n.onUndoRedo(e)}onScoreLoad(e){var n,i,r;(n=this.app.score)==null||n.onScoreLoad(e),(i=this.app.ui)==null||i.onScoreLoad(e),(r=this.app.player)==null||r.reset(),this.app.ui.startScreen&&(this.app.ui.startScreen.destroy(),delete this.app.ui.startScreen)}onScoreSelection(e){var n,i;(n=this.app.score)==null||n.onScoreSelection(e),(i=this.app.ui)==null||i.onScoreSelection(e)}onKeyDown(e){if(!it()){if(Q(e,"z")){if(he(e,[Xe,"shift"]))return this.app.history.redo();if(he(e,Xe))return this.app.history.undo()}if(Q(e,"a")&&he(e,Xe))return this.app.ui.selection.selectAll();if(Q(e,"control")&&rt(e).length===1)return this.app.ui.newNote.enable();if(Q(e,"shift")&&rt(e).length===1)return this.app.ui.selection.mode.set("primary");if(!he(e)){if(Q(e,"h"))return this.app.ui.scoreSettings.toggleShades();if(Q(e,"s"))return this.app.ui.scoreSettings.toggleStems();if(Q(e,"x"))return this.app.ui.newNote.toggle()}}}onKeyUp(e){if(Q(e,"control"))return this.app.ui.newNote.disable();if(Q(e,"shift"))return this.app.ui.selection.mode.set("secondary");he(e)||Q(e,"escape")&&it()&&document.activeElement.blur()}}var Mi=t=>new Ei(t);const zt=(t,e=null)=>{const n={},i=t.getBoundingClientRect();for(const r in i)(!e||e.includes(r))&&(n[r]=i[r]);return n};class st{}U(st,"isElement",e=>e.nodeType==1);const Vt=(t,e)=>{Object.entries(e).forEach(([n,i])=>{if(i==null)return t.removeAttribute(n);t.setAttribute(n,i)})},ce=(t,e,n)=>Math.max(e,Math.min(n,t)),ve=(t,e=0)=>(e=10**e,Math.round(t*e)/e);class Ni{constructor(e=""){this.ctn=document.getElementById(`${e}-progress-ctn`),this.el=document.getElementById(`${e}-progress`),this.doneEl=document.getElementById(`${e}-progress-done`),this.maxEl=document.getElementById(`${e}-progress-max`),this.reset()}update(e=this.done,n=this.max){if(n<=0)return this.reset();this.done=e,this.max=n,this.el.max=n,this.el.value=e,this.el.innerHTML=`${e} / ${n}`;const i=ve(this.el.position,3);this.setBar(i),this.updateLabel()}setBar(e){this.ctn.style.setProperty("--progress",ce(0,e,1))}updateLabel(){this.doneEl.innerHTML=this.formatTime(this.done),this.maxEl.innerHTML=this.formatTime(this.max)}formatTime(e){e=ve(e);const n=Math.floor(e/60);return e=e%60,`${Ot(n)}:${Ot(e)}`}reset(){this.el.innerHTML="",this.el.removeAttribute("value"),this.el.removeAttribute("max"),this.setBar(0),this.done=0,this.max=0}}const Ot=(t,e=2)=>t.toString().padStart(e,"0"),Ut=new AudioContext;let k;class Ai{constructor(){this.midiId=null,this.playhead=0,this.instrument,this.status="paused",this.activeNotes={},this.ctn=document.getElementById("player"),this.playPauseBtn=document.getElementById("player-play-pause"),this.stopBtn=document.getElementById("player-stop"),this.timelineRange=document.getElementById("player-timeline-input"),this.init()}loadSound(e,n=""){this.midiId!=n&&(this.stop(),this.midiId=n),k.loadDataUri(`data:audio/midi;base64,${e}`)}onTap({target:e}){if(e==this.playPauseBtn){if(k.isPlaying())return this.pause();const n=Mo();return this.midiId!="original"&&this.loadSound(n,"original"),this.play()}e==this.stopBtn&&this.status!="stopped"&&this.stop()}onChange({target:e}){e==this.timelineRange&&k.skipToSeconds(e.value).play()}updateProgress(){let e=k.getSongTime(),n=k.getSongTimeRemaining();(isNaN(e)||isNaN(n))&&(e=0,n=0),n=ce(n,0,e);const i=ve(e-n,2);this.progressBar.update(i,e),this.timelineRange.setAttribute("max",e),this.timelineRange.setAttribute("value",i)}play(){this.playhead&&k.skipToTick(this.playhead),k.play(),this.updateControls("playing")}stop(){k.stop(),this.instrument.stop(),this.updateProgress(),this.playhead=0,this.updateControls("stopped")}pause(){this.playhead=k.getCurrentTick(),this.instrument.stop(),k.pause(),this.updateControls("paused")}updateControls(e){this.status=e;let n=e=="playing"?"Pause":"Play";n=this.playPauseBtn.dataset[`label${n}`],Vt(this.playPauseBtn,{title:n,ariaLabel:n}),["stopped","playing","paused"].forEach(i=>this.ctn.classList.toggle(`player--${i}`,e==i))}init(){ri.instrument(Ut,"/instruments/acoustic-grand-piano-mp3.js").then(e=>{this.instrument=e,k=new si.Player(n=>{var r;const i=n.noteName+n.track;n.name=="Note on"&&n.velocity>0?this.activeNotes[i]=e.play(n.noteNumber,Ut.currentTime,{gain:n.velocity/127}):(n.name=="Note off"||n.name=="Note on"&&n.velocity==0)&&((r=this.activeNotes[i])==null||r.stop()),this.updateProgress()}),k.on("endOfFile",()=>this.stop())}),this.updateControls("stopped"),this.progressBar=new Ni("player")}reset(){this.stop(),this.midiId=null,this.activeNotes={}}}const ot=new Ai;class xi{constructor(){this.ctn=document.getElementById("start-screen"),this.filePicker=document.getElementById("start-screen-score-file-picker"),this.init()}init(){document.getElementById("start-screen-loading-spinner").remove()}onChange(e){e.composedPath().includes(this.filePicker)&&Gn(e)}destroy(){this.ctn.addEventListener("transitionend",this.ctn.remove,{once:!0}),this.ctn.classList.add("start-screen--out")}}const Ti=new xi;class Ii{constructor(){this.visible=!1,this.ctn=document.getElementById("main-menu"),this.toggleBtn=document.getElementById("main-menu-toggle"),this.filePicker=document.getElementById("score-file-picker"),this.saveFile=document.getElementById("save-file"),this.saveAsSvg=document.getElementById("save-file-svg")}onTap({target:e}){if(e==this.toggleBtn)return this.toggle();if(e==this.saveFile)return yo();e==this.saveAsSvg&&vo()}onChange(e){e.composedPath().includes(this.filePicker)&&(Gn(e),this.toggle(!1))}toggle(e=!this.visible){this.visible=e,this.ctn.classList.toggle("fly-out--expanded",e),this.ctn.classList.toggle("fly-out--collapsed",!e)}}const Li=new Ii,gt=t=>t[0].toUpperCase()+t.slice(1);class wi extends Map{constructor(){super(...arguments);U(this,"add",(e,n)=>this.has(e)?this:this.set(e,n));U(this,"remember",(e,n)=>(typeof n=="function"&&(n=this.has(e)?this.get(e):n()),this.add(e,n),n))}}var at=function(t,e){return[t*e[0],t*e[1]]},re=function(t,e){return[t[0]+e[0],t[1]+e[1]]},Pt=function(t,e){var n=[t[1]-e[1],e[0]-t[0]],i=Math.sqrt(n[0]*n[0]+n[1]*n[1]);return[n[0]/i,n[1]/i]},Ft=function(t,e){const n=[t[0][0],t[0][1]-e],i=[t[0][0],parseInt(t[0][1])+parseInt(e)];return`M ${n} A `+[e,e,"0,0,0",i].join(",")+" A "+[e,e,"0,0,0",n].join(",")},Wt=function(t,e){var n=at(e,Pt(t[0],t[1])),i=at(-1,n),r=re(t[0],n),s=re(t[1],n),o=re(t[1],i),a=re(t[0],i);return`M ${r} L ${s} A `+[e,e,"0,0,0",o].join(",")+` L ${a} A `+[e,e,"0,0,0",r].join(",")},Bi=function(t,e){if(!t||t.length<1)return"";if(t.length===1)return Ft(t,e);if(t.length===2)return Wt(t,e);for(var n=new Array(t.length),i=0;i<n.length;++i){var r=i===0?t[t.length-1]:t[i-1],s=t[i],o=at(e,Pt(r,s));n[i]=[re(r,o),re(s,o)]}var a="A "+[e,e,"0,0,0,"].join(",");return n=n.map(function(c,l){var d="";if(l===0)var d="M "+n[n.length-1][1]+" ";return d+=a+c[0]+" L "+c[1],d}),n.join(" ")};function qt(t){var e=Y(),n=e.hullPadding||200,i=document.createElementNS("http://www.w3.org/2000/svg","path");return i.style.setProperty("--shade-alternate",Si()),t.length==1?i.setAttribute("d",Ft(t,n)):t.length==2?i.setAttribute("d",Wt(t,n)):i.setAttribute("d",Bi(oi(t),n)),i}function Si(){const t="456789AB";let e="#";for(let n=0;n<6;n++)e+=t[Math.floor(Math.random()*t.length)];return e}function Zt(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg","line");return n.setAttribute("x1",t[0]),n.setAttribute("y1",t[1]),n.setAttribute("x2",e[0]),n.setAttribute("y2",e[1]),n.style.stroke="#000",n.style.strokeWidth="15px",n}function Gt(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg","circle");return n.setAttribute("cx",t[0]),n.setAttribute("cy",t[1]),n.setAttribute("r",e),n.style.stroke="#000",n.style.strokeWidth="15px",n}function Di(t,e,n){var i=document.createElementNS("http://www.w3.org/2000/svg","rect");return i.setAttribute("x",t[0]),i.setAttribute("y",t[1]),i.setAttribute("width",e),i.setAttribute("height",n),i.style.stroke="#000",i.style.fill="white",i.style.strokeWidth="15px",i}function Xt(t,e){var n=document.createElementNS("http://www.w3.org/2000/svg","text");return e&&(n.setAttribute("x",e[0]),n.setAttribute("y",e[1])),n.append(t),n}function Ci(t,e,n,i=0){var r=document.createElementNS("http://www.w3.org/2000/svg","tspan");return r.setAttribute("x",e[0]),r.setAttribute("dx",i),r.setAttribute("dy",n),r.append(t),r}function Ye(t){var e=es();t.parentElement.prepend(t),e.close(),e.open()}function $e(t,e){var n=t.getElementsByClassName("system")[0],i=n.parentNode;i.insertBefore(e,n)}function De(){var t=document.createElementNS("http://www.w3.org/2000/svg","g");return t}function ht(t=5){return Math.floor(Math.random()*(1<<t*4)).toString(16)}function Ce(t,e){var n=qe();return n.getMIDIValuesForElement(_(t)).pitch-n.getMIDIValuesForElement(_(e)).pitch}function je(t,e){var n=qe();return n.getMIDIValuesForElement(_(t)).time-n.getMIDIValuesForElement(_(e)).time}function ji(t){var e=t;e=e.sort(Ce),e=e.sort(je);var n=e.map(i=>({p_off:Ce(i,e[0]),t_off:je(i,e[0]),n_from:i}));return n}function ki(t,e,n,i){for(var r=t.closest("measure"),s=[];r;){let o=!0,a=r.querySelectorAll("note");for(let c of a){let l=je(c,t);if(l>=0&&l<=i){console.log("in time");let d=Ce(c,t);d>=e&&d<=n&&(console.log("in pitch"),o=!1,s.push(c))}}o?r=null:r=Jt(r)}return s}function Jt(t){return t.nextElementSibling&&t.nextElementSibling.tagName=="measure"?t.nextElementSibling:t.nextElementSibling?Jt(t.nextElementSibling):null}function D(t){return[t.getElementsByTagName("use")[0].x.animVal.value+100,t.getElementsByTagName("use")[0].y.animVal.value]}function Kt(t,e){e[0]=="#"&&(e=e.slice(1));var n=t.querySelectorAll("[*|oldid='"+e+"']");return n?Array.from(n):Array.from(t.all).find(i=>i.getAttribute("oldid")==e)}function y(t,e){if(!e)return null;e[0]=="#"&&(e=e.slice(1));var n=t.querySelector("[*|id='"+e+"']");return n||Array.from(t.getElementsByTagName("*")).find(i=>i.getAttribute("id")==e||i.getAttribute("xml:id")==e)}const ke=t=>{var e;return(e=t.getAttribute("oldid"))!=null?e:t.id};function _(t){if(document.contains(t))return t.hasAttribute("oldid")?_(document.getElementById(t.getAttribute("oldid"))):t.id;if(t.hasAttribute("xml:id")){if(t.hasAttribute("sameas"))return _(y(mei,t.getAttribute("sameas")));if(t.hasAttribute("corresp"))return _(y(mei,t.getAttribute("corresp")));if(t.hasAttribute("copyof"))return _(y(mei,t.getAttribute("copyof")));if(t.hasAttribute("xml:id"))return t.getAttribute("xml:id")}}function B(t,e){if(!!e){e[0]=="#"&&(e=e.slice(1));var n=zi(t.layer,e),i=document.getElementById(n);if(t.svg_elem.contains(i))return n;if(n)return t.id_prefix+n}}function zi(t,e){e[0]=="#"&&(e=e.slice(1));var n=t.id_mapping.find(i=>i[1]==e);return n?n[0]:e}function Oi(t){return console.debug("Using global: mei to find element"),Array.from(mei.getElementsByTagName("arc")).filter(e=>e.getAttribute("from")=="#"+t||e.getAttribute("to")=="#"+t).length>0}function j(t){return t.getElementsByTagName("label")[0].children.length==0?t.getAttribute("xml:id"):t.getElementsByTagName("label")[0].getElementsByTagName("note")[0].getAttribute("corresp").replace("#","")}function Ui(t,e){return(t%e+e)%e}function en(t,e){return(t+e)/2}function Ri(t){if(console.debug("Using globals: document, mei to find element"),document.contains(t)&&(t=y(mei,_(t))),t.hasAttribute("accid.ges"))return t.getAttribute("accid.ges");if(t.hasAttribute("accid"))return t.getAttribute("accid");if(t.children.length==0)return"";var e=t.getElementsByTagName("accid");if(e.length==0)return"";var n=e[0];return n.hasAttribute("accid.ges")?n.getAttribute("accid.ges"):n.hasAttribute("accid")?n.getAttribute("accid"):""}function Yi(t){var e=O();t=y(mei,_(t));var n=Qe(e,t),i=n.map(j).map(r=>y(mei,r));return i}function tn(t){var e=O();t=y(mei,_(t));var n=He(e,t),i=n.map(j).map(o=>y(mei,o)),r=q(e,t),s=r.map(j).map(o=>y(mei,o));return[i,s]}function Qe(t,e){var n=Array.from(t.getElementsByTagName("arc")),i=[];return n.forEach(r=>{r.getAttribute("from")=="#"+e.getAttribute("xml:id")&&i.push(y(t.getRootNode(),r.getAttribute("to")))}),i}function He(t,e){var n=Array.from(t.getElementsByTagName("arc")),i=[];return n.forEach(r=>{r.getAttribute("from")=="#"+e.getAttribute("xml:id")&&r.getAttribute("type")=="primary"&&i.push(y(t.getRootNode(),r.getAttribute("to")))}),i}function q(t,e){var n=Array.from(t.getElementsByTagName("arc")),i=[];return n.forEach(r=>{r.getAttribute("from")=="#"+e.getAttribute("xml:id")&&r.getAttribute("type")=="secondary"&&i.push(y(t.getRootNode(),r.getAttribute("to")))}),i}function mt(t){return t.children.length==0?"":t.children[0].getAttribute("type")}function Rt(t,o){var n=_(o),i=_(y(mei,n)),r=y(t.getRootNode(),"gn-"+i);if(r!=null)return r;r=t.getRootNode().createElement("node");var s=t.getRootNode().createElement("label"),o=t.getRootNode().createElement("note");return o.setAttribute("corresp","#"+i),r.appendChild(s),s.appendChild(o),r.setAttribute("xml:id","gn-"+i),t.appendChild(r),r}function $i(t,e){var n=y(t.svg_elem.getRootNode(),B(t,j(e)));return n&&t.svg_elem.contains(n)&&n.classList.add("hidden"),n}function Qi(t,e){var n=y(t.svg_elem.getRootNode(),"hier"+B(t,j(e)));return n&&t.svg_elem.contains(n)&&n.classList.add("hidden"),n}function Hi(t,e){var n=y(t.svg_elem.getRootNode(),t.id_prefix+e.getAttribute("xml:id"));return n&&t.svg_elem.contains(n)&&n.classList.add("hidden"),n}function Vi(t,e){var n=y(t.svg_elem.getRootNode(),"hier"+t.id_prefix+e.getAttribute("xml:id"));return n&&t.svg_elem.contains(n)&&n.classList.add("hidden"),n}function Pi(t){if(!t){console.log("Not a note");return}if(t.classList.contains("secondarynote")){var e=getComputedStyle(t).getPropertyValue("--how-secondary");t.style.setProperty("--how-secondary",e*2)}else t.classList.add("secondarynote"),t.style.setProperty("--how-secondary",2)}function Fi(t){if(!t){console.log("Not a note");return}var e=getComputedStyle(t).getPropertyValue("--how-secondary");t.style.setProperty("--how-secondary",e/2),e/2==1&&t.classList.remove("secondarynote")}function ft(t,e,n){t.svg_elem,n.tagName!="node"&&(n=y(e.getRootNode(),n.id));var i=q(e,n);i.forEach(r=>{var s=document.getElementById(B(t,j(r)));Pi(s)})}function pt(t,e,n){t.svg_elem,n.tagName!="node"&&(n=y(e.getRootNode(),n.id));var i=q(e,n);i.forEach(r=>{var s=document.getElementById(B(t,j(r)));Fi(s)})}function nn(t){return t.tagName=="measure"?t:nn(t.parentElement)}function Wi(){if(console.debug("Using globals: document, mei to find elems"),(selected.length==1||extraselected.length==1)&&!(selected.length==1&&extraselected.length==1)){var t;selected.length==1?t=selected[0]:t=extraselected[0];var e=y(mei,t.getAttribute("id")),n=nn(e),i=Array.from(n.getElementsByTagName("note"));i.forEach(r=>{r.getAttribute("oct")==e.getAttribute("oct")&&r.getAttribute("pname")==e.getAttribute("pname")&&b(y(document,r.getAttribute("xml:id")))}),b(t,!0)}}function Z(t){return typeof t=="undefined"?!1:t.classList.contains("note")?"note":t.classList.contains("relation")?"relation":t.classList.contains("metarelation")?"metarelation":""}function qi(t){var e=t.getBBox();return[e.x+e.width/2,e.y+e.height/2]}function Zi(t){if(t.classList.contains("metarelation")){var e=t.getElementsByTagName("circle")[0];return[e.cx.baseVal.value,e.cy.baseVal.value]}else return t.classList.contains("relation")?qi(t):(console.log("wtf"),console.log(t),[0,0])}function rn(t){return t.reduce((e,n)=>e+n,0)/t.length}function sn(t){var e=y(mei,t);if(e.tagName=="node")return e.children[0].getAttribute("type");var n=Ri(e);return n=n.replace(/s/g,"#"),n=n.replace(/f/g,"b"),n=n.replace(/n/g,""),e.getAttribute("pname")+n+e.getAttribute("oct")}function Gi(t){if(t.length==0)return"";if(t[0].classList.contains("note"))return t.sort((e,n)=>{const[i,r]=D(e),[s,o]=D(n);return i-s==0?o-r:i-s}),t.map(e=>sn(_(e)))}function Xi(t){return Array.from(t.getElementsByTagName("node")).forEach(e=>{e.getAttribute("type")=="hyperedge"&&e.setAttribute("type","relation"),e.getAttribute("type")=="metaedge"&&e.setAttribute("type","metarelation")}),t}function on(t){Array.from(t.children).forEach(on);let e=t.hasAttribute("sameas")?"sameas":t.hasAttribute("copyof")?"copyof":"";e&&(t.closest("graph")||t.closest("eTree")||y(mei,t.getAttribute(e)).closest("score")!=t.closest("score"))&&(t.setAttribute("corresp",t.getAttribute(e)),t.removeAttribute(e))}function Ji(t){Array.from(t.getElementsByTagName("mdiv")).forEach(e=>{let n=/(\d+)-.*/,i=/-sliced$/,r=Array.from(e.children).filter(o=>o.tagName=="score");if(r.length>1){e.getAttribute("xml:id");for(scix in r){if(scix==0)continue;let o=r[scix],a=o.getAttribute("xml:id");if(n.test(a)){let c=n.exec(a)[1],l=c+"-"+l;var s=t.createElement("mdiv");i.test(a)?s.setAttribute("xml:id",c+"-"+l+"-sliced"):s.setAttribute("xml:id",c+"-"+l),e.parentElement.append(s),s.append(o)}}}})}var Ve=["dur","n","dots","when","layer","staff","tstamp.ges","tstamp.real","tstamp","loc","dur.ges","dots.ges","dur.metrical","dur.ppq","dur.real","dur.recip","beam","fermata","tuplet"];function Ki(t,e){var n=t.createElementNS("http://www.music-encoding.org/ns/mei","rest");n.setAttribute("xml:id","rest-"+e.getAttribute("xml:id"));for(let i of Ve)e.hasAttribute(i)&&n.setAttribute(i,e.getAttribute(i));return n}function er(t,e){var n=t.createElementNS("http://www.music-encoding.org/ns/mei","space");n.setAttribute("xml:id","space-"+e.getAttribute("xml:id"));for(let i of Ve)e.hasAttribute(i)&&n.setAttribute(i,e.getAttribute(i));return n}function tr(t,e){var n=t.createElementNS("http://www.music-encoding.org/ns/mei","chord");n.setAttribute("xml:id","chord-"+e.getAttribute("xml:id"));for(const i of Ve)e.hasAttribute(i)&&n.setAttribute(i,e.getAttribute(i));return n}function nr(t,e){var n=t.createElementNS("http://www.music-encoding.org/ns/mei","space");n.setAttribute("xml:id","space-"+e.getAttribute("xml:id"));for(let i of Ve)e.hasAttribute(i)&&n.setAttribute(i,e.getAttribute(i));return n}function yt(t,e){t.id&&(t.setAttribute("oldid",t.id),t.id=e+t.id),t.getAttribute("xml:id")&&t.setAttribute("xml:id",e+t.getAttribute("xml:id")),t.getAttribute("startid")&&t.setAttribute("startid",e+t.getAttribute("startid")),t.getAttribute("endid")&&t.setAttribute("endid",e+t.getAttribute("endid")),Array.from(t.children).forEach(n=>yt(n,e))}function ir(t){var e=t.implementation.createDocument(t.namespaceURI,null,null),n=e.importNode(t.documentElement,!0);return e.appendChild(n),e}function ze(t){var e;return t.id?e=[t.id,_(t)]:t.hasAttribute("xml:id")&&(e=[t.getAttribute("xml:id"),_(t)]),e?[e].concat(Array.from(t.children).flatMap(ze)):Array.from(t.children).flatMap(ze)}function an(){var t=document.getElementById("layers"),e=document.createElement("div");return e.id="layer"+t.children.length,e.classList.add("layer"),e.classList.add("layer-new-ui"),t.appendChild(e),e}function ln(t){var e=Y(),n=document.createElement("div");n.id="view"+e.length,n.classList.add("view");var i=document.createElement("div");return i.id="svg"+e.length,i.classList.add("svg_container"),n.appendChild(i),t.appendChild(n),[n,i]}function rr(t){var e=t;return gi.forEach(n=>{Array.from(t.getElementsByTagName(n)).forEach(i=>{i.parentNode.removeChild(i)})}),e}function sr(t,e,n){var i=O(),r=e.map(a=>a.getAttribute("id").replace(/(^\d+-?)/,"gn-")).sort((a,c)=>a<c),s=n.map(a=>a.getAttribute("id").replace(/(^\d+-?)/,"gn-")).sort((a,c)=>a<c),o=Array.from(i.querySelectorAll("[type='relation']")).filter(a=>a.children[0].getAttribute("type")==t);return o.forEach(a=>{var c=tn(a),l=c[0],d=c[1];if(l=l.map(m=>m.getAttribute("xml:id")).sort((m,u)=>m<u),d=d.map(m=>m.getAttribute("xml:id")).sort((m,u)=>m<u),JSON.stringify(r)==JSON.stringify(l)&&JSON.stringify(s)==JSON.stringify(d))return alert(`Warning: This relation already exists.
Creating a duplicate anyway.`),!1}),!0}function cn(t){return Y().find(e=>e.svg_elem.contains(t))}function dn(t,e,n){var i=e.map(s=>He(t,s)).flat();e=e.filter(s=>!n.includes(s)),i=i.concat(e.map(s=>q(t,s)).flat());do{var r=n.filter(s=>q(t,s).findIndex(o=>i.includes(o))>-1);e=e.concat(r),n=n.filter(s=>!r.includes(s)),i=i.concat(r.map(s=>q(t,s)).flat())}while(r.length>0);return[n,[...new Set(n.flatMap(s=>q(t,s)))]]}function un(t){var e=O();or(t,e,selected,extraselected)}function or(t,e,n,i){var r=n.concat(i),s=r.map(u=>y(e.getRootNode(),_(u))),o=Array.from(e.getElementsByTagName("node")).filter(u=>u.getAttribute("type")=="relation"),a=o.filter(u=>{var g=y(document,t.id_prefix+u.getAttribute("xml:id"));return g!=null&&!g.classList.contains("hidden")});s.length==0&&(s=a);var[c,l]=dn(e,a,s),d=[];d.push(c.map(u=>Hi(t,u))),d.push(l.map(u=>$i(t,u))),d.push(c.map(u=>Vi(t,u))),d.push(l.map(u=>Qi(t,u)));var m=[c,l,d];t.reductions.push(["reduce",m,n,i])}function ar(t){console.log("Using globals: selected/extraselected");var e=t.reductions;if(e.length==0){console.log("Nothing to unreduce");return}selected.forEach(l=>b(l,!1)),extraselected.forEach(l=>b(l,!0));var[n,i,r,s]=e.pop(),[o,a,c]=i;c.flat().forEach(l=>{l&&l.classList.remove("hidden")}),r.forEach(l=>b(l,!1)),s.forEach(l=>b(l,!0))}function lr(t,e,n=!0){var i=O(),r=[],s=e,o=t.filter(l=>l!=null);do{let l=[];n&&(l=o.filter(d=>!s.find(m=>Qe(i,m).includes(d))));var[a,c]=dn(i,s,s);l=l.concat(c.filter(d=>o.includes(d))),r.push(l),o=o.filter(d=>!l.includes(d)),s=s.filter(d=>!a.includes(d))}while(c.length+a.length>0);return r.push(o),r}function gn(t,e=200,n=!0){var i=t.svg_elem,r=t.id_prefix;Et(t);var s=De();s.id="hier"+r;var o=Array.from(i.getElementsByClassName("note")).map(_).map(g=>y(mei,g)).map(_).map(g=>y(mei,"gn-"+g)).filter(g=>g!=null),a=Array.from(i.getElementsByClassName("relation")).map(_).map(g=>y(mei,g)),c=lr(o,a,n),l=0,d=500,m=c.flatMap((g,h)=>g.map(p=>{let f=document.getElementById(B(t,j(p))),[L,x]=D(f);return[p,[L,l-d*h]]})),u={};m.forEach(([g,h])=>{let p=e<100?50:e/2,f=p<100?200:p>200?400:p*2,L=j(g),x=u[h],v,N=[h[0]+p+10,h[1]+p+25-f];if(x)v=x.getElementsByTagName("text")[0];else{x=De();let A=Gt(h,p);x.appendChild(A),x.id="hier"+r+L,v=Xt("",N),v.style.fontFamiy="sans-serif",v.style.fontSize=f+"px",v.classList.add("nodetext"),x.appendChild(v),s.appendChild(x),u[h]=x}let $=Ci(sn(L),N,f);v.appendChild($)}),a.forEach(g=>{let h=r+g.getAttribute("xml:id"),p=mt(g),f=document.getElementById(h),x=Qe(O(),g).map(N=>m.find($=>$[0]==N)[1]),v=qt(x);v.setAttribute("id","hier"+h),r!=""&&v.setAttribute("oldid",s.getAttribute("xml:id")),v.classList.add("relation"),v.setAttribute("type",p),J(v),Te.ui.scoreSettings.brightShades||J(v),v.onclick=N=>b(f),v.onmouseover=function(){f.classList.add("relationhover"),f.onmouseover()},v.onmouseout=function(){f.classList.remove("relationhover"),f.onmouseout()},v.addEventListener("wheel",N=>{N.preventDefault(),Ye(N.target),N.target.onmouseout()},C),s.appendChild(v)}),$e(i,s),An(t,c.length*d)}var R={};function cr(){let t=selected.concat(extraselected);if(t.length==0||!t[0].classList.contains("relation")){console.log("No relation selected");return}let e=t.flatMap(i=>Yi(y(mei,_(i))));R={template:ji(e),rels:t}}function dr(){if(!R){console.log("No copy to paste");return}let t=selected.concat(extraselected);if(t.length!=1||!t[0].classList.contains("note")){console.log("Pasting requires selecting a single note, for now.");return}let e=y(mei,_(t[0])),n=R.template.map(l=>l.p_off);n=n.sort((l,d)=>l-d);let i=ki(e,n[0],n[n.length-1],R.template[R.template.length-1].t_off);R.template.forEach(l=>l.n_to=void 0);for(var r of i){let l=je(r,e),d=Ce(r,e);for(var s of R.template)if(l==s.t_off&&d==s.p_off){if(s.n_to!=null){console.log("Template mismatch: Found two matching notes: ",s,r);return}s.n_to=r}}for(var o of R.template)if(o.n_to==null){console.log("Template mismatch: No matching note found: ",o);return}const a=cn(t[0]);b(t[0]);for(var c of R.rels){let l=y(mei,_(c)),[d,m]=tn(l);for(let u of d){let g=R.template.find(p=>p.n_from==u),h=y(document,B(a,_(g.n_to)));b(h,!0)}for(let u of m){let g=R.template.find(p=>p.n_from==u),h=y(document,B(a,_(g.n_to)));b(h)}K(c.getAttribute("type"))}}function ur(t){console.debug("Using globals: mei for element selection");var e=_(t),n=y(mei,e),i=[],r=Z(t)=="metarelation",s=O(),o=Y();for(const d of o){let m=y(document,d.id_prefix+e);m&&(i.push(m),r||pt(d,s,n))}var a=Array.from(mei.getElementsByTagName("arc")).filter(d=>d.getAttribute("to")=="#"+t.id||d.getAttribute("from")=="#"+t.id),c=a.concat(i);c.push(n);var l=c.map(d=>{var m=[d,d.parentElement,d.nextSibling];try{E(`g #${d.getAttribute("to").substring(4)}`).removeClass().addClass("note")}catch{}return d.parentElement.removeChild(d),m});return ue(),l}function vt(t=!1){console.debug("Using globals: selected for element selection, undo_actions for storing the action");var e=selected.concat(extraselected);if(e.length==0||!(Z(e[0])=="relation"||Z(e[0])=="metarelation")){console.log("No (meta)relation selected!");return}var n=e.flatMap(ur),i=Ze();i.push(["delete relation",n.reverse(),selected,extraselected]),e.forEach(b),t||Pe()}function hn(){console.debug("Using globals: undo_actions, selected, extraselected, mei, rerendered_after_action");var t=Ze();if(t.length==0){console.log("Nothing to undo");return}if(t.length==xo()){console.log("Cannot undo past a rerender"),alert("Cannot undo past a rerender.");return}selected.forEach(g=>b(g,!1)),extraselected.forEach(g=>b(g,!0));var e=Y(),n=Tt();const[i,r,s,o]=t.pop();if(i=="edges"||i=="relation"||i=="metarelation"){var a=r;let g,h,p=a.flat().find(f=>f.tagName=="node"&&f.getAttribute("type")==i);if(p)g=p.getAttribute("xml:id"),p.children.length>0&&(h=p.children[0].getAttribute("type"));else{console.log("Could not find graph element of (meta)relation to undo: ",r);return}if(i=="relation")for(const f of e)pt(f,O(),p);a.flat().forEach(f=>{Oi(f.getAttribute("xml:id"))||f.parentNode.removeChild(f)}),Array.from(document.querySelectorAll('[oldid="'+g+'"]')).forEach(f=>f.parentNode.removeChild(f)),s.forEach(f=>b(document.getElementById(f.id),!1)),o.forEach(f=>b(document.getElementById(f.id),!0)),n.push([i,[h,g],s,o])}else if(i=="delete relation"){var c=r;c.forEach(g=>{g[1].insertBefore(g[0],g[2]);let h=e.find(f=>f.svg_elem.contains(g[0])),p=Z(g[0])=="relation";if(h&&p){let f=_(g[0]),L=y(mei,f);ft(h,O(),L)}}),s.forEach(g=>b(g,!1)),o.forEach(g=>b(g,!0)),n.push([i,[],s,o])}else if(i=="change relation type"){var l=r;let g=r[0][1];s.concat(o).forEach(h=>{var[p,f]=l.pop(),L=ke(h),x=[y(document,L)].concat(Kt(document,L));x.forEach(N=>N.setAttribute("type",p));var v=y(mei,L);v.getElementsByTagName("label")[0].setAttribute("type",p),x.forEach(J)}),s.forEach(h=>b(h,!1)),o.forEach(h=>b(h,!0)),n.push([i,g,s,o])}else if(i=="add note"){var[d,m]=r;m.forEach(L=>L.parentNode.removeChild(L));let g=d[0].getAttribute("pname"),h=d[0].getAttribute("oct"),p=d[0].getAttribute("xml:id"),f=s[0];if(d[0].parentNode.removeChild(d[0]),d.length>1){var u=d[1];u.parentNode.insertBefore(u.children[0],u),u.parentNode.removeChild(u)}n.push([i,[g,h,f,p],s,o])}ue(),bt()}function Pe(){Ao([]),bt()}function mn(){var t=Tt();if(t.length==0){console.log("Nothing to redo");return}selected.forEach(a=>b(a,!1)),extraselected.forEach(a=>b(a,!0));const[e,n,i,r]=t.pop();i.forEach(a=>b(document.getElementById(a.id),!1)),r.forEach(a=>b(document.getElementById(a.id),!0));let s,o;switch(e){case"relation":[s,o]=n,K(s,o,!0);break;case"metarelation":[s,o]=n,xt(s,o,!0);break;case"change relation type":s=n,K(s,"",!0);break;case"delete relation":vt(!0);break;case"add note":let[a,c,l,d]=n;yn(a,c,l,d,!0),b(i[0]);break}bt()}function bt(){document.dispatchEvent(new CustomEvent("undoredo",{detail:{redoAbleCount:Tt().length,undoAbleCount:Ze().length}}))}var lt="cdefgab";function gr(){var t=M(),e=t.svg_elem.children[0],n=t.svg_elem.getElementsByClassName("system")[0],i=e.createSVGPoint();return i.x=Sr(),i.y=Dr(),i.matrixTransform(n.parentElement.getScreenCTM().inverse())}function hr(t){let e=t.svg_elem;var n=Array.from(e.getElementsByClassName("measure"));n.length&&Array.from(n[0].getElementsByClassName("staff")),Array.from(e.getElementsByClassName("note"));var i=n.map(r=>[r.getBBox().x+r.getBBox().width,r]);return i.sort((r,s)=>r[0]-s[0]),i}function mr(t,e){let n=t.measure_map.find(i=>i[0]>e.x);if(n)return n[1]}function Be(t){let e=t.children[2].getBBox();return e.y+e.height/2}function fr(t){let e=t.children[2].getBBox(),n=t.children[1].getBBox();return Math.abs(e.y-n.y)}function pr(t,e,n){var i=Array.from(n.getElementsByClassName("staff")),r=i.map(a=>[Be(a),a]);r.sort((a,c)=>a[0]-c[0]);var s=r.findIndex(a=>e.y<a[0]);if(s==0)return r[0][1];if(s==-1)return r[r.length-1][1];const o=en(r[s-1][0],r[s][0]);return e.y<o?r[s-1][1]:r[s][1]}function yr(t){var e=y(mei,_(t)),n=e.getAttribute("pname"),i=e.getAttribute("oct");return i*7+lt.indexOf(n)}function vr(t){const e=Be(t),i=-Math.abs(fr(t))/2,r=t.getElementsByClassName("note");var s;if(r.length>0)s=r[0];else{const a=t.closest(".system"),l=Array.from(a.getElementsByClassName("staff")).find(d=>Be(d)==e&&d.getElementsByClassName("note").length>0);l&&(s=l.getElementsByClassName("note")[0])}var o;if(console.log(s),s)o=yr(s)-Math.floor((D(s)[1]-e)/i);else{const a=t.closest(".system"),d=Array.from(a.getElementsByClassName("staff")).find(g=>Be(g)==e&&g.getElementsByClassName("clef").length>0).getElementsByClassName("clef")[0],m=d.children[0].getAttribute("y");let u;switch(d.children[0].getAttribute("xlink:href")){case"E062":u=24;break;case"E052":u=25;break;case"E050":u=32;break}o=u-Math.floor((m-e)/i)}return[a=>{var c=Math.floor((a+i/2-e)/i)+o,l=Math.floor(c/7),d=lt[Ui(c,7)];return[d,l]},(a,c)=>{var l=c*7+lt.indexOf(a);return e+(l-o)*i}]}function br(t,e,n){return n.getElementsByClassName("note")[0],n.y_to_p(e.y)}function _r(t,e,n){var i=Array.from(n.getElementsByClassName("note")).map(o=>[D(o)[0],o]);if(i.length==0)return null;i.sort((o,a)=>o[0]-a[0]);var r=i.findIndex(o=>e.x<o[0]);if(r==0)return i[0][1];if(r==-1)return i[i.length-1][1];const s=en(i[r-1][0],i[r][0]);return e.x<s?i[r-1][1]:i[r][1]}function _t(){var t=M(),e=t;const n=gr(),i=mr(e,n);if(!i)return console.log("Pointer outside measures"),[null,null,null];const r=pr(e,n,i),[s,o]=br(e,n,r),a=_r(e,n,r);return a?[s,o,a]:[null,null,null]}function fn(t,e,n){var i=n.closest(".staff");return i.getElementsByClassName("note")[0],[D(n)[0],i.p_to_y(t,e)]}function pn(t,e,n,i=!0,r=""){var s=document.getElementById(r);if(s&&s.parentElement.removeChild(s),i){let[a,c]=fn(t,e,n),[l,d]=D(n);var o=document.createElementNS("http://www.w3.org/2000/svg","use");o.setAttributeNS("http://www.w3.org/1999/xlink","href","#"+n.id),o.setAttribute("x",a-l),o.setAttribute("y",c-d),o.id=r,n.parentElement.appendChild(o)}}function Er(t,e,n,i=!0,r=""){var s=document.getElementById(r),o=[];if(s&&s.parentElement.removeChild(s),i){let[d,m]=fn(t,e,n);var a=document.createElementNS("http://www.w3.org/2000/svg","g"),c=document.createElementNS("http://www.w3.org/2000/svg","g"),l=document.createElementNS("http://www.w3.org/2000/svg","use");l.setAttributeNS("http://www.w3.org/1999/xlink","href",n.getElementsByTagName("use")[0].getAttributeNS("http://www.w3.org/1999/xlink","href")),l.setAttribute("x",d-100),l.setAttribute("y",m),l.setAttribute("height","720px"),l.setAttribute("width","720px"),a.id=r,a.classList.add("note"),c.classList.add("notehead"),c.appendChild(l),a.appendChild(c),n.parentElement.appendChild(a),a.onclick=()=>b(a),o.push(a)}return o.reverse()}function Mr(t,e,n,i,r=!0,s=""){var o=y(mei,_(i));if(!t.score_elem.contains(o))return console.log("Note not in layer?"),!1;var a=mei.createElement("note"),c=[];if(a.setAttribute("xml:id",s),r){let l;o.closest("chord")?l=o.closest("chord"):(l=tr(mei,o),o.parentElement.insertBefore(l,o),o.parentElement.removeChild(o),l.appendChild(o),c.push(l)),a.setAttribute("pname",e),a.setAttribute("oct",n),l.appendChild(a),c.push(a),t.id_mapping.push([s,s])}else return console.log("Not implemented"),!1;return c.reverse()}function yn(t,e,n,i,r,s=!1){var o="new-"+ht();let a=n;typeof r!="undefined"&&(o=r);var c=[];console.log(n),c.push(Er(t,e,n,i,o));var l=M();c.push(Mr(l.layer,t,e,n,i,o)),_n(),s||Pe();var d=Ze();d.push(["add note",c.reverse(),[a],[]])}function Nr(){var t=M(),e=xe();if(e!=""&&t.canEdit){let[n,i,r]=_t();if(!n)return;yn(n,i,r,!0)}}function vn(){var t=M(),e=xe();if(typeof t!="undefined"){if(!t.canEdit)return;let[n,i,r]=_t();e="temp"+ht(),Ln(e),document.getElementById("layers").style.cursor="crosshair",n&&pn(n,i,r,!0,e)}}function bn(){var t=xe();let e=document.getElementById(t);e&&e.parentElement.removeChild(e),t="",Ln(t),document.getElementById("layers").style.cursor="default"}function _n(){var t=M(),e=xe();if(t.canEdit)return e?(bn(),!1):(vn(),!0)}function Ar(){var t=M();if(!t.canEdit)return;let[e,n,i]=_t();e&&pn(e,n,i,!0,xe())}function En(){if(!selected[0].classList.contains("note")){console.log("Can only naturalize notes.");return}if(!cn(selected[0]).canEdit){console.log("No modifications allowed to non-editable layer.");return}var t=selected.concat(extraselected);t.forEach(Tr),t.forEach(b)}const xr=document.getElementById("naturalizebutton");xr.addEventListener("click",En);function Tr(t){let e=t.querySelector(".accid");if(!e){console.log("No accidental to remove");return}Ir(e),e.classList.add("hidden");let n=_(e);var i=Y();for(const r of i){let s=r.id_prefix+n,o=document.getElementById(s);o&&o.classList.add("hidden")}}function Ir(t){for(var e=t.parentElement;!e.classList.contains("note");)e=e.parentElement;var n=_(e),i=y(mei,n);Lr(i)}function Lr(t){t.removeAttribute("accid");var e=Array.from(t.children).filter(n=>n.tagName=="accid");e.forEach(n=>t.removeChild(n))}const wr={note:["relations","metarelations","comborelations"],relation:["metarelations","relations","comborelations"],metarelation:["metarelations","comborelations","relations"]},Mn={name:"relation",main:{repeat:{key:"e",color:1,shadeColor:0},passing:{key:"p",color:2,shadeColor:6},neighbour:{key:"n",color:3,shadeColor:2},harmonic:{key:"i",color:4,shadeColor:3},arpeggio:{key:"a",color:5,shadeColor:4},urlinie:{key:"u",color:6,shadeColor:5},bassbrechung:{key:"b",color:7,shadeColor:5},untyped:{color:5}},additional:["repetition","arpeggiation","back_relating_dominant","displacement","register_transfer","56_shift","added_root","initial_ascent","arpeggiated_ascent","urlinie_transference","bassbrechung_component","coupling","voice_exchange_component","voice_exchange_component_chromaticized","mixture","phrygian_ii"]},Nn={name:"metarelation",main:{context:{key:"c",color:1,shadeColor:0},layer:{key:"l",color:2,shadeColor:6},phrase:{key:"r",color:3,shadeColor:2},section:{key:"t",color:5,shadeColor:3}},additional:["auxiliary_cadence","superposition","reaching_over","urlinie_meta","ursatz","bassbrechung","bassbrechung_transference","ursatz_transference","unfolding","motion_into_the_inner_voice","motion_from_the_inner_voice","linear_intervallic_progression","linear_intervallic_progression_module","interruption","interruption_branch_1","interruption_branch_2","voice_exchange","motivic_parallelism","motive","contradiction","indeterminacy","parallel_fifths","parallel_octaves"]},ct={name:"comborelation",main:{"passing comborelation":{key:"P",total:"passing",outer:"arpeggio"},"neighbour comborelation":{key:"N",total:"neighbour",outer:"repeat"}}},Br=t=>wr[t];var Le=!1,Fe="",H,de,Ae;const Sr=()=>de,Dr=()=>Ae;var fe,ae=null,Ke=!0;function b(t,e=null){const n=Z(t);if(!["relation","metarelation","note"].includes(n))return;const i=selected.concat(extraselected);if(i.length>0){const s=Z(i[0]),o=i[0].closest(".svg_container"),a=t.closest(".svg_container");if(n!=s||a!=o)return}const r=i.find(s=>s==t);r&&(t.classList.remove("selectednote","extraselectednote","selectedrelation","extraselectedrelation"),selected=selected.filter(s=>s!==t),extraselected=extraselected.filter(s=>s!==t)),e===null&&(e=Te.ui.selection.mode.mode=="primary"),n=="note"&&!r&&(e?(t.classList.add("extraselectednote"),extraselected.push(t)):(t.classList.add("selectednote"),selected.push(t)),ae=t),(n=="relation"||n=="metarelation")&&(r||(e?(t.classList.add("extraselectedrelation"),extraselected.push(t)):(t.classList.add("selectedrelation"),selected.push(t)),ae=t),selected.concat(extraselected).length==0&&(ae=null)),document.dispatchEvent(new CustomEvent("scoreselection",{detail:{selected,extraselected}}))}function Cr(t){var e=Array.from(t.svg_elem.getElementsByClassName("relation")).filter(s=>!s.classList.contains("relation--filtered"));if(e.length>0){Z(e[0]);var n=e[0].closest("div");if(selected.length>0||extraselected.length>0){var i=Z(selected.concat(extraselected)[0]),r=selected.concat(extraselected)[0].closest("div");i!="relation"&&be(),n!=r&&be()}e.forEach(s=>{s.classList.contains("selectedrelation")||b(s)})}}window.onmousemove=t=>{de=t.clientX,Ae=t.clientY,Fe!=""&&Ar()};function jr(t){t.key==="Shift"&&E("#layers").addClass("shift-pressed")}function kr(t){t.key==="Shift"&&E("#layers").removeClass("shift-pressed")}function zr(t){Nr()}function Or(t){if(console.debug("Using globals: meta_keys, type_keys"),!it()&&t.key!="Enter")if(t.key==z.move_relation_to_front){var e=document.elementFromPoint(de,Ae);e.tagName=="circle"&&(e=e.closest("g")),Ye(e),e.onmouseout&&e.onmouseout()}else if(t.key==z.undo)hn();else if(t.key==z.redo)mn();else if(t.key==z.copy)cr();else if(t.key==z.paste)dr();else if(t.key==z.reduce_relations)un(H);else if(t.key==z.select_same_notes)Wi(),K("repeat");else if(t.key==z.naturalize_note)En();else if(t.key==ie.jump_to_next_bookmark)Oe(-1);else if(t.key==ie.jump_to_previous_bookmark)Oe(1);else if(t.key==ie.jump_to_context_below)Ue(1);else if(t.key==ie.jump_to_context_above)Ue(-1);else if(t.key==z.deselect_all)be();else if(t.key==z.delete_all)vt();else if(t.key==z.add_bookmark)Tn();else if(t.key==custom_conf.relation){t.preventDefault();var n=E("#relations_panel").hasClass("collapsed");n&&Se()}else if(t.key==custom_conf.meta_relation){t.preventDefault();var n=E("#relations_panel").hasClass("collapsed");n&&Se()}else Bt[t.key]?K(Bt[t.key]):St[t.key]?xt(St[t.key]):Dt[t.key]?qn(Dt[t.key]):t.key==ie.toggle_palette?Se():console.log(t)}function Ur(){console.debug("Using globals: non_notes_hidden"),Le=!Le,Rr(Le),Le||In()}function Rr(t){console.debug("Using globals: document for element selection"),Array.from(document.getElementsByClassName("beam")).forEach(e=>Array.from(e.children).filter(n=>n.tagName=="polygon").forEach(n=>n.classList.toggle("hidden",t))),ui.forEach(e=>Array.from(document.getElementsByClassName(e)).forEach(n=>n.classList.toggle("hidden",t)))}function J(t){var o,a;const e=t.getAttribute("type"),r=(a=(o=(t.classList.contains("relation")?Mn:Nn).main[e])==null?void 0:o.color)!=null?a:0,s=hi.getPropertyValue(`--relation-${r}`);t.setAttribute("color",s)}function Se(){E("#relations_panel").hasClass("collapsed")?(E("#relations_panel").removeClass("collapsed"),E("#relations_panel input").removeClass("none")):(E("#relations_panel").addClass("collapsed"),E("#relations_panel input").addClass("none"))}const Yr=document.getElementById("relations_panel_toggle");Yr.addEventListener("click",Se);function be(){selected.forEach(t=>b(t,!1)),extraselected.forEach(t=>b(t,!0))}function $r(t=null){t||(t=Y()[0]);var e=qe(),n=Jn(!0,t),i=new XMLSerializer().serializeToString(n);e.loadData(i);const r=e.renderToMIDI();var s=No();return e.loadData(s),r}function Qr(t){var e=O(),n=Y();be(),E(".relation").remove(),E(".metarelation").remove();var i=Array.from(e.getElementsByTagName("node")),r=i.filter(s=>s.getAttribute("type")=="relation");i.filter(s=>s.getAttribute("type")=="metarelation"),n.forEach(s=>{r.forEach(o=>pt(s,e,o))}),n.hullPadding=t,n.forEach(Xn),n.forEach(s=>{s.svg_elem.getRootNode().getElementById("hier"+s.id_prefix)&&gn(s)})}function Hr(t){var e=0,n=0,i=0,r=0;t.onmousedown=s;function s(c){c.target.tagName!=="INPUT"&&(c=c||window.event,c.preventDefault(),i=c.clientX,r=c.clientY,document.onmouseup=a,document.onmousemove=o,typeof drag_selector!="undefined"&&drag_selector.stop())}function o(c){c=c||window.event,c.preventDefault(),e=i-c.clientX,n=r-c.clientY,i=c.clientX,r=c.clientY,i>=0&&r>=0&&(t.style.top=t.offsetTop-n+"px",t.style.left=t.offsetLeft-e+"px")}function a(){document.onmouseup=null,document.onmousemove=null,typeof drag_selector!="undefined"&&drag_selector.start()}}function Vr(t){window.drag_selector=new li({selectables:document.getElementsByClassName("relation"),area:E("#layers")[0],draggability:!1,overflowTolerance:{x:1,y:1},autoScrollSpeed:1e-4}),drag_selector.subscribe("dragstart",({items:e,event:n,isDragging:i})=>{E(".ds-selector-area").show()}),drag_selector.subscribe("dragmove",({items:e,event:n,isDragging:i})=>{Fe==""&&!document.getElementById("minimap").classList.contains("dragging")&&((E(".ds-selector").height()>10||E(".ds-selector").width()>10)&&(E("#metadata_input, #relations_panel, #minimap").fadeOut(300),document.getElementById("layers").style.cursor="url(data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB3aWR0aD0iMjJwdCIgaGVpZ2h0PSIyMnB0IiB2aWV3Qm94PSIwIDAgMjIgMjIiIHZlcnNpb249IjEuMSI+CjxnIGlkPSJzdXJmYWNlMSI+CjxwYXRoIHN0eWxlPSIgc3Ryb2tlOm5vbmU7ZmlsbC1ydWxlOm5vbnplcm87ZmlsbDpyZ2IoMCUsMCUsMCUpO2ZpbGwtb3BhY2l0eToxOyIgZD0iTSA0LjQ0OTIxOSAxNC44MDA3ODEgQyA0LjI2OTUzMSAxNC42MjEwOTQgMy45ODA0NjkgMTQuNjIxMDk0IDMuODAwNzgxIDE0LjgwMDc4MSBDIDMuNjIxMDk0IDE0Ljk4MDQ2OSAzLjYyMTA5NCAxNS4yNjk1MzEgMy44MDA3ODEgMTUuNDQ5MjE5IEMgNS43Njk1MzEgMTcuNDE3OTY5IDUuNzY5NTMxIDE5LjI1IDMuODAwNzgxIDIxLjIxODc1IEMgMy42MjEwOTQgMjEuMzk4NDM4IDMuNjIxMDk0IDIxLjY4NzUgMy44MDA3ODEgMjEuODY3MTg4IEMgMy44OTA2MjUgMjEuOTU3MDMxIDQuMDA3ODEyIDIyIDQuMTI1IDIyIEMgNC4yNDIxODggMjIgNC4zNTkzNzUgMjEuOTU3MDMxIDQuNDQ5MjE5IDIxLjg2NzE4OCBDIDYuNzU3ODEyIDE5LjU1NDY4OCA2Ljc1NzgxMiAxNy4xMTMyODEgNC40NDkyMTkgMTQuODAwNzgxIFogTSA0LjQ0OTIxOSAxNC44MDA3ODEgIi8+CjxwYXRoIHN0eWxlPSIgc3Ryb2tlOm5vbmU7ZmlsbC1ydWxlOm5vbnplcm87ZmlsbDpyZ2IoMCUsMCUsMCUpO2ZpbGwtb3BhY2l0eToxOyIgZD0iTSA0LjEyNSAxMS45MTc5NjkgQyAzLjExMzI4MSAxMS45MTc5NjkgMi4yOTI5NjkgMTIuNzM4MjgxIDIuMjkyOTY5IDEzLjc1IEMgMi4yOTI5NjkgMTQuNzYxNzE5IDMuMTEzMjgxIDE1LjU4MjAzMSA0LjEyNSAxNS41ODIwMzEgQyA1LjEzNjcxOSAxNS41ODIwMzEgNS45NTcwMzEgMTQuNzYxNzE5IDUuOTU3MDMxIDEzLjc1IEMgNS45NTcwMzEgMTIuNzM4MjgxIDUuMTM2NzE5IDExLjkxNzk2OSA0LjEyNSAxMS45MTc5NjkgWiBNIDQuMTI1IDE0LjY2Nzk2OSBDIDMuNjIxMDk0IDE0LjY2Nzk2OSAzLjIwNzAzMSAxNC4yNTM5MDYgMy4yMDcwMzEgMTMuNzUgQyAzLjIwNzAzMSAxMy4yNDYwOTQgMy42MjEwOTQgMTIuODMyMDMxIDQuMTI1IDEyLjgzMjAzMSBDIDQuNjI4OTA2IDEyLjgzMjAzMSA1LjA0Mjk2OSAxMy4yNDYwOTQgNS4wNDI5NjkgMTMuNzUgQyA1LjA0Mjk2OSAxNC4yNTM5MDYgNC42Mjg5MDYgMTQuNjY3OTY5IDQuMTI1IDE0LjY2Nzk2OSBaIE0gNC4xMjUgMTQuNjY3OTY5ICIvPgo8cGF0aCBzdHlsZT0iIHN0cm9rZTpub25lO2ZpbGwtcnVsZTpub256ZXJvO2ZpbGw6cmdiKDAlLDAlLDAlKTtmaWxsLW9wYWNpdHk6MTsiIGQ9Ik0gMjEuNzY1NjI1IDEzLjgwODU5NCBMIDEzLjUxNTYyNSA5LjIyMjY1NiBDIDEzLjM0Mzc1IDkuMTI4OTA2IDEzLjEzNjcxOSA5LjE1MjM0NCAxMi45ODgyODEgOS4yODEyNSBDIDEyLjg0Mzc1IDkuNDEwMTU2IDEyLjc5Mjk2OSA5LjYxMzI4MSAxMi44NjcxODggOS43OTY4NzUgTCAxNi41MzEyNSAxOC45NjA5MzggQyAxNi42MDE1NjIgMTkuMTMyODEyIDE2Ljc2OTUzMSAxOS4yNSAxNi45NTMxMjUgMTkuMjUgQyAxNi45NTMxMjUgMTkuMjUgMTYuOTU3MDMxIDE5LjI1IDE2Ljk1NzAzMSAxOS4yNSBDIDE3LjE0MDYyNSAxOS4yNSAxNy4zMDg1OTQgMTkuMTQwNjI1IDE3LjM3ODkwNiAxOC45NzI2NTYgTCAxOC42ODM1OTQgMTUuOTMzNTk0IEwgMjEuNzIyNjU2IDE0LjYyODkwNiBDIDIxLjg4MjgxMiAxNC41NjI1IDIxLjk4ODI4MSAxNC40MDYyNSAyMiAxNC4yMzA0NjkgQyAyMi4wMDc4MTIgMTQuMDU4NTk0IDIxLjkxNzk2OSAxMy44OTQ1MzEgMjEuNzY1NjI1IDEzLjgwODU5NCBaIE0gMjEuNzY1NjI1IDEzLjgwODU5NCAiLz4KPHBhdGggc3R5bGU9IiBzdHJva2U6bm9uZTtmaWxsLXJ1bGU6bm9uemVybztmaWxsOnJnYigwJSwwJSwwJSk7ZmlsbC1vcGFjaXR5OjE7IiBkPSJNIDUuNjY0MDYyIDEyLjc2NTYyNSBDIDUuNTc4MTI1IDEyLjYyODkwNiA1LjQ3MjY1NiAxMi41MDc4MTIgNS4zNTU0NjkgMTIuNDAyMzQ0IEMgNS4zMzk4NDQgMTIuMzg2NzE5IDUuMzI0MjE5IDEyLjM3NSA1LjMwODU5NCAxMi4zNjMyODEgQyA1LjIxMDkzOCAxMi4yNzczNDQgNS4xMDU0NjkgMTIuMjA3MDMxIDQuOTkyMTg4IDEyLjE0NDUzMSBDIDQuOTYwOTM4IDEyLjEyODkwNiA0LjkyOTY4OCAxMi4xMDkzNzUgNC44OTg0MzggMTIuMDkzNzUgQyA0Ljc3MzQzOCAxMi4wMzUxNTYgNC42NDQ1MzEgMTEuOTg4MjgxIDQuNTA3ODEyIDExLjk1NzAzMSBDIDQuNDY4NzUgMTEuOTQ5MjE5IDQuNDI1NzgxIDExLjk0OTIxOSA0LjM4MjgxMiAxMS45NDE0MDYgQyA0LjI2OTUzMSAxMS45MjU3ODEgNC4xNTIzNDQgMTEuOTE3OTY5IDQuMDM5MDYyIDExLjkyNTc4MSBDIDMuNjMyODEyIDExLjk0NTMxMiAzLjI2NTYyNSAxMi4wOTc2NTYgMi45Njg3NSAxMi4zMzU5MzggQyAzLjE5MTQwNiAxMi40OTYwOTQgMy40MTQwNjIgMTIuNjQ4NDM4IDMuNjU2MjUgMTIuNzkyOTY5IEMgMy43NSAxMi44NDc2NTYgMy44NTkzNzUgMTIuODY3MTg4IDMuOTY4NzUgMTIuODUxNTYyIEMgNC4zNDc2NTYgMTIuNzg1MTU2IDQuNzUzOTA2IDEyLjk3NjU2MiA0LjkzNzUgMTMuMzM1OTM4IEMgNC45ODgyODEgMTMuNDMzNTk0IDUuMDcwMzEyIDEzLjUxMTcxOSA1LjE2Nzk2OSAxMy41NTA3ODEgQyA1LjQyMTg3NSAxMy42NTYyNSA1LjY4NzUgMTMuNzM4MjgxIDUuOTQ5MjE5IDEzLjgyODEyNSBDIDUuOTQ5MjE5IDEzLjgwMDc4MSA1Ljk1NzAzMSAxMy43NzczNDQgNS45NTcwMzEgMTMuNzUgQyA1Ljk1NzAzMSAxMy4zODY3MTkgNS44NDc2NTYgMTMuMDUwNzgxIDUuNjY0MDYyIDEyLjc2NTYyNSBaIE0gNS42NjQwNjIgMTIuNzY1NjI1ICIvPgo8cGF0aCBzdHlsZT0iIHN0cm9rZTpub25lO2ZpbGwtcnVsZTpub256ZXJvO2ZpbGw6cmdiKDAlLDAlLDAlKTtmaWxsLW9wYWNpdHk6MTsiIGQ9Ik0gMTMuMzgyODEyIDEzLjU1ODU5NCBDIDExLjE5MTQwNiAxMy44OTg0MzggOC44NTkzNzUgMTMuNzUgNi44MDQ2ODggMTMuMTUyMzQ0IEMgNi44NDc2NTYgMTMuMzQzNzUgNi44NzUgMTMuNTQyOTY5IDYuODc1IDEzLjc1IEMgNi44NzUgMTMuODcxMDk0IDYuODU1NDY5IDEzLjk4ODI4MSA2LjgzOTg0NCAxNC4xMDkzNzUgQyA4LjE1NjI1IDE0LjQ2ODc1IDkuNTY2NDA2IDE0LjY2Nzk2OSAxMSAxNC42Njc5NjkgQyAxMS45MjU3ODEgMTQuNjY3OTY5IDEyLjgzOTg0NCAxNC41ODIwMzEgMTMuNzM0Mzc1IDE0LjQyOTY4OCBaIE0gMTMuMzgyODEyIDEzLjU1ODU5NCAiLz4KPHBhdGggc3R5bGU9IiBzdHJva2U6bm9uZTtmaWxsLXJ1bGU6bm9uemVybztmaWxsOnJnYigwJSwwJSwwJSk7ZmlsbC1vcGFjaXR5OjE7IiBkPSJNIDExIDAgQyA0LjkzMzU5NCAwIDAgMy4yODkwNjIgMCA3LjMzMjAzMSBDIDAgOC45NDE0MDYgMC44MDQ2ODggMTAuNDkyMTg4IDIuMjM4MjgxIDExLjc1NzgxMiBDIDIuNDY4NzUgMTEuNTM5MDYyIDIuNzM4MjgxIDExLjM1NTQ2OSAzLjAzNTE1NiAxMS4yMjY1NjIgQyAxLjY3OTY4OCAxMC4xMDkzNzUgMC45MTc5NjkgOC43MzgyODEgMC45MTc5NjkgNy4zMzIwMzEgQyAwLjkxNzk2OSAzLjc5Njg3NSA1LjQ0MTQwNiAwLjkxNzk2OSAxMSAwLjkxNzk2OSBDIDE2LjU1ODU5NCAwLjkxNzk2OSAyMS4wODIwMzEgMy43OTY4NzUgMjEuMDgyMDMxIDcuMzMyMDMxIEMgMjEuMDgyMDMxIDguNzUzOTA2IDIwLjM0Mzc1IDEwLjEwMTU2MiAxOC45ODgyODEgMTEuMjE4NzUgTCAxOS44Mzk4NDQgMTEuNjg3NSBDIDIxLjIyNjU2MiAxMC40Mzc1IDIyIDguOTEwMTU2IDIyIDcuMzMyMDMxIEMgMjIgMy4yODkwNjIgMTcuMDY2NDA2IDAgMTEgMCBaIE0gMTEgMCAiLz4KPC9nPgo8L3N2Zz4K), auto"),document.elementsFromPoint(de,Ae).map(r=>{switch(r.tagName){case"path":return r;case"use":return r.parentElement.parentElement;case"circle":return r.parentElement;default:return!1}}).filter(r=>{if(typeof r=="undefined"||typeof r.classList=="undefined")return!1;var s=n.shiftKey;return r.classList.contains("relation")&&!r.classList.contains("relation--filtered")&&!r.classList.contains("selectedrelation")&&!r.classList.contains("extraselectedrelation")&&!s||r.classList.contains("note")&&!r.classList.contains("selectednote")&&!r.classList.contains("extraselectednote")||r.classList.contains("metarelation")&&!r.classList.contains("selectedrelation")&&!r.classList.contains("extraselectedrelation")&&!s}).forEach(b))}),drag_selector.subscribe("callback",({items:e,event:n,isDragging:i})=>{document.getElementById("layers").style.cursor="default",E(".ds-selector-area").hide(),E("#metadata_input, #relations_panel, #minimap").fadeIn(300)})}function ue(){if(de!=null){var t=[document.elementFromPoint(de,Ae)].map(e=>{if(e)switch(e.tagName){case"path":return e;case"use":return e.parentElement.parentElement;case"circle":return e.parentElement;default:return!1}}).filter(e=>typeof e=="undefined"||typeof e.classList=="undefined"?!1:e.classList.contains("relation")&&!e.classList.contains("relation--filtered")||e.classList.contains("metarelation"))[0];t=t?t.getAttribute("type"):"",t?(E(".jBox-Mouse").show(),fe.setContent(t)):E(".jBox-Mouse").hide()}}function Pr(){typeof fe!="undefined"&&fe.destroy(),fe=new ci("Mouse",{attach:"#layers",trigger:"mouseenter",onPosition:ue})}function Et(t){var e=t.svg_elem,n=t.id_prefix,i=e.getRootNode().getElementById("hier"+n);return i||(i=e.getRootNode().getElementById("tree"+n),i)?(i.parentNode.removeChild(i),!0):!1}function An(t,e){var n=t.svg_elem,i=n.children[0].getAttribute("height"),r=n.getElementsByClassName("definition-scale")[0].getAttribute("viewBox"),s,o,a,c;t.old_viewbox?([s,o,a,c]=t.old_viewbox.split(" "),i=t.old_height):([s,o,a,c]=r.split(" "),t.old_viewbox=r,t.old_height=i),n.getElementsByClassName("definition-scale")[0].setAttribute("viewBox",[s,Number(o)-e,a,Number(c)+e].join(" "));var l=Number(i.split("p")[0]);n.children[0].setAttribute("height",l*((c-(o-e))/(c-o))+"px")}function Fr(t){var e=t.svg_elem;t.id_prefix;var n=Et(t);n&&(e.getElementsByClassName("definition-scale")[0].setAttribute("viewBox",t.old_viewbox),e.children[0].setAttribute("height",t.old_height))}function xn(){document.getElementById("minimap").width=100,ai(document.querySelector("#minimap"),{viewport:null,styles:{".svg_container":"rgba(0,0,0,0.30)",".layer":"rgba(0,0,0,0.00)"},back:"rgba(0,0,0,0.30)",view:"rgba(0,0,0,0.20)",drag:"rgba(0,0,0,0.30)",interval:null})}var dt=[];function Tn(){if(ae)if(ae.classList.contains("note")){var t=ae,e=document.createElementNS("http://www.w3.org/2000/svg","rect"),n=H.id_prefix?H.id_prefix:"0";e.dataset.draw_context=n,e.classList.add("bookmark"),e.setAttribute("fill","red"),e.setAttribute("width","500px"),e.setAttribute("height","1500px"),e.setAttribute("transform","translate(-120 -750)"),e.setAttribute("x",t.children[0].children[0].getAttribute("x")),e.setAttribute("y",t.children[0].children[0].getAttribute("y")),E(H.svg_elem).find(".page-margin")[0].prepend(e),dt.push(e),dt.sort(function(i,r){return i.getAttribute("x")-r.getAttribute("x")})}else return!1;else return!1}const Wr=document.getElementById("addbookmarkbutton");Wr.addEventListener("click",Tn);function Oe(t=1){var e=M();function n(l){l.scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}if(e){var i=e.id_prefix?e.id_prefix:"0",r=dt.filter(l=>l.dataset.draw_context==i),s=r.map(l=>l.getBoundingClientRect().x),o=s.findIndex(l=>l>=window.innerWidth),a=s.filter(l=>l<=0).length-1;if(t==1&&o!=-1)var c=r[o];else if(t==-1&&a!=-1)var c=r[a];else return!1;n(c)}}const qr=document.getElementById("previousbookmarkbutton");qr.addEventListener("click",()=>Oe(-1));const Zr=document.getElementById("nextbookmarkbutton");Zr.addEventListener("click",()=>Oe(1));function Ue(t=1){function e(o){o.scrollIntoView({behavior:"smooth",block:"start",inline:"nearest"})}var n=Y().sort((o,a)=>o.view_elem.getBoundingClientRect().y-a.view_elem.getBoundingClientRect().y),i=n.map(o=>o.view_elem.getBoundingClientRect().y),r=n.map(o=>o.view_elem.getBoundingClientRect().bottom),s;if(t==1)s=r.findIndex(o=>o>window.innerHeight);else if(t==-1)s=i.filter(o=>o<0).length-1;else return!1;s!=-1&&e(n[s].view_elem)}const Gr=document.getElementById("previouscontextbutton");Gr.addEventListener("click",()=>Ue(-1));const Xr=document.getElementById("nextcontextbutton");Xr.addEventListener("click",()=>Ue(1));function Jr(){var t=O(),e=Array.from(document.getElementsByClassName("note")).map(i=>i.id),n=Array.from(t.getElementsByTagName("arc")).map(i=>i.getAttribute("to"));e.forEach(i=>{var r=i.replace(/(^\d+-?)/,"");n.includes(`#gn-${r}`)||document.getElementById(i).classList.add("hidden")})}function In(){Array.from(document.querySelectorAll("g.note")).forEach(t=>t.classList.remove("hidden"))}function Kr(){Ke=!Ke,Ke?In():Jr()}const es=()=>fe,xe=()=>Fe,Ln=t=>Fe=t,M=()=>H,ts=t=>{H==null||H.layer.layer_elem.classList.remove("layer--active"),H=t,H.layer.layer_elem.classList.add("layer--active")};function wn(t,e,n){if(t.children.length==0){t.y=e;return}t.children.forEach(i=>wn(i,e,n)),t.y=n+t.children.map(i=>i.y).reduce((i,r)=>i>r?i:r)}function Bn(t,e,n){t.children.length!=0&&(Math.abs(e-t.y)>n&&(t.y+=(e-n-t.y)/2),t.children.forEach(i=>Bn(i,t.y,n)))}function We(t){return t.children.length==0?[t]:t.children.flatMap(We)}function Sn(t){t.children.forEach(Sn),!(t.children.length==0||t.x!=null)&&(t.x=rn(t.children.map(e=>e.x)))}function ns(t,e=0,n=-500){Sn(t),wn(t,e,n),Bn(t,t.y,n)}function Dn(t,e=100){var n=De(),i=Xt(t.label,[t.x,t.y+(t.children.length==0?e:0)]);i.style.fontFamiy="sans-serif",i.style.fontSize=e+"px",i.style.textAnchor="middle",i.classList.add("nodetext");var r=t.children.map(o=>Zt([t.x,t.y],[o.x,o.y])),s=t.children.flatMap(o=>Dn(o,e));return r.forEach(o=>n.appendChild(o)),s.forEach(o=>n.appendChild(o)),n.appendChild(i),n}function is(t,e=25){var n=t.getBBox(),i=Di([n.x-e,n.y-e],n.width+e,n.height+e);t.parentNode.insertBefore(i,t)}function Cn(t){var e,n,i=mei.createElement("label");if(i.append(t.label),console.log(t.note_id),t.note_id){var r=mei.createElement("note");r.setAttribute("corresp","#"+t.note_id),i.appendChild(r)}return t.children.length==0?e=mei.createElement("eLeaf"):(e=mei.createElement("eTree"),n=t.children.map(Cn)),e.appendChild(i),n&&n.forEach(s=>e.appendChild(s)),e}function rs(t){var e=O(),n=e.parentNode;n.querySelector("eTree")&&n.removeChild(n.querySelector("eTree")),n.appendChild(t)}function jn(t){var e=t.children[0],n={label:e.textContent};e.children.length!=0&&(n.note_id=e.querySelector("note").getAttribute("corresp").replace("#",""));var i=Array.from(t.children);return i.shift(),n.children=i.map(jn),n}function ss(t){return jn(t)}function kn(t,e){e.note_id&&(e.x=D(y(document,B(t,e.note_id)))[0]),e.children.forEach(n=>kn(t,n))}function zn(t){var e=mei.querySelector("eTree");if(!e){console.log("No tree to load");return}var n=ss(e),i=JSON.stringify(n),r=document.getElementById("json-tree");r.value=i}function pe(t){return JSON.parse(document.getElementById("json-tree").value)}function os(t){var e=We(t);return e[0].hasOwnProperty("x")}function as(t){var e=We(t);return e[0].hasOwnProperty("note_id")}function ls(t){var e=pe();if(!!e){var n=Cn(e);rs(n)}}function On(t){var e=pe();if(!!e){var n=document.getElementById("json-tree"),i=selected.concat(extraselected);selected.length==0?i=Array.from(t.svg_elem.getElementsByClassName("note")):selected.length==1?selected[0].classList.contains("relation")&&(i=relation_get_notes(selected[0]).map(a=>y(document,B(t,a.getAttribute("xml:id"))))):selected[0].classList.contains("metarelation")||selected.length>1;var r=i.map(a=>[D(a)[0],a]);r.sort((a,c)=>a[0]-c[0]);var s=We(e);if(s.length!=r.length){console.log("Wrong length of list, expected "+s.length+" got "+r.length);return}for(let a in s)s[a].x=r[a][0],s[a].note_id=r[a][1].id;var o=JSON.stringify(e);n.value=o,t.svg_elem.getRootNode().getElementById("tree"+t.id_prefix)&&Un(t)}}function Un(t,e=0,n=-1e3){var i=t.svg_elem,r=t.id_prefix;Et(t);var s=pe();if(!(!s&&(console.log("No tree in input, attempting to load from XML"),zn(),s=pe(),!s))&&!(!as(s)&&(console.log("Tree not aligned, attempting to align to selection"),On(t),s=pe(),!s))){os(s)||kn(t,s),ns(s,e,n);var o=Dn(s);o.id="tree"+r,$e(i,o),Array.from(o.getElementsByTagName("text")).forEach(is),An(t,-s.y)}}class cs{constructor(e){this.layers=e,this.jsonInput=document.getElementById("json-tree"),this.saveBtn=document.getElementById("json-tree-save"),this.loadBtn=document.getElementById("json-tree-load"),this.alignBtn=document.getElementById("json-tree-align")}get jsonTree(){try{return JSON.parse(this.jsonInput.value.trim())}catch{return null}}onTap({target:e}){const n=M();if(e==this.saveBtn)return ls();if(e==this.loadBtn)return zn();if(e==this.alignBtn)return On(n)}onSubmit(e){if(e.target.id=="json-tree-form"&&(e.preventDefault(),this.jsonTree)){const n=M();Un(n)}}}class ds{constructor(e){this.layers=e,this.$ctn=document.getElementById("layer-menu-new"),this.$sliced=document.getElementById("layer-sliced"),this.$tied=document.getElementById("layer-tied"),this.$createBtn=document.getElementById("layer-new")}create(){_o(M(),this.$sliced.checked,this.$tied.checked)}onChange({target:e}){console.log(e)}onTap(e){!e.composedPath().includes(this.$ctn)||e.target==this.$createBtn&&(this.create(),console.log(this.layers))}}class us{constructor(e){U(this,"reduce",e=>un(e));U(this,"unreduce",e=>ar(e));this.layers=e,this.ctn=document.getElementById("layers-menu-reductions"),this.reduceBtn=document.getElementById("layers-menu-reduce"),this.unreduceBtn=document.getElementById("layers-menu-unreduce"),this.playReductionBtn=document.getElementById("layers-menu-play-reduction")}play(e){const n=$r(e);ot.loadSound(n,e.id_prefix),ot.play()}onTap(e){if(!e.composedPath().includes(this.ctn))return;const n=this.layers.getAll()[0];if(e.target==this.reduceBtn)return this.reduce(n);if(e.target==this.unreduceBtn)return this.unreduce(n);if(e.target==this.playReductionBtn)return this.play(n)}}class gs{constructor(e){this.layers=e,this.on=document.getElementById("relations-tree-on"),this.off=document.getElementById("relations-tree-off"),this.drawRoots=document.getElementById("relations-tree-roots-low"),this.visible=!1,this.shouldDrawRootsLow=!1}draw(){const e=M();this.visible?gn(e,50,this.shouldDrawRootsLow):Fr(e)}onChange({target:e}){e.name=="relations-tree"&&(console.log(M()),this.visible=e.value=="on",this.draw()),e==this.drawRoots&&(this.shouldDrawRootsLow=e.checked,this.draw())}onScoreLoad(){this.updateToggles()}updateToggles(e=M()){console.log(e);const n=e.svg_elem.querySelector("#hier");console.log(n),this[n?"on":"off"].checked=!0}}var Me;class hs{constructor(){ne(this,Me,!1);U(this,"getAll",()=>Y());this.ctn=document.getElementById("layers-menu"),this.toggleBtn=document.getElementById("layers-menu-toggle"),this.layersEls=document.getElementsByClassName("layer-new-ui"),this.visibleLayer=1,this.activeLayer=1,this.$visibleLayer=document.getElementById("visible-layer"),this.$currentLayer=document.getElementById("current-layer"),this.new=new ds(this),this.reductions=new us(this),this.tree=new gs(this),this.jsonTree=new cs(this),this.previousLayerBtn=document.getElementById("layers-nav-previous"),this.nextLayerBtn=document.getElementById("layers-nav-next"),this.$saveSettingsCtn=document.getElementById("layer-menu-settings"),this.$shouldSave=document.getElementById("should-save-layer"),this.$lockBtn=document.getElementById("layer-lock"),this.initObserver()}get contexts(){return this.getAll()}onTap(e){if(!!e.composedPath().includes(this.ctn)){if(e.target==this.toggleBtn)return this.toggleVisibility();if(e.target==this.nextLayerBtn)return this.moveBy(1);if(e.target==this.previousLayerBtn)return this.moveBy(-1);if(e.target==this.$lockBtn)return this.toggleLock();if(e.target==this.$shouldSave)return this.toggleSave();this.new.onTap(e),this.setDataPosition(),this.addMouseListeners(),this.observe(),this.updateNavigation(),this.updateLayersCount(),this.reductions.onTap(e),this.jsonTree.onTap(e)}}onChange(e){!e.composedPath().includes(this.ctn)||(this.tree.onChange(e),this.new.onChange(e))}onScoreLoad(){this.addMouseListeners(),this.setDataPosition(),this.updateLayersCount(),this.tree.onScoreLoad()}toggleVisibility(e=!S(this,Me)){ge(this,Me,e),this.ctn.classList.toggle("layers-menu--visible",e)}setDataPosition(){Array.from(this.layersEls).forEach((e,n)=>{e.dataset.position=n+1})}setCurrentLayer(e=1){console.log(e);const n=this.contexts.find(i=>i.layer.layer_number+1==e);n&&(ts(n),this.$currentLayer.innerHTML=e,this.activeLayer=e,this.updateLayersCount(),this.checkLockState(n.canEdit),this.checkSaveState(n.canSave),this.tree.updateToggles(n))}updateLayersCount(){const e=this.contexts.length==1;V.classList.toggle("has-1-layer",e),V.classList.toggle("has-many-layers",!e),this.$saveSettingsCtn.classList.toggle("layers-menu__saveSettings--hidden",e||this.activeLayer==1)}updateNavigation(){this.$visibleLayer.innerHTML=this.visibleLayer,this.previousLayerBtn.toggleAttribute("disabled",this.visibleLayer==1),this.nextLayerBtn.toggleAttribute("disabled",this.visibleLayer==this.contexts.length)}observe(){if(this.contexts.length<2)return this.contexts[0].observing=!1,this.observer.disconnect();this.contexts.filter(e=>!e.observing).forEach(e=>{e.layer.layer_elem.childElementCount==1&&e.layer.layer_elem.insertAdjacentHTML("beforeend",`<div class="layer-intersection-landmark" data-position="${e.layer.layer_number+1}"></div>`),this.observer.observe(e.layer.layer_elem.querySelector(".layer-intersection-landmark")),e.observing=!0})}initObserver(){this.observer=new IntersectionObserver(e=>{e.forEach(r=>{var o;const s=this.contexts.find(a=>r.target.dataset.position==a.layer.layer_number+1);s&&(s.visibleHeight=(o=r.intersectionRect.height)!=null?o:0)});const n=Math.max(...this.contexts.map(r=>r.visibleHeight)),i=this.contexts.find(r=>r.visibleHeight==n);this.visibleLayer=parseInt(i.layer.layer_elem.dataset.position),this.updateNavigation()},{threshold:[0,.1,.2,.3,.4,.5,.6,.7,.8,.9,1]})}moveBy(e=0){const n=this.visibleLayer+e;if(ce(n,1,this.contexts.length)==n){const i=this.contexts.reverse()[n-1].layer.layer_elem;this.contexts.reverse(),i.scrollIntoView()}}addMouseListeners(){}markAsCurrent(e){this.setCurrentLayer(parseInt(e.target.dataset.position))}toggleSave(e=!M().canSave){M().canSave=e,this.checkSaveState(e)}checkSaveState(e){this.$shouldSave.checked=e}toggleLock(e=!M().canEdit){M().canEdit=e,this.checkLockState(e)}checkLockState(e){this.$lockBtn.classList.toggle("lock-path--unlocked",e)}}Me=new WeakMap;const ut=new hs,ms=["note","relation","metarelation"];var Ne,W;class fs{constructor(){ne(this,Ne,void 0);ne(this,W,new wi);this.loaded=!1,this.mei=null,this.layersCtn=document.getElementById("layers")}get selection(){return S(this,Ne)}set selection(e){S(this,W).clear(),ge(this,Ne,e)}get flatSelection(){return S(this,W).remember("flatSelection",()=>Object.values(this.selection).flat())}get hasSelection(){return S(this,W).remember("hasSelection",()=>this.flatSelection.length>0)}get selectionType(){return S(this,W).remember("selectionType",()=>{var e;return(e=ms.find(n=>{var i;return(i=this.flatSelection[0])==null?void 0:i.classList.contains(n)}))!=null?e:null})}get selectedRelationTypes(){return S(this,W).remember("selectedRelationTypes",()=>!this.hasSelection||this.selectionType=="note"?null:new Set(this.flatSelection.map(e=>e.getAttribute("type")).filter(e=>e)))}onScoreLoad(){this.loaded=!0,this.mei=window.mei,S(this,W).clear(),ut.setCurrentLayer(1)}onScoreSelection({detail:e}){this.selection=e}onTap(e){if(!this.loaded||!e.composedPath().includes(this.layersCtn))return;const n=e.composedPath().find(i=>i.classList.contains("layer"));n&&ut.setCurrentLayer(parseInt(n.dataset.position))}}Ne=new WeakMap,W=new WeakMap;const T=new fs;class Yt{constructor(e,n){U(this,"createFilterElement",({type:e,checked:n})=>`
    <li>
        <label class="checkable color-relation-${e}" for="${this.namespace}-filter-${e}">
            ${gt(e)}
            <input class="checkable__input" type="checkbox" id="${this.namespace}-filter-${e}" data-type="${e}" ${n?"checked":""}>
            <span class="checkbox checkbox--colored">
                <svg class="checkable__icon btn__icon" width="12" height="10">
                    <use xlink:href="#check-path"/>
                </svg>
            </span>
        </label>
    </li>
  `);this.namespace=e,this.ctn=document.getElementById(n.filterCtnId),this.paths=T.layersCtn.getElementsByClassName(e),this.fields=[]}onChange(e){e.composedPath().includes(this.ctn)&&this.toggleRelationsPaths(e.target.dataset.type,e.target.checked)}toggleRelationsPaths(e,n){Array.from(this.paths).filter(i=>i.getAttribute("type")==e).forEach(i=>i.classList.toggle("relation--filtered",!n))}getRelations(){const e=new Set(Array.from(this.paths,n=>n.getAttribute("type")));this.fields=Array.from(e,n=>({type:n,checked:!0,el:null}))}hasRelationType(e){return this.fields.some(n=>n.type==e)}wasLastOfType(e){return!Array.from(this.paths).some(n=>n.getAttribute("type")==e)}render(){let e=this.fields.map(n=>this.createFilterElement(n)).join(" ");this.ctn.innerHTML=e}}class ps{constructor(){U(this,"createFiltersGroups",()=>[new Yt("relation",{filterCtnId:"relations-filters"}),new Yt("metarelation",{filterCtnId:"meta-relations-filters"})]);U(this,"createMutationObserver",()=>new MutationObserver(e=>{if(e.filter(s=>s.type=="attributes"&&s.attributeName=="type").filter(s=>s.target.getAttribute("type")!=s.oldValue).length>0)return this.update();const i=e.length==1&&e.filter(s=>{var o;return s.type=="childList"&&((o=s.addedNodes)==null?void 0:o.length)==1}).map(s=>{var o;return(o=s.addedNodes)==null?void 0:o.item(0)}).find(st.isElement);if(i){const s=i.getAttribute("type");if(!this.groups.some(a=>a.hasRelationType(s)))return this.update()}const r=e.length==1&&e.filter(s=>{var o;return s.type=="childList"&&((o=s.removedNodes)==null?void 0:o.length)==1}).map(s=>{var o;return(o=s.removedNodes)==null?void 0:o.item(0)}).find(st.isElement);if(r){const s=r.getAttribute("type");if(this.groups.some(a=>a.wasLastOfType(s)))return this.update()}}));this.visible=!1,this.ctn=document.getElementById("filters"),this.toggleBtn=document.getElementById("filters-toggle"),this.observer=this.createMutationObserver(),this.groups=this.createFiltersGroups()}onTap({target:e}){e==this.toggleBtn&&this.toggle()}onChange(e){this.groups.forEach(n=>n.onChange(e))}onScoreLoad(){this.toggle(!1),this.observer.disconnect(),this.update(),this.observe()}observe(){this.observer.observe(document.querySelector("#layers .svg_container > svg .page-margin"),{subtree:!0,childList:!0,attributeOldValue:!0,attributeFilter:["type"]})}toggle(e=!this.visible){this.visible=e,this.ctn.classList.toggle("fly-out--expanded",e),this.ctn.classList.toggle("fly-out--collapsed",!e)}update(){this.groups.forEach(e=>e.getRelations()),this.groups.forEach(e=>e.render())}}const ys=new ps;var me={title:{label:"Title",saveBtn:"Update title",placeholder:"The name \u266A of the song \u266B"},roles:{composer:{label:"Composer",saveBtn:"Update composer",placeholder:"Wolfgang Amadeus Mozart"},analyst:{label:"Analyst",saveBtn:"Assign responsibility",placeholder:"Maybe\u2026 you?"},annotator:{label:"Annotator",saveBtn:"Assign responsibility",placeholder:"Maybe\u2026 you?"}}};const Rn=(t,{label:e,placeholder:n=""},i="")=>`
  <label class="fillable fly-out__title" for="metadata-${t}">
      ${e}
      <input
          class="fillable__input"
          id="metadata-${t}"
          type="text"
          placeholder="${n}"
          value="${i}"
      >
  </label>
`,Yn=(t,{saveBtn:e})=>`
  <button
      class="btn btn--plain btn--small"
      id="metadata-${t}-assign"
      type="button"
      data-role="${t}"
  >${e}</button>
`,vs=t=>t.map(({role:e,config:n,value:i})=>`
    <hr class="fly-out__hr">
    ${Rn(e,n,i)}
    ${Yn(e,n)}
  `).join(""),bs=new DOMParser,_s=new RegExp(/^metadata-(\w+)-assign$/);class Es{constructor(){this.visible=!1,this.ctn=document.getElementById("metadata"),this.toggleBtn=document.getElementById("metadata-toggle"),this.persRoles=Object.keys(me.roles),this.formDOM={ctn:document.getElementById("metadata-form")},this.formDOM.inputs=this.formDOM.ctn.getElementsByClassName("fillable__input"),this.scoreHead={titleStmt:null,title:null,respStmt:null,respPersName:[]}}onTap({target:e}){var i;if(e==this.toggleBtn)return this.toggle();let n=(i=e.id.match(_s))==null?void 0:i[1];n&&this.updateScoreMetadata(n)}onScoreLoad(){this.initScore(),this.initFields()}toggle(e=!this.visible){this.visible=e,this.ctn.classList.toggle("fly-out--expanded",e),this.ctn.classList.toggle("fly-out--collapsed",!e)}updateScoreMetadata(e){const n=[...this.formDOM.inputs].find(({id:s})=>s=`metadata-${e}`);if(!n)return;const i=n.value;if(e=="title"){this.scoreHead.title[0].innerHTML=i;return}const r=this.persNames.find(s=>s.role==e);r.value=i,r.el.innerHTML=i,e!="composer"&&T.flatSelection.forEach(s=>{const o=_(s),a=y(T.mei,o);(a.tagName=="note"?a:a.firstChild).setAttribute("resp",e)})}initScore(){this.scoreHead.titleStmt=T.mei.querySelector("meiHead fileDesc titleStmt"),!!this.scoreHead.titleStmt&&(this.initStmtEl("title"),this.initStmtEl("respStmt"),this.initRoles())}initStmtEl(e){if(this.scoreHead[e]=this.scoreHead.titleStmt.getElementsByTagName(e),!this.scoreHead[e].length){const n=T.mei.createElement(e);this.scoreHead.titleStmt.appendChild(n)}}initRoles(){this.scoreHead.respPersName=this.scoreHead.respStmt[0].getElementsByTagName("persName"),this.persNames=Array.from(this.scoreHead.respPersName).filter(e=>this.persRoles.includes(e.getAttribute("role"))).map(e=>({el:e,role:e.getAttribute("role"),value:e.innerHTML,config:me.roles[e.getAttribute("role")]})),this.persRoles.filter(e=>!this.persNames.find(n=>n.role==e)).forEach(e=>this.initRole(e))}initRole(e){const n=bs.parseFromString(`<persName role="${e}" xml:id="${e}" />`,"text/xml").firstChild;this.scoreHead.respStmt[0].appendChild(n),this.persNames.push({el:n,role:e,value:"",config:me.roles[e]})}initFields(){this.formDOM.ctn.innerHTML=Rn("title",me.title,this.scoreHead.title[0].innerHTML)+Yn("title",me.title)+vs(this.persNames)}}const Ms=new Es;class Ns{constructor(){this.update()}onResize(){this.update()}update(){this.w=window.innerWidth,this.h=window.innerHeight}}const _e=new Ns;class As{constructor(){this.toLeftBtn=document.getElementById("to-left"),this.toRightBtn=document.getElementById("to-right")}onTap(e){if(e.target==this.toLeftBtn)return this.toLeft();if(e.target==this.toRightBtn)return this.toRight()}toLeft(){this.goTo(-(_e.w-200))}toRight(){this.goTo(_e.w-200)}goTo(e){V.scrollBy(e,0)}}const xs=new As;class $n{constructor(e){U(this,"hide",()=>this.toggleVisibility(!1));this.ctn={el:document.getElementById(e)},this.closeBtn=this.ctn.el.querySelector(".fly-out__closeBtn"),this.visible=!1}onTap(e){if(!!e.composedPath().includes(this.ctn.el)&&e.target==this.closeBtn)return this.toggleVisibility(!1)}toggleVisibility(e=!this.visible){this.ctn.el.classList.toggle("fly-out--visible",e),this.visible=e}}function Ts(t,e=null){t.preventDefault(),e&&e.call()}const Is=10,$t=(t,e=1)=>`${ve(t/Is,e)}rem`,we=10;var te;class Ls extends $n{constructor(e){super(e);ne(this,te,!1);this.dragHandle={el:this.ctn.el.querySelector(".fly-out__drag")},this.visible=!1,this.x=0,this.y=0,this.computeValues()}onTapStart(e){e.target==this.dragHandle.el&&Ts(e,()=>this.toggleDragging(!0))}onTapMove(e,n){this.visible&&S(this,te)&&this.updatePosition(e,n)}onTapEnd(){this.visible&&S(this,te)&&(this.toggleDragging(!1),this.computeValues())}onResize(){!this.visible||this.computeValues()}updatePosition(e=this.x,n=this.y){this.x=e-this.ctn.handleDeltaX,this.y=n-this.ctn.handleDeltaY,this.ctn.el.style.setProperty("--fly-out-x",$t(this.x,2)),this.ctn.el.style.setProperty("--fly-out-y",$t(this.y,2))}toggleDragging(e=!S(this,te)){ge(this,te,e),this.ctn.el.classList.toggle("fly-out--grabbing",e),V.classList.toggle("dragging-fly-out",e)}snapInViewport(){const e=ce(this.x,we,_e.w-this.ctn.width-we),n=ce(this.y,we,_e.h-this.ctn.height-we);(e!=this.x||n!=this.y)&&(this.ctn.el.classList.add("fly-out--snapping"),this.ctn.el.addEventListener("transitionend",this.onSnapTransitionEnd.bind(this)),this.updatePosition(e+this.ctn.handleDeltaX,n+this.ctn.handleDeltaY))}onSnapTransitionEnd({propertyName:e}){e=="transform"&&(this.ctn.el.classList.remove("fly-out--snapping"),this.ctn.el.removeEventListener("transitionend",this.onSnapTransitionEnd.bind(this)))}computeValues(){const e=["x","y","width","height"];Object.assign(this.ctn,zt(this.ctn.el,e)),Object.assign(this.dragHandle,zt(this.dragHandle.el,e)),this.ctn.handleDeltaX=this.dragHandle.x-this.ctn.x+this.dragHandle.width/2,this.ctn.handleDeltaY=this.dragHandle.y-this.ctn.y+this.dragHandle.height/2,this.snapInViewport()}}te=new WeakMap;const Mt={hideIfCompact:"hide-when-compact",hideIfNotCompact:"hide-when-not-compact"},ws=t=>`
  <div class="fly-out__headerRow">
      <div class="fly-out__title fly-out__title--big">
          ${gt(t)}s
      </div>
  </div>
`,Bs=(t,e,n)=>`
  <button
      type="button"
      class="
        btn btn--hollow btn--relation color-relation-${t}
        ${n>2?Mt.hideIfCompact:""}
      "
      data-relation-name="${t}"
      data-relation-type="${e}"
  >
      ${gt(t)}
  </button>
`,Ss=t=>`
  <button
      type="button"
      class="fly-out__showMore ${Mt.hideIfNotCompact} | btn btn--hollow"
  >
      <span class="visually-hidden">View more ${t}</span>
      &hellip;
  </button>
`,Ds=(t,e)=>`
  <form
      class="btn-group btn-group--free-field hide-when-compact"
      id="free-field-${e}-form"
  >
      ${Cs(e,{label:"Or type a "+t.name})}
      ${js(t.additional,e)}

      <button class="btn btn--plain btn--small">
          Assign <span class="visually-hidden>${e}</span>
      </button>
  </form>
`,Cs=(t,{label:e,placeholder:n=""})=>`
  <label
      class="fillable fly-out__relationsField ${Mt.hideIfCompact}"
      for="free-field-${t}"
  >
      <span class="fillable__label">
          <span class="fillable__label__text">${e}</span>
          <svg class="fillable__label__triangle | btn__icon" width="10" height="8">
              <use xlink:href="#triangle-path"/>
          </svg>
      </span>

      <input
          class="fillable__input"
          id="free-field-${t}"
          type="text"
          list="datalist-${t}"
          placeholder="${e}"
          data-relation-type="${t}"
      >
  </label>
`,js=(t,e)=>`
  <datalist id="datalist-${e}">${ks(t)}</datalist>
`,ks=t=>t.map(zs).join(""),zs=t=>`<option value="${t}">`;var le;class et{constructor(e,n,i={}){ne(this,le,!1);this.type=e,this.name=n.name,this.eventCallbacks=i,this.initHtml(n)}get isVisible(){return S(this,le)}show(){this.toggleVisibility(!0)}hide(){this.toggleVisibility(!1)}toggleVisibility(e=!S(this,le)){ge(this,le,e),this.ctn.classList.toggle("fly-out__relationsBtnsCtn--visible",e)}select(e){if(this.unselect(),!e)return;const n=Array.from(this.btns).filter(s=>e.has(s.dataset.relationName));if(n.forEach(s=>s.classList.add("btn--selected")),e.size<=n.length)return;const i=n.map(s=>s.dataset.relationName),r=[...e].filter(s=>!i.includes(s));this.freeFieldCtn.classList.add("fly-out__relationsField--selected"),r.length==1&&(this.freeField.value=r[0])}unselect(){Array.from(this.selectedBtns).forEach(e=>e.classList.remove("btn--selected")),this.freeFieldCtn.classList.remove("fly-out__relationsField--selected"),this.freeField.value=""}initHtml(e){var s;const n=ws(e.name);let i=Object.keys(e.main).map((o,a)=>Bs(o,this.type,a)).join("");(e.main.length>3||"additional"in e)&&(i+=Ss(this.type)),i=`<div class="btn-group">${i}</div>`;const r="additional"in e?Ds(e,this.type):"";this.ctn=document.getElementById(`${this.type}-btns`),this.ctn.innerHTML=n+i+r,this.btns=this.ctn.getElementsByClassName("btn--relation"),this.selectedBtns=this.ctn.getElementsByClassName("btn--selected"),this.freeField=this.ctn.querySelector(`#free-field-${this.type}`),this.freeFieldCtn=(s=this.freeField)==null?void 0:s.parentElement}}le=new WeakMap;const Os=new RegExp(/^free-field-(\w+)-form$/);class Us extends Ls{constructor(){super("relations-menu");this.innerCtn=document.getElementById("relations-btns-ctn"),this.deleteBtn=this.ctn.el.querySelector(".fly-out__deleteBtn"),this.init()}get visibleGroups(){return[this.relations,this.metarelations,this.comborelations].filter(({isVisible:e})=>e)}onTap(e){if(super.onTap(e),e.target==this.deleteBtn)return vt();const{dataset:n,classList:i}=e.target,r=i.contains("fly-out__compact"),s=i.contains("fly-out__showMore");if(r||s)return this.compact(r),this.computeValues();!(n==null?void 0:n.hasOwnProperty("relationType"))||i.contains("btn--relation")&&this[n.relationType].eventCallbacks.tap(n.relationName)}onSubmit(e){var r,s;const n=(r=e.target.id.match(Os))==null?void 0:r[1];if(!n)return;e.preventDefault();const{value:i}=(s=this[n])==null?void 0:s.freeField;i&&this[n].eventCallbacks.tap(i)}onScoreSelection(){const{hasSelection:e,selectionType:n,selectedRelationTypes:i}=T;this.relations.select(n=="relation"?i:new Set),this.metarelations.select(n=="metarelation"?i:new Set),this.toggleVisibility(e),this.reorder(),this.relations.show(),this.metarelations.toggleVisibility(n!="note"),this.compact(),this.deleteBtn.disabled=!e||n=="note",T.flatSelection.length==1&&this.computeValues()}reorder(){if(T.flatSelection.length!==1)return;const e=Br(T.selectionType);for(let n=e.length-1;n>0;n--)this.innerCtn.insertBefore(this[e[n-1]].ctn,this[e[n]].ctn)}compact(e=null){if(!T.flatSelection.length)return;e!=null&&(this.ctn.el.classList.toggle("fly-out--relations-compact",e),this.ctn.el.classList.toggle("fly-out--big",!e));const n=T.selectionType=="note"&&T.flatSelection.length>2&&T.selection.extraselected.length<3;this.comborelations.toggleVisibility(n)}init(){this.relations=new et("relations",Mn,{tap:K}),this.metarelations=new et("metarelations",Nn,{tap:xt}),this.comborelations=new et("comborelations",ct,{tap:qn}),this.title=this.ctn.el.querySelector(".fly-out__title")}}const Rs=new Us,Ys=t=>{console.log(t);const e=T.selectionType;return t.length?(e=="note"?Gi(t).map($s):t.map(Qs)).join(""):"-"},$s=t=>`<li class="selection__listItem">${t.toUpperCase()}</li>`,Qs=t=>`<li class="selection__listItem">${t.getAttribute("type")}</li>`;class Hs extends $n{constructor(){super("selection-legend");this.title=document.getElementById("selection-type"),this.primary=document.getElementById("selection-primary"),this.primaryList=document.getElementById("selection-list-primary"),this.secondary=document.getElementById("selection-secondary"),this.secondaryList=document.getElementById("selection-list-secondary"),this.hide()}update({selected:e,extraselected:n}){this.toggleVisibility(T.hasSelection),this.visible&&(this.updateTitle(),this.updateRow("primary",n),this.updateRow("secondary",e))}updateTitle(){this.title.innerHTML=T.selectionType?`Selected ${T.selectionType}s`:"Selection is empty"}updateRow(e,n){this[e].classList.toggle("none",!n.length),this[`${e}List`].innerHTML=Ys(n)}}class Vs{constructor(){this.primary=document.getElementById("selection-mode-primary"),this.secondary=document.getElementById("selection-mode-secondary")}set(e){this.mode=e,this.updateBtns()}updateBtns(){this[this.mode].checked=!0}onChange({target:e}){e.name=="selection-mode"&&this.set(e.value)}}class Ps{constructor(){this.selectBtn=document.getElementById("select-all"),this.unselectBtn=document.getElementById("unselect-all"),this.legend=new Hs,this.mode=new Vs}selectAll(){const e=M();e&&Cr(e)}selectNone(){be()}onTap({target:e}){if(e==this.selectBtn)return this.selectAll();if(e==this.unselectBtn)return this.selectNone()}onScoreSelection(e){this.legend.update(e)}}const Fs=new Ps,tt=1,Qn=1.1,Ws=1/Qn;class qs{constructor(){this.zoomInBtn=document.getElementById("zoom-in"),this.zoomOutBtn=document.getElementById("zoom-out"),this.resetBtn=document.getElementById("zoom-reset"),this.levelEl=document.getElementById("zoom-level")}onTap({target:e}){if(e==this.zoomInBtn)return this.in();if(e==this.zoomOutBtn)return this.out();if(e==this.resetBtn)return this.reset()}in(){this.by(Qn)}out(){this.by(Ws)}reset(){this.by(tt)}by(e=1){const n=M();!n||(n.zoom=e==tt?tt:n.zoom*e,n.svg_elem.style.transform=`scale(${n.zoom})`,this.levelEl.innerHTML=this.format(n.zoom))}format(e){return`${Math.round(e*100)}%`}}const Zs=new qs;class Gs{constructor(){this.btn=document.getElementById("new-note"),this.isActive=!1}toggle(){var e;this.isActive=(e=_n())!=null?e:!1,this.btn.classList.toggle("btn--something-active-for-new-note",this.isActive)}enable(){vn(),this.btn.classList.add("btn--something-active-for-new-note"),this.isActive=!0}disable(){bn(),this.btn.classList.remove("btn--something-active-for-new-note"),this.isActive=!1}onTap({target:e}){e==this.btn&&this.toggle()}}const Xs=new Gs;class Js{constructor(e="",n){this.ctn=document.getElementById(`${e}-progress-ctn`),this.setMinMax(n),this.update(n.value)}setMinMax({min:e,max:n}){this.min=parseInt(e),this.max=parseInt(n)}update(e=this.value){e=parseFloat(e);let n=(e-this.min)/(this.max-this.min);n=ve(n,3),this.setBar(n)}setBar(e){this.ctn.style.setProperty("--progress",ce(0,e,1))}}class Ks{constructor(){this.input=document.getElementById("relation-width");const{min:e,max:n,value:i}=this.input;this.progressBar=new Js("relation-width",{min:e,max:n,value:i}),this.throttling=!1}onInput({target:e}){e!=this.input||this.throttling||(this.throttling=!0,requestAnimationFrame(()=>{const n=parseInt(e.value);this.progressBar.update(n),Qr(n),this.throttling=!1}))}}const eo=new Ks,to=1e4;class no{constructor(){this.ctn=document.getElementById("player-and-score-settings"),this.toggleVisibilityBtn=document.getElementById("score-settings-toggle"),this.toggleShadesBtn=document.getElementById("settings-shades"),this.toggleStemsBtn=document.getElementById("settings-stems"),this.toggleTonesBtn=document.getElementById("settings-non-related-tones"),this.expanded=!1,this.autoCloseTimer=null,this.brightShades=!0}get interacting(){const e=this.hasInteractionWith(this.ctn),n=this.hasInteractionWith(document.activeElement);return e||n}hasInteractionWith(e){return getComputedStyle(e).getPropertyValue("--in-player-and-score-settings").trim()=="1"}startAutoCloseTimer(){clearTimeout(this.autoCloseTimer),this.autoCloseTimer=setTimeout(()=>{if(this.interacting)return this.startAutoCloseTimer();this.toggleVisibility(!1)},to)}onTap(e){if(!e.composedPath().includes(this.ctn))return this.toggleVisibility(!1);if(this.startAutoCloseTimer(),e.target==this.toggleVisibilityBtn)return this.toggleVisibility(!0);if(e.target==this.toggleShadesBtn)return this.toggleShades();if(e.target==this.toggleStemsBtn)return this.toggleStems();if(e.target==this.toggleTonesBtn)return Kr()}toggleVisibility(e=!this.expanded){this.expanded=e,V.classList.toggle("ui-score-settings-visible",e)}toggleShades(e=!this.brightShades){this.brightShades=e,V.classList.toggle("shades-alternate",!e)}toggleStems(){Ur()}}const io=new no;class ro{constructor(){this.ctn=document.getElementById("ui"),this.init()}onTap(e){var n,i,r,s,o,a,c,l,d,m;(n=this.relations)==null||n.onTap(e),(i=this.scoreSettings)==null||i.onTap(e),!!e.composedPath().includes(this.ctn)&&((r=this.mainMenu)==null||r.onTap(e),(s=this.zoom)==null||s.onTap(e),(o=this.selection)==null||o.onTap(e),(a=this.metadata)==null||a.onTap(e),(c=this.navigation)==null||c.onTap(e),(l=this.filters)==null||l.onTap(e),(d=this.newNote)==null||d.onTap(e),(m=this.layersMenu)==null||m.onTap(e))}onTapStart(e){var n;(n=this.relations)==null||n.onTapStart(e)}onTapMove(e,n){var i;(i=this.relations)==null||i.onTapMove(e,n)}onTapEnd(){var e;(e=this.relations)==null||e.onTapEnd()}onResize(){var e;(e=this.relations)==null||e.onResize()}onScoreLoad(e){var n,i,r;(n=this.filters)==null||n.onScoreLoad(e),(i=this.metadata)==null||i.onScoreLoad(e),(r=this.layersMenu)==null||r.onScoreLoad(e)}onScoreSelection({detail:e}){var n,i;(n=this.selection)==null||n.onScoreSelection(e),(i=this.relations)==null||i.onScoreSelection()}init(){this.startScreen=Ti,this.mainMenu=Li,this.zoom=Zs,this.selection=Fs,this.navigation=xs,this.metadata=Ms,this.filters=ys,this.relations=Rs,this.newNote=Xs,this.relationWidth=eo,this.scoreSettings=io,this.layersMenu=ut}}const so=new ro;class oo{constructor(){this.undoBtn=document.getElementById("undo"),this.redoBtn=document.getElementById("redo"),this.updateBtns(0,0)}onTap({target:e}){if(e==this.undoBtn)return this.undo();if(e==this.redoBtn)return this.redo()}undo(){hn()}redo(){mn()}updateBtns(e=0,n=0){this.undoBtn.toggleAttribute("disabled",e==0),this.redoBtn.toggleAttribute("disabled",n==0)}onUndoRedo({detail:e}){this.updateBtns(e.undoAbleCount,e.redoAbleCount)}}const ao=new oo;class lo{constructor(){this.init()}init(){V.classList.replace("loading","ready"),this.viewport=_e,Mi(this),this.ui=so,this.score=T,this.player=ot,this.history=ao}}const Te=new lo;function Hn(t,e,n){const i=new Blob([t],{type:n}),r=document.createElement("a");r.style.display="none",r.href=URL.createObjectURL(i),r.download=e,document.body.appendChild(r),r.click(),setTimeout(()=>{URL.revokeObjectURL(r.href),r.remove()},0)}function co(t,e,n,i,r){var s=[],o=t.getRootNode().createElement("node");o.setAttribute("type","relation");var a=t.getRootNode().createElement("label");typeof i!="undefined"&&a.setAttribute("type",i),o.appendChild(a);var c;typeof r=="undefined"?c="he-"+ht(5):c=r,o.setAttribute("xml:id",c),t.appendChild(o),s.push(o);for(var l=0;l<e.length;l++){var d=mei.createElement("arc");d.setAttribute("from","#"+c),d.setAttribute("to","#"+e[l].getAttribute("xml:id")),d.setAttribute("type","primary"),t.appendChild(d),s.push(d)}for(var l=0;l<n.length;l++){var d=mei.createElement("arc");d.setAttribute("from","#"+c),d.setAttribute("to","#"+n[l].getAttribute("xml:id")),d.setAttribute("type","secondary"),t.appendChild(d),s.push(d)}return[c,s.reverse()]}function uo(t,e,n,i,r){var s=[],o=t.getRootNode().createElement("node");o.setAttribute("type","metarelation");var a=t.getRootNode().createElement("label");typeof i!="undefined"&&a.setAttribute("type",i),o.appendChild(a);var c;typeof r=="undefined"?c="he-"+Math.floor(Math.random()*(1<<20)).toString(16):c=r,o.setAttribute("xml:id",c),t.appendChild(o),s.push(o);for(var l=0;l<e.length;l++){var d=t.getRootNode().createElement("arc");d.setAttribute("from","#"+c),d.setAttribute("to","#"+e[l].getAttribute("xml:id")),d.setAttribute("type","primary"),t.appendChild(d),s.push(d)}for(var l=0;l<n.length;l++){var d=t.getRootNode().createElement("arc");d.setAttribute("from","#"+c),d.setAttribute("to","#"+n[l].getAttribute("xml:id")),d.setAttribute("type","secondary"),t.appendChild(d),s.push(d)}return[c,s.reverse()]}function go(t,e,n){const i=n.findIndex(s=>s.nodeType==Node.ELEMENT_NODE&&(s.tagName=="note"||s.getElementsByTagName("note").length>0))==-1;if((e.tagName=="beam"||e.tagName=="measure")&&i)return null;if(e.tagName=="chord"&&i)return nr(mei,e);var r=e.cloneNode();return r.setAttribute("corresp",e.getAttribute("xml:id")),n.forEach(s=>r.appendChild(s)),r}function Vn(t,e){if(e.nodeType!=Node.ELEMENT_NODE)return[e.cloneNode(),!1];var n=document.getElementById(B(t,_(e)));if(e.tagName=="note"&&(!n||n.classList.contains("hidden")))return[er(mei,e),!0];var i=Array.from(e.childNodes).map(o=>Vn(t,o)),r=i.map(o=>o[0]).filter(o=>o!=null),s=r.length!=e.childNodes.length||i.find(o=>o[1])!=null;return[go(s,e,r),s]}function ho(t=null){t||(t=Y()[0]);var e=t.mei_mdiv;e.children[0];var[n,i]=Vn(t,e),r=e.parentElement.getElementsByTagName("mdiv").length,s=r+"-";return yt(n,s),e.parentNode.insertBefore(n,e.nextSibling),n}function Nt(t,e){if(!t.contains(e))return console.log("MDiv element not in MEI, aborting"),null;var n=ir(t),i;e.hasAttribute("xml:id")?i=y(n,e.getAttribute("xml:id")):i=n.getElementsByTagName("mdiv")[0];var r=i.parentElement;for(let s of Array.from(r.getElementsByTagName("mdiv")))s!==i&&r.removeChild(s);return n}function mo(t,e,n=!1){var i=qe(),r=Jn(!0,t),s=new XMLSerializer().serializeToString(r),o=e.children[0];i.loadData(s),i.renderToMIDI();var a=Array.from(r.getElementsByTagName("note")),c=a.map(v=>v.getAttribute("xml:id")),l={};if(c.forEach(v=>{if(!v)return;let N=i.getTimeForElement(v);l[N]?l[N].push(v):l[N]=[v]}),n){let v=Object.keys(l);l={},v.forEach(N=>l[N]=i.getElementsAtTime(Number(N)+1).notes)}var d=o.getElementsByTagName("scoreDef")[0].cloneNode(!0),m=d.getElementsByTagName("staffDef"),u=mei.createElement("mdiv");u.setAttribute("xml:id",e.getAttribute("xml:id")+"-sliced");var g=mei.createElement("score");g.setAttribute("xml:id",o.getAttribute("xml:id")+"-sliced");var h=mei.createElement("section");h.setAttribute("xml:id",o.getAttribute("xml:id")+"-slicedsection"),u.appendChild(g),g.appendChild(d),g.appendChild(h);var p=Object.keys(l);console.log(l);for(var f in p){let v=p[f],N=l[v],$=mei.createElement("measure");$.setAttribute("xml:id","measure-"+v),h.appendChild($);for(var L of m){let A=mei.createElement("staff");A.setAttribute("n",L.getAttribute("n")),$.appendChild(A)}N.forEach(A=>{let P=y(mei,A),F=P.cloneNode(!0);F.setAttribute("corresp",A);let ti=P.closest("staff").getAttribute("n"),It=P.closest("layer").getAttribute("n"),Lt=P.closest("chord"),Ge=$.querySelector('staff[n="'+ti+'"]');Ge||(console.log("Could not find staff"),abort());let ee=Ge.querySelector('layer[n="'+It+'"]');if(ee||(ee=mei.createElement("layer"),ee.setAttribute("n",It),Ge.appendChild(ee)),F.removeAttribute("dots"),F.removeAttribute("dots.ges"),Lt){let G=Lt.getAttribute("xml:id"),X=ee.querySelector('chord[corresp="'+G+'"]');X||(X=mei.createElement("chord"),X.setAttribute("corresp",G),X.setAttribute("dur",4),X.setAttribute("dur.ges",4),X.setAttribute("dur.ppq",2),ee.appendChild(X)),X.appendChild(F)}else F.setAttribute("dur",4),F.setAttribute("dur.ges",4),F.setAttribute("dur.ppq",2),ee.appendChild(F);if(f>0&&l[p[f-1]].includes(A)){F.setAttribute("xml:id",v+A);let G=mei.createElement("tie");G.setAttribute("xml:id","tie"+v+A),G.setAttribute("endid",v+A),f>1&&l[p[f-2]].includes(A)?G.setAttribute("startid",p[f-1]+A):G.setAttribute("startid",A),$.appendChild(G)}});for(var x of $.querySelectorAll("staff"))if(!x.querySelector("note")){let A=x.querySelector("layer");A||(A=mei.createElement("layer"),x.appendChild(A));let P=mei.createElement("rest");P.setAttribute("dur",4),P.setAttribute("dur.ges",4),P.setAttribute("dur.ppq",2),A.appendChild(P)}}return u}function fo(t,e=!1){var n=t.mei_mdiv,i=mo(t,n,e),r=n.parentElement.getElementsByTagName("mdiv").length,s=r+"-";return yt(i,s),n.parentNode.insertBefore(i,n.nextSibling),i}function Pn(t,e,n){var i=[],r=t.svg_elem,s=t.id_prefix,o=s+n.getAttribute("xml:id"),a=mt(n),c=He(e,n).map(u=>document.getElementById(B(t,j(u)))),l=q(e,n).map(u=>document.getElementById(B(t,j(u)))),d=c.concat(l);if(d.sort((u,g)=>{if(!u)return-1;if(!g)return 1;var h=D(u),p=D(g);return h[0]-p[0]?h[0]-p[0]:h[1]-p[1]}),!d[0])return console.log("Note missing, relation not drawn"),null;var m=qt(d.map(D));return m.setAttribute("id",o),s!=""&&m.setAttribute("oldid",n.getAttribute("xml:id")),m.classList.add("relation"),m.setAttribute("type",a),J(m),Te.ui.scoreSettings.brightShades||J(m),m.addEventListener("wheel",u=>{u.preventDefault(),Ye(u.target),u.target.onmouseout()},C),m.onclick=()=>b(m),m.onmouseover=function(){c.forEach(u=>u.classList.add("extrahover")),l.forEach(u=>u.classList.add("selecthover"))},m.onmouseout=function(){c.forEach(u=>u.classList.remove("extrahover")),l.forEach(u=>u.classList.remove("selecthover"))},$e(r,m),i.push(m),i}function Fn(t,e,h){var i=[],r=t.svg_elem,s=t.id_prefix,o=s+h.getAttribute("xml:id"),a=mt(h),c=Qe(e,h).map(p=>document.getElementById(t.id_prefix+_(p))),l=He(e,h).map(p=>document.getElementById(B(t,j(p)))),d=q(e,h).map(p=>document.getElementById(B(t,j(p))));if(c.indexOf(null)!=-1)return console.log("Missing relation, not drawing metarelation"),[];var m=c.map(Zi),u=rn(m.map(p=>p[0])),g=c.concat([r.getElementsByClassName("system")[0]]).map(p=>p.getBBox().y).sort((p,f)=>p>f)[0]-500;m.push([u,g]);var h=De();return h.style.setProperty("--shade-alternate","#000"),h.setAttribute("id",o),h.classList.add("metarelation"),h.setAttribute("type",a),h.appendChild(Gt([u,g],200)),m.forEach(p=>{var f=Zt([u,g],p);h.appendChild(f)}),J(h),Te.ui.scoreSettings.brightShades||J(h),h.addEventListener("wheel",p=>{p.preventDefault(),Ye(p.target.closest("g")),p.target.onmouseout()},C),h.onclick=()=>b(h),h.onmouseover=function(p){l.forEach(f=>{f.classList.contains("relation")?f.classList.add("extrarelationhover"):f.children[0].classList.add("extrarelationhover")}),d.forEach(f=>{f.classList.contains("relation")?f.classList.add("relationhover"):f.children[0].classList.add("relationhover")})},h.onmouseout=function(p){l.forEach(f=>{f.classList.contains("relation")?f.classList.remove("extrarelationhover"):f.children[0].classList.remove("extrarelationhover")}),d.forEach(f=>{f.classList.contains("relation")?f.classList.remove("relationhover"):f.children[0].classList.remove("relationhover")})},$e(r,h),i.push(h),i}window.selected=[];window.extraselected=[];var se;window.mei=null;var I,Qt,Wn,oe,nt=new FileReader,ye,Ee=[],At=[],w=[],Re=[];window.addEventListener("beforeunload",function(t){var e="Leave app? You may lose unsaved changes.";return t.preventDefault(),t.returnValue=e,e});E(document).ready(function(){document.getElementsByTagName("html")[0].classList.remove("loader"),Hr(document.getElementById("relations_panel")),xn(),Eo()});window.onerror=function(e,n,i){return document.getElementsByTagName("html")[0].classList.remove("loader"),alert(`An error occured: ${e}
 Please report the relevant console log as a GitHub issue.
 The app will try to continue running nonetheless.`),!1};function K(t,e,n=!1){if(console.debug("Using globals: selected, extraselected, mei, undo_actions"),!(selected.length==0&&extraselected==0)){var i,r;if(selected.concat(extraselected)[0].classList.contains("relation")){var s=[];selected.concat(extraselected).forEach(d=>{s.push([d.getAttribute("type"),t]);var m=ke(d),u=[y(document,m)].concat(Kt(document,m));u.forEach(h=>h.setAttribute("type",t));var g=y(mei,m);g.getElementsByTagName("label")[0].setAttribute("type",t),u.forEach(J)}),Ee.push(["change relation type",s.reverse(),selected,extraselected])}else if(selected.concat(extraselected)[0].classList.contains("note")){sr(t,extraselected,selected);var o=[],a=extraselected.map(d=>Rt(I,d)),c=selected.map(d=>Rt(I,d));o.push(a.concat(c)),[i,r]=co(I,a,c,t,e),o.push(r);for(var l=0;l<w.length;l++){let d=Pn(w[l],I,y(I.getRootNode(),i));d&&(o.push(d),ft(w[l],I,y(I.getRootNode(),i)))}Ee.push(["relation",o.reverse(),selected,extraselected]),selected.concat(extraselected).forEach(b)}n||Pe(),ue()}}function qn(t){var e=selected.concat(extraselected);if(!(e.length<3||extraselected.length>2)){e.sort((r,s)=>{var[o,a]=D(r),[c,l]=D(s);return o-c});var n=e.shift(),i=e.pop();selected=selected.filter(r=>r==n||r==i),K(ct.main[t].outer),extraselected=[n,i],selected=e,K(ct.main[t].total),ue()}}function xt(t,e,n=!1){if(console.debug("Using globals:  mei_graph, selected, extraselected"),!(selected.length==0&&extraselected==0)){var i=Z(selected.concat(extraselected)[0]);if(i=="relation"||i=="metarelation"){var r=[],a,c,s=extraselected.map(d=>y(I.getRootNode(),ke(d))),o=selected.map(d=>y(I.getRootNode(),ke(d))),[a,c]=uo(I,s,o,t,e);r.push(c);for(var l=0;l<w.length;l++)r.push(Fn(w[l],I,y(I.getRootNode(),a)));Ee.push(["metarelation",r,selected,extraselected]),selected.concat(extraselected).forEach(b),ue(),n||Pe()}}}var Zn;function po(){console.debug("Using globals: mei");var t=mei.getElementsByTagName("graph");if(t.length)return t[0];var e=mei.createElement("graph");return e.setAttribute("type","directed"),mei.getElementsByTagName("body")[0].appendChild(e),e}function yo(){var t=mei.cloneNode(!0);for(var e of w)if(!e.canSave){console.log("Trying to remove layer",e);var n=y(t,e.mei_mdiv.getAttribute("xml:id"));n.parentElement.removeChild(n),console.log("Found and tried to remove ",n)}var i=new XMLSerializer().serializeToString(t);Hn(i,ye+".mei","text/xml")}const Ht=t=>{const e=getComputedStyle(t);Vt(t,{fill:e.fill,"fill-opacity":e.fillOpacity,opacity:e.opacity,stroke:e.stroke,"stroke-opacity":e.strokeOpacity,"stroke-width":e.strokeWidth})};function vo(){const e=M().svg_elem.children[0].cloneNode(!0);document.getElementById("svg-spreadsheet").append(e);const n=e.getElementsByClassName("relation"),i=e.getElementsByClassName("metarelation");Array.from(n).forEach(Ht),Array.from(i).forEach(Ht);const r=new XMLSerializer().serializeToString(e);e.remove(),Hn(r,ye+".svg","text/xml")}function Gn(t){console.debug("Using globals: selected_extraselected, upload, reader, filenmae");const e=t.target.files;selected=[],extraselected=[],e.length==1&&(nt.onload=function(n){oe=nt.result,bo(),Pr()},nt.readAsText(e[0]),ye=e[0].name.split(".").slice(0,-1).join("."),ye==""&&(ye=e[0].name))}function Xn(t){console.debug("Using globals: mei_graph, mei, selected, extraselected, document");var e=Array.from(I.getElementsByTagName("node")),n=e.filter(r=>r.getAttribute("type")=="relation"),i=e.filter(r=>r.getAttribute("type")=="metarelation");n.forEach(r=>{Pn(t,I,r)&&ft(t,I,r)}),i.forEach(r=>Fn(t,I,r))}function bo(t){console.debug("Using globals data, parser, mei, jquery document, document, mei_graph, midi, changes, undo_cations, redo_actions, reduce_actions, rerendered_after_action");var e=new DOMParser;try{mei=e.parseFromString(oe,"text/xml"),mei.getElementsByTagName("parsererror").length>0&&console.log("This is not a valid XML or MEI file. However it could be ABC or Humdrum, for instance")}catch{E("#score-file-picker").val("")}if(se=new verovio.toolkit,mei.documentElement.namespaceURI!="http://www.music-encoding.org/ns/mei"){try{let c=se.renderData(oe,{pageWidth:2e4,pageHeight:1e4,breaks:"none"})}catch{if(!new_svg)return console.log("Verovio could not generate SVG from non-MEI file."),E("#score-file-picker").val(""),!1}oe=se.getMEI(),e=new DOMParser;try{mei=e.parseFromString(oe,"text/xml")}catch{return alert("Cannot parse this XML file as valid MEI."),E("#score-file-picker").val(""),!1}}else Xi(mei),on(mei.children[0]),Ji(mei);try{I=po()}catch{return alert("Cannot parse this XML file as valid MEI."),E("#score-file-picker").val(""),!1}w=[],Re=[],document.getElementById("layers").innerHTML="",w.hullPadding=200;var n=Array.from(mei.getElementsByTagName("body")[0].getElementsByTagName("mdiv"));for(let c in n){let l=n[c],d=l.children[0],m=Nt(mei,l),[u,g]=ei(m);if(!g)return console.log("Verovio could not generate SVG from MEI."),!1;var i=an(),[r,s]=ln(i);s.innerHTML=g;var o={mei:m,layer_elem:i,layer_number:0,mdiv_elem:l,score_elem:d,id_mapping:ze(l),number_of_views:1};const h=c==0;Re.push(o);var a={mei_mdiv:l,mei_score:d,svg_elem:s,view_elem:r,layer:o,layer_number:0,id_prefix:"",zoom:1,reductions:[],forceSaveLayer:h,lockLayer:h,canSave:!0,canEdit:!h};h?(Qt=se.renderToMIDI(),Wn=Qt):a.id_prefix=w.length,Kn(a)}return Ee=[],At=[],Zn=0,Te.ui.scoreSettings.toggleShades(!0),document.onkeypress=function(c){Or(c)},document.onkeydown=jr,document.onkeyup=kr,document.getElementById("layers").onclick=zr,document.dispatchEvent(new Event("scoreload")),Vr(),!0}function Jn(t=!1,e=w[0]){e.svg_elem;var n=Nt(mei,e.layer.mdiv_elem);return Array.from(n.getElementsByTagName("note")).forEach(i=>{let r=document.getElementById(B(e,_(i)));if(!r||r.classList.contains("hidden")){var s=i.parentNode;if(t&&!["chord","bTrem","fTrem"].includes(s.tagName)){var o=Ki(n,i);s.insertBefore(o,i)}s.removeChild(i)}}),Array.from(n.getElementsByTagName("chord")).forEach(i=>{i.parentNode,i.getElementsByTagName("note").length==0&&i.parentNode.removeChild(i)}),n}function _o(t,e=!1,n=!1){var i;e?i=fo(t,n):i=ho(t);let r=i.children[0],s=Nt(mei,i);var[o,a]=ei(s);if(!a)return console.log("Verovio could not generate SVG from MEI."),!1;var c=an(),[l,d]=ln(c);d.innerHTML=a;var m={mei:s,layer_elem:c,layer_number:Re.length,mdiv_elem:i,score_elem:r,id_mapping:ze(i),number_of_views:1};Re.push(m);var u={mei_score:r,mei_mdiv:i,svg_elem:d,view_elem:l,layer:m,layer_number:m.layer_number,id_prefix:"",zoom:1,reductions:[],forceSaveLayer:!1,lockLayer:!1,canSave:!0,canEdit:!0};u.id_prefix=w.length,Kn(u)}function Kn(t){t.measure_map=hr(t),w.reverse(),w.push(t),w.reverse();for(let e of t.svg_elem.getElementsByClassName("note"))e.onclick=()=>b(e);console.groupCollapsed("notes output from `pitch_grid()`");for(let e of t.svg_elem.getElementsByClassName("staff")){let[n,i]=vr(e);e.y_to_p=n,e.p_to_y=i}console.groupEnd(),Xn(t),xn()}function ei(t){var e=new XMLSerializer().serializeToString(rr(t)),n=se.renderData(e,{pageWidth:2e4,pageHeight:1e4,breaks:"none"});return[e,n]}function Eo(){[["add_bookmark","addbookmarkbutton"],["jump_to_next_bookmark","previousbookmarkbutton"],["jump_to_previous_bookmark","nextbookmarkbutton"],["jump_to_context_below","previouscontextbutton"],["jump_to_context_above","nextcontextbutton"]].forEach(e=>document.getElementById(e[1]).setAttribute("title",di[e[0]]||ie[e[0]]||z[e[0]]))}console.log("Main webapp library is loaded");const Y=()=>w,O=()=>I,Mo=()=>Wn,qe=()=>se,No=()=>oe,Ze=()=>Ee,Tt=()=>At,Ao=t=>At=t,xo=()=>Zn;
